<!DOCTYPE html>
<thead>
<tr>
<th style="width:18%">基本資訊</th>
<th style="width:22%">料件資訊</th>
<th style="width:44%">量測明細</th>
<th style="width:16%">結果</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
<p id="msg" class="muted"></p>
</div>


<script>
const tbody = document.getElementById('tbody');
const filterText = document.getElementById('filterText');
const msg = document.getElementById('msg');


document.getElementById('btnPrint').addEventListener('click', () => window.print());
document.getElementById('btnReload').addEventListener('click', load);
document.getElementById('btnClear').addEventListener('click', () => { filterText.value = ''; render(); });


filterText.addEventListener('input', render);


let records = [];


// 把任何格式標準化成陣列
function normalizeRecords(data) {
if (Array.isArray(data)) return data;
if (data && Array.isArray(data.record)) return data.record;
if (data && Array.isArray(data.records)) return data.records;
if (data && typeof data === 'object') return [data];
return [];
}


async function load() {
msg.textContent = '載入中...';
const code = await ensurePasscode();
try {
const res = await fetch('/api/inspections', { headers: { 'x-passcode': code } });
const text = await res.text();
if (!res.ok) throw new Error(`HTTP ${res.status}：${text || '（無訊息）'}`);


let data = {};
try { data = JSON.parse(text); } catch (e) { data = text; }


records = normalizeRecords(data);
if (!Array.isArray(records)) records = [];


// 依時間新到舊
records.sort((a,b) => (b.timestamp || '').localeCompare(a.timestamp || ''));


msg.textContent = `共 ${records.length} 筆`;
render();
} catch (e) {
msg.textContent = '❌ 載入失敗：' + e.message;
}
}


function render() {
const source = Array.isArray(records) ? records : [];
const kw = (filterText.value || '').toLowerCase();


const filtered = source.filter(r => {
const text = [ r.inspector, r.supplier, r.partNo, r.drawingNo, r.revision, r.notes ]
.filter(Boolean).join(' ').toLowerCase();
return text.includes(kw);
});


tbody.innerHTML = '';
for (const r of filtered) {
const tr = document.createElement('tr');
tr.innerHTML = `
<td>
<div><strong>ID：</strong>${escapeHtml(r.id || '')}</div>
<div><strong>時間：</strong>${escapeHtml(formatTime(r.timestamp))}</div>
<div><strong>人員：</strong>${escapeHtml(r.inspector || '')}</div>
<div><strong>供應商：</strong>${escapeHtml(r.supplier || '')}</div>
</td>
<td>
<div><strong>料號：</strong>${escapeHtml(r.partNo || '')}</div>
</html>