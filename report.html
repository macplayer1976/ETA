<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="reportTitle">å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1120px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn-outline { background: #f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-gray { background:#111827; color:#fff; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media print { .noprint { display: none; } body { padding: 0; } }
    pre { background:#f7f7f7; padding:12px; border-radius:8px; overflow:auto; }
    .mini { font-size: 13px; color:#333; margin-top:6px; }
    .mini table th, .mini table td { font-size: 12px; padding:6px; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:12px; padding:16px; width: min(92vw, 420px); box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal h3 { margin:0 0 8px 0; }
    .modal .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="reportTitle">å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰</h2>
    <div class="noprint row">
      <input id="filterText" style="flex:1" />
      <button class="btn" id="btnReload" data-i18n="btnReload">é‡æ–°è¼‰å…¥</button>
      <button class="btn btn-outline" id="btnClear" data-i18n="btnClear">æ¸…é™¤é—œéµå­—</button>
      <button class="btn btn-outline" id="btnReset" data-i18n="btnReset">é‡è¨­å¸³è™Ÿ</button>
      <button class="btn btn-outline" id="btnDiag" data-i18n="btnDiag">è¨ºæ–·è³‡æ–™</button>
      <button class="btn btn-outline" id="btnRepair" style="display:none" data-i18n="btnRepair">ä¸€éµä¿®å¾©</button>
      <button class="btn" id="btnPrint" data-i18n="btnPrint">åˆ—å° / å­˜æˆ PDF</button>
      <a class="btn" href="index.html" id="btnBack" data-i18n="btnBackToInput">å›ç¾å ´è¼¸å…¥</a>
      <button class="btn btn-outline" id="btnLang">ğŸŒ èªè¨€</button>
    </div>
    <p class="muted noprint" id="tipDebug"></p>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:20%" data-i18n="thBasic">åŸºæœ¬è³‡è¨Š</th>
          <th style="width:22%" data-i18n="thPart">æ–™ä»¶è³‡è¨Š</th>
          <th style="width:42%" data-i18n="thUnified">å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°</th>
          <th style="width:16%" data-i18n="thResultOps">çµæœ / æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="muted"></p>
    <pre id="raw" class="noprint" style="display:none"></pre>
  </div>

  <!-- èªè¨€é¸æ“‡å½ˆçª— -->
  <div class="modal-backdrop" id="langModal">
    <div class="modal">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€ / Language</h3>
      <p class="muted" data-i18n="langHint">è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š</p>
      <div class="grid">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== I18Nï¼ˆä¿®æ­£è‹±æ–‡å…¬å¸åã€åŠ å…¥è£½ç¨‹å­—ä¸²ï¼‰ ===== */
    const I18N = {
      'zh-TW': {
        reportTitle:'å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰',
        filterPh:'é—œéµå­—ï¼ˆä¾›æ‡‰å•†/æ–™è™Ÿ/åœ–è™Ÿ/æª¢é©—äººå“¡/è£½ç¨‹ï¼‰',
        btnReload:'é‡æ–°è¼‰å…¥', btnClear:'æ¸…é™¤é—œéµå­—', btnReset:'é‡è¨­å¸³è™Ÿ', btnDiag:'è¨ºæ–·è³‡æ–™', btnRepair:'ä¸€éµä¿®å¾©',
        btnPrint:'åˆ—å° / å­˜æˆ PDF', btnBackToInput:'å›ç¾å ´è¼¸å…¥', langTitle:'é¸æ“‡èªè¨€ / Language', langHint:'è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š',
        debugTip:'æç¤ºï¼šç¶²å€åŠ ä¸Š ?debug=1 å¯é¡¯ç¤ºä¼ºæœå™¨åŸå§‹å›æ‡‰ï¼›ç¶²å€åŠ  #resetpass å¯æ¸…é™¤é€šé—œç¢¼ã€‚',
        thBasic:'åŸºæœ¬è³‡è¨Š', thPart:'æ–™ä»¶è³‡è¨Š', thUnified:'å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°', thResultOps:'çµæœ / æ“ä½œ',
        labelID:'IDï¼š', labelTime:'æ™‚é–“ï¼š', labelInspector:'äººå“¡ï¼š', labelSupplier:'ä¾›æ‡‰å•†ï¼š',
        labelPartNo:'æ–™è™Ÿï¼š', labelDrawingNo:'åœ–è™Ÿï¼š', labelRevision:'ç‰ˆæ¬¡ï¼š', labelNotes:'å‚™è¨»ï¼š',
        labelProcess:'è£½ç¨‹ï¼š', /* âœ… æ–°å¢ */
        labelOverall:'æ•´é«”çµæœï¼š', btnPrintOne:'å–®ç­†åˆ—å°', btnDelete:'åˆªé™¤æ­¤ç­†',
        msgNoPerm:'æ‚¨çš„å¸³è™Ÿæ²’æœ‰æª¢è¦–å ±å‘Šçš„æ¬Šé™ï¼ˆinputï¼‰ã€‚', msgVerify:'é©—è­‰ä¸­...', msgLoading:'è¼‰å…¥ä¸­...',
        msgLoadFail:'âŒ è¼‰å…¥å¤±æ•—ï¼š', msgEmpty:'ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„è³‡æ–™ã€‚', msgCount:'å…± {n} ç­†ã€‚å¯ç”¨é—œéµå­—å¿«é€Ÿéæ¿¾ã€‚',
        msgDeleting:'åˆªé™¤ä¸­...', msgDeleted:'âœ… å·²åˆªé™¤ 1 ç­†ã€‚', msgDeleteFail:'âŒ åˆªé™¤å¤±æ•—ï¼š', msgReLogin:'âŒ ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥å†è©¦ã€‚',
        theadItem:'é …ç›® / å°ºå¯¸', theadNom:'åç›®', theadLo:'ä¸‹é™å…¬å·®', theadHi:'ä¸Šé™å…¬å·®',
        theadM1:'æ¨£å“/å¯¦æ¸¬1', theadM2:'æ¨£å“/å¯¦æ¸¬2', theadM3:'æ¨£å“/å¯¦æ¸¬3', theadM4:'æ¨£å“/å¯¦æ¸¬4', theadM5:'æ¨£å“/å¯¦æ¸¬5', theadDecision:'åˆ¤å®š',
        appearance:'å¤–è§€'
      },
      'zh-CN': {
        reportTitle:'å“æ£€æŠ¥å‘Šï¼ˆå®‰æ‹“ï¼‰',
        filterPh:'å…³é”®å­—ï¼ˆä¾›åº”å•†/æ–™å·/å›¾å·/æ£€éªŒäººå‘˜/åˆ¶ç¨‹ï¼‰',
        btnReload:'é‡æ–°è½½å…¥', btnClear:'æ¸…é™¤å…³é”®å­—', btnReset:'é‡è®¾å¸å·', btnDiag:'è¯Šæ–­èµ„æ–™', btnRepair:'ä¸€é”®ä¿®å¤',
        btnPrint:'æ‰“å° / å­˜æˆ PDF', btnBackToInput:'å›ç°åœºè¾“å…¥', langTitle:'é€‰æ‹©è¯­è¨€ / Language', langHint:'è¯·é€‰æ‹©ç•Œé¢è¯­è¨€ï¼š',
        debugTip:'æç¤ºï¼šç½‘å€åŠ ä¸Š ?debug=1 å¯æ˜¾ç¤ºæœåŠ¡å™¨åŸå§‹å›åº”ï¼›ç½‘å€åŠ  #resetpass å¯æ¸…é™¤é€šå…³ç ã€‚',
        thBasic:'åŸºæœ¬èµ„è®¯', thPart:'æ–™ä»¶èµ„è®¯', thUnified:'å¤–è§‚ä¸é‡æµ‹æ˜ç»†', thResultOps:'ç»“æœ / æ“ä½œ',
        labelID:'IDï¼š', labelTime:'æ—¶é—´ï¼š', labelInspector:'äººå‘˜ï¼š', labelSupplier:'ä¾›åº”å•†ï¼š',
        labelPartNo:'æ–™å·ï¼š', labelDrawingNo:'å›¾å·ï¼š', labelRevision:'ç‰ˆæ¬¡ï¼š', labelNotes:'å¤‡æ³¨ï¼š',
        labelProcess:'åˆ¶ç¨‹ï¼š',
        labelOverall:'æ•´ä½“ç»“æœï¼š', btnPrintOne:'å•ç¬”æ‰“å°', btnDelete:'åˆ é™¤æ­¤ç¬”',
        msgNoPerm:'æ‚¨çš„è´¦å·æ²¡æœ‰æ£€è§†æŠ¥å‘Šçš„æƒé™ï¼ˆinputï¼‰ã€‚', msgVerify:'éªŒè¯ä¸­...', msgLoading:'è½½å…¥ä¸­...',
        msgLoadFail:'âŒ è½½å…¥å¤±è´¥ï¼š', msgEmpty:'ç›®å‰æ²¡æœ‰å¯æ˜¾ç¤ºçš„èµ„æ–™ã€‚', msgCount:'å…± {n} ç¬”ã€‚å¯ç”¨å…³é”®å­—å¿«é€Ÿè¿‡æ»¤ã€‚',
        msgDeleting:'åˆ é™¤ä¸­...', msgDeleted:'âœ… å·²åˆ é™¤ 1 ç¬”ã€‚', msgDeleteFail:'âŒ åˆ é™¤å¤±è´¥ï¼š', msgReLogin:'âŒ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•å†è¯•ã€‚',
        theadItem:'é¡¹ç›® / å°ºå¯¸', theadNom:'åä¹‰', theadLo:'ä¸‹é™å…¬å·®', theadHi:'ä¸Šé™å…¬å·®',
        theadM1:'æ ·å“/å®æµ‹1', theadM2:'æ ·å“/å®æµ‹2', theadM3:'æ ·å“/å®æµ‹3', theadM4:'æ ·å“/å®æµ‹4', theadM5:'æ ·å“/å®æµ‹5', theadDecision:'åˆ¤å®š',
        appearance:'å¤–è§‚'
      },
      'en': {
        reportTitle:'QC Reports â€” ANCHOR FASTENERS INDUSTRIAL CO., LTD.',
        filterPh:'Keyword (supplier/part/drawing/inspector/process)',
        btnReload:'Reload', btnClear:'Clear', btnReset:'Reset account', btnDiag:'Diagnose', btnRepair:'Repair',
        btnPrint:'Print / Save as PDF', btnBackToInput:'Back to Input', langTitle:'Choose language', langHint:'Select UI language:',
        debugTip:'Tip: add ?debug=1 to show raw response; add #resetpass to clear pass.',
        thBasic:'Basic Info', thPart:'Part Info', thUnified:'Appearance & Measurements', thResultOps:'Result / Actions',
        labelID:'ID: ', labelTime:'Time: ', labelInspector:'Inspector: ', labelSupplier:'Supplier: ',
        labelPartNo:'Part No.: ', labelDrawingNo:'Drawing No.: ', labelRevision:'Revision: ', labelNotes:'Notes: ',
        labelProcess:'Process: ',
        labelOverall:'Overall: ', btnPrintOne:'Print single', btnDelete:'Delete',
        msgNoPerm:'Your account has no view permission (input).', msgVerify:'Verifying...', msgLoading:'Loading...',
        msgLoadFail:'âŒ Load failed: ', msgEmpty:'No data to display.', msgCount:'Total {n}. Use keyword to filter.',
        msgDeleting:'Deleting...', msgDeleted:'âœ… Deleted.', msgDeleteFail:'âŒ Delete failed: ', msgReLogin:'âŒ Session expired. Please sign in again.',
        theadItem:'Item / Dimension', theadNom:'Nominal', theadLo:'Lower Tol.', theadHi:'Upper Tol.',
        theadM1:'Sample1', theadM2:'Sample2', theadM3:'Sample3', theadM4:'Sample4', theadM5:'Sample5', theadDecision:'Decision',
        appearance:'Appearance'
      }
    };

    function getLang(){ return localStorage.getItem('qci_lang') || ''; }
    function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
    function selectLang(lang){ setLang(lang); closeLangModal(); render(); }
    function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
    function closeLangModal(){ document.getElementById('langModal').style.display='none'; }
    function t(key){ const lang=getLang()||'zh-TW'; const d=I18N[lang]||I18N['zh-TW']; return d[key]??(I18N['zh-TW'][key]??key); }

    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); el.innerHTML = t(k); });
      const filter = document.getElementById('filterText'); if (filter) filter.placeholder = t('filterPh');
      const titleEl = document.querySelector('title[data-i18n="reportTitle"]'); if (titleEl) titleEl.textContent = t('reportTitle');
      document.getElementById('tipDebug').textContent = t('debugTip');
    }

    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
    const tbody = document.getElementById('tbody');
    const filterText = document.getElementById('filterText');
    const msg = document.getElementById('msg');
    const raw = document.getElementById('raw');
    const btnRepair = document.getElementById('btnRepair');
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { filterText.value = ''; render(); });
    document.getElementById('btnReset').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      alert('Cleared. / å·²æ¸…é™¤ã€‚');
    });
    document.getElementById('btnDiag').addEventListener('click', diag);
    document.getElementById('btnRepair').addEventListener('click', repair);
    document.getElementById('btnLang').addEventListener('click', ()=> openLangModal());
    filterText.addEventListener('input', render);

    if (location.hash === '#resetpass') {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      history.replaceState(null, '', location.pathname + location.search);
    }

    let role = '';
    let currentUser = '';
    let canDelete = false;
    let records = [];

    tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-delete');
      if (btn) { onDelete(btn.getAttribute('data-id')); return; }
    });

    async function ensureAuth() {
      const user = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      const pass = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (!user || !pass) {
        const u = prompt('Account / å¸³è™Ÿ') || '';
        const p = prompt('Password / å¯†ç¢¼') || '';
        if (!u || !p) return { ok: false };
        localStorage.setItem('qci_user', u);
        localStorage.setItem('qci_pass', p);
        localStorage.setItem('qci_inspector', u);
        localStorage.setItem('qci_passcode', p);
      }
      const u2 = localStorage.getItem('qci_user') || '';
      const p2 = localStorage.getItem('qci_pass') || '';
      try {
        const res = await fetch('/api/inspections?auth=1', { headers: { 'x-user': u2, 'x-pass': p2, 'x-passcode': p2 } });
        const t = await res.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        if (!res.ok || !j.ok) return { ok:false };
        role = (j.role || '').toLowerCase();
        currentUser = (j.user || '');
        canDelete = (role === 'admin' && String(currentUser).toLowerCase() === 'boss');
        btnRepair.style.display = role === 'admin' ? '' : 'none';
        return { ok:true };
      } catch { return { ok:false }; }
    }

    async function load() {
      applyI18n();
      msg.textContent = t('msgVerify');
      const ok = await ensureAuth();
      if (!ok.ok) { msg.textContent = 'âŒ Unauthorized'; return; }
      if (!['admin','viewer'].includes(role)) { msg.textContent = t('msgNoPerm'); return; }

      msg.textContent = t('msgLoading');
      raw.style.display = 'none'; raw.textContent = '';
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      try {
        const res = await fetch('/api/inspections', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass } });
        const text = await res.text();
        if (DEBUG) { raw.style.display = 'block'; raw.textContent = 'RAW:\n' + (text || '').slice(0, 1000); }
        if (!res.ok) throw new Error(`HTTP ${res.status}ï¼š${text || ''}`);

        let data = {}; try { data = JSON.parse(text); } catch { data = text; }
        let list = listFromJson(data).filter(isValidRecord);
        list.sort((a,b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
        records = list;
        render();
        msg.textContent = records.length ? t('msgCount').replace('{n}', records.length) : t('msgEmpty');
        if (!getLang()) openLangModal();
      } catch (e) { msg.textContent = t('msgLoadFail') + e.message; }
    }

    function render() {
      applyI18n();
      const kw = (filterText.value || '').toLowerCase();
      const filtered = records.filter(r => {
        const text = [ r.inspector, r.supplier, r.partNo, r.drawingNo, r.revision, r.notes, r.process ]
          .filter(Boolean).join(' ').toLowerCase();
        return text.includes(kw);
      });

      tbody.innerHTML = '';
      for (const r of filtered) {
        const basic = `
          <div>${t('labelID')} ${escapeHtml(r.id||'')}</div>
          <div>${t('labelTime')} ${escapeHtml((r.timestamp||'').replace('T',' ').replace('Z',''))}</div>
          <div>${t('labelInspector')} ${escapeHtml(r.inspector||'')}</div>
          <div>${t('labelOverall')} <strong>${escapeHtml(r.overallResult||'')}</strong></div>
        `;
        const part = `
          <div>${t('labelSupplier')} ${escapeHtml(r.supplier||'')} ${r.supplierEn ? '('+escapeHtml(r.supplierEn)+')' : ''}</div>
          <div>${t('labelPartNo')} ${escapeHtml(r.partNo||'')}</div>
          <div>${t('labelDrawingNo')} ${escapeHtml(r.drawingNo||'')}</div>
          <div>${t('labelRevision')} ${escapeHtml(r.revision||'')}</div>
          <div>${t('labelProcess')} ${escapeHtml(r.process||'')} ${r.processEn ? '('+escapeHtml(r.processEn)+')' : ''}</div>
          <div>${t('labelNotes')} ${escapeHtml(r.notes||'')}</div>
        `;
        const unified = buildUnified(r.appearance||[], r.measurements||[]);
        const ops = `
          <div style="display:flex; gap:6px; flex-wrap:wrap">
            <a class="btn btn-gray" href="print.html?id=${encodeURIComponent(r.id)}" target="_blank">${t('btnPrintOne')}</a>
            ${canDelete ? `<button class="btn btn-danger btn-delete" data-id="${escapeHtml(r.id)}">${t('btnDelete')}</button>` : ''}
          </div>
        `;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${basic}</td>
          <td>${part}</td>
          <td>${unified}</td>
          <td>${ops}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function listFromJson(x) {
      if (!x) return [];
      if (Array.isArray(x)) return x.flatMap(listFromJson).filter(Boolean);
      if (x && typeof x === 'object') {
        if (x.record !== undefined) return listFromJson(x.record);
        if (x.records !== undefined) return listFromJson(x.records);
        if (x.id && x.timestamp && Array.isArray(x.measurements)) return [x];
      }
      return [];
    }
    function isValidRecord(r){ return r && (r.id || r.timestamp || r.inspector || r.supplier || r.partNo); }

    function buildUnified(app, list){
      const thead = `
        <table class="mini"><thead>
          <tr>
            <th>${t('theadItem')}</th>
            <th>${t('theadNom')}</th>
            <th>${t('theadLo')}</th>
            <th>${t('theadHi')}</th>
            <th>${t('theadM1')}</th>
            <th>${t('theadM2')}</th>
            <th>${t('theadM3')}</th>
            <th>${t('theadM4')}</th>
            <th>${t('theadM5')}</th>
            <th>${t('theadDecision')}</th>
          </tr>
        </thead><tbody>`;

      // å¤–è§€åˆ—ï¼ˆæœ‰å¡«æ‰é¡¯ç¤ºï¼‰
      const apMap = {};
      if (Array.isArray(app)) {
        for (const a of app) {
          const m = String(a.sample || '').match(/(\d+)/);
          const idx = m ? Number(m[1]) : null;
          if (idx && idx >= 1 && idx <= 5) apMap[idx] = String(a.result || '').toUpperCase() === 'OK' ? (getLang()==='en'?'OK':'O.K') : 'NG';
        }
      }
      const hasAp = Object.keys(apMap).length > 0;
      const apRow = hasAp ? `
        <tr>
          <td><strong>${t('appearance')}</strong></td>
          <td></td><td></td><td></td>
          <td>${escapeHtml(apMap[1]||'')}</td>
          <td>${escapeHtml(apMap[2]||'')}</td>
          <td>${escapeHtml(apMap[3]||'')}</td>
          <td>${escapeHtml(apMap[4]||'')}</td>
          <td>${escapeHtml(apMap[5]||'')}</td>
          <td>${Object.values(apMap).every(v=>v==='OK'||v==='O.K') ? 'PASS' : 'FAIL'}</td>
        </tr>` : '';

      const rows = (Array.isArray(list)?list:[]).map(m=>{
        const arr = Array.isArray(m.measured) ? m.measured :
          ((typeof m.measured==='number'||(typeof m.measured==='string'&&m.measured!=='')) ? [m.measured] : []);
        const cs = [0,1,2,3,4].map(i => (arr[i]===0||arr[i]) ? Number(arr[i]).toFixed(3):'');
        const dec = (typeof m.pass==='boolean') ? (m.pass?'PASS':'FAIL') : (m.decision||'');
        return `<tr>
          <td>${escapeHtml(m.name||'')}</td>
          <td>${m.nominal===0||m.nominal?Number(m.nominal).toFixed(3):''}</td>
          <td>${m.tolMinus===0||m.tolMinus?Number(m.tolMinus).toFixed(3):''}</td>
          <td>${m.tolPlus===0||m.tolPlus?Number(m.tolPlus).toFixed(3):''}</td>
          <td>${cs[0]}</td><td>${cs[1]}</td><td>${cs[2]}</td><td>${cs[3]}</td><td>${cs[4]}</td>
          <td>${escapeHtml(dec)}</td>
        </tr>`;
      }).join('');

      const tbody = (hasAp||rows) ? `${apRow}${rows}` : `<tr><td colspan="10" class="muted">ï¼ˆç„¡æ˜ç´°ï¼‰</td></tr>`;
      return `${thead}${tbody}</tbody></table>`;
    }

    // delete / diag / repair èˆ‡ä½ èˆŠç‰ˆç›¸åŒï¼ˆç•¥ï¼‰
    async function onDelete(id){ /* ä¿ç•™ä½ èˆŠç‰ˆåˆªé™¤æµç¨‹ */ }
    async function diag(){ /* ä¿ç•™ */ }
    async function repair(){ /* ä¿ç•™ */ }

    load();
  </script>
</body>
</html>
