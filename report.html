<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品檢報告（安拓）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1120px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn-outline { background: #f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-gray { background:#111827; color:#fff; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media print { .noprint { display: none; } body { padding: 0; } }
    pre { background:#f7f7f7; padding:12px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>品檢報告（安拓）</h2>
    <div class="noprint row">
      <input id="filterText" placeholder="關鍵字（供應商/料號/圖號/檢驗人員）" style="flex:1" />
      <button class="btn" id="btnReload">重新載入</button>
      <button class="btn btn-outline" id="btnClear">清除關鍵字</button>
      <button class="btn btn-outline" id="btnReset">重設帳號</button>
      <button class="btn btn-outline" id="btnDiag">診斷資料</button>
      <button class="btn btn-outline" id="btnRepair" style="display:none">一鍵修復</button>
      <button class="btn" id="btnPrint">列印 / 存成 PDF</button>
      <a class="btn" href="index.html">回現場輸入</a>
    </div>
    <p class="muted noprint">提示：網址加上 <code>?debug=1</code> 可顯示伺服器原始回應；網址加 <code>#resetpass</code> 可清除通關碼。</p>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:18%">基本資訊</th>
          <th style="width:22%">料件資訊</th>
          <th style="width:48%">量測明細</th>
          <th style="width:12%">結果</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="muted"></p>
    <pre id="raw" class="noprint" style="display:none"></pre>
  </div>

  <script>
    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
    const tbody = document.getElementById('tbody');
    const filterText = document.getElementById('filterText');
    const msg = document.getElementById('msg');
    const raw = document.getElementById('raw');
    const btnRepair = document.getElementById('btnRepair');

    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { filterText.value = ''; render(); });
    document.getElementById('btnReset').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      alert('本機登入資訊已清除。請重新整理頁面登入。');
    });
    document.getElementById('btnDiag').addEventListener('click', diag);
    document.getElementById('btnRepair').addEventListener('click', repair);
    filterText.addEventListener('input', render);

    if (location.hash === '#resetpass') {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      history.replaceState(null, '', location.pathname + location.search);
    }

    let role = '';          // 目前角色
    let currentUser = '';   // 目前帳號
    let canDelete = false;  // boss+admin 才能刪
    let records = [];

    // 事件委派：刪除按鈕
    tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-delete');
      if (btn) {
        const id = btn.getAttribute('data-id');
        onDelete(id);
        return;
      }
    });

    async function ensureAuth() {
      const user = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      const pass = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (!user || !pass) {
        const u = prompt('請輸入帳號（檢驗人員）') || '';
        const p = prompt('請輸入密碼（通關碼/密碼）') || '';
        if (!u || !p) return { ok: false };
        localStorage.setItem('qci_user', u);
        localStorage.setItem('qci_pass', p);
        localStorage.setItem('qci_inspector', u);
        localStorage.setItem('qci_passcode', p);
      }
      const u2 = localStorage.getItem('qci_user') || '';
      const p2 = localStorage.getItem('qci_pass') || '';
      try {
        const res = await fetch('/api/inspections?auth=1', {
          headers: { 'x-user': u2, 'x-pass': p2, 'x-passcode': p2 }
        });
        const t = await res.text();
        let j = {}; try { j = JSON.parse(t); } catch {}
        if (!res.ok || !j.ok) return { ok:false };
        role = (j.role || '').toLowerCase();
        currentUser = (j.user || '');
        canDelete = (role === 'admin' && String(currentUser).toLowerCase() === 'boss');
        // admin 才顯示修復
        btnRepair.style.display = role === 'admin' ? '' : 'none';
        return { ok:true };
      } catch { return { ok:false }; }
    }

    async function load() {
      msg.textContent = '驗證中...';
      const ok = await ensureAuth();
      if (!ok.ok) { msg.textContent = '❌ 請重新登入（帳號/密碼）'; return; }
      if (!['admin','viewer'].includes(role)) {
        msg.textContent = '您的帳號沒有檢視報告的權限（input）。';
        return;
      }

      msg.textContent = '載入中...';
      raw.style.display = 'none'; raw.textContent = '';
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      try {
        const res = await fetch('/api/inspections', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass } });
        const text = await res.text();

        if (DEBUG) { raw.style.display = 'block'; raw.textContent = '原始回應（前 1000 字）：\n' + (text || '').slice(0, 1000); }
        if (!res.ok) throw new Error(`HTTP ${res.status}：${text || '（無訊息）'}`);

        let data = {}; try { data = JSON.parse(text); } catch { data = text; }
        let list = listFromJson(data).filter(isValidRecord);
        list.sort((a,b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
        records = list;
        render();
        msg.textContent = records.length ? `共 ${records.length} 筆。可用關鍵字快速過濾。` : '目前沒有可顯示的資料。';
      } catch (e) {
        msg.textContent = '❌ 載入失敗：' + e.message;
      }
    }

    function render() {
      const kw = (filterText.value || '').toLowerCase();
      const filtered = records.filter(r => {
        const text = [ r.inspector, r.supplier, r.partNo, r.drawingNo, r.revision, r.notes ]
          .filter(Boolean).join(' ').toLowerCase();
        return text.includes(kw);
      });

      tbody.innerHTML = '';
      for (const r of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div><strong>ID：</strong>${escapeHtml(r.id || '')}</div>
            <div><strong>時間：</strong>${escapeHtml(formatTime(r.timestamp))}</div>
            <div><strong>人員：</strong>${escapeHtml(r.inspector || '')}</div>
            <div><strong>供應商：</strong>${escapeHtml(r.supplier || '')}</div>
          </td>
          <td>
            <div><strong>料號：</strong>${escapeHtml(r.partNo || '')}</div>
            <div><strong>圖號：</strong>${escapeHtml(r.drawingNo || '')}</div>
            <div><strong>版次：</strong>${escapeHtml(r.revision || '')}</div>
            <div><strong>備註：</strong>${escapeHtml(r.notes || '')}</div>
          </td>
          <td>${buildMeasurements(r.measurements || [])}</td>
          <td>
            <div><strong>${r.overallResult === 'PASS' ? '✅ PASS' : '❌ FAIL'}</strong></div>
            <div class="noprint" style="margin-top:6px; display:flex; flex-direction:column; gap:6px">
              <a class="btn btn-gray" target="_blank" href="print.html?id=${encodeURIComponent(r.id)}">單筆列印</a>
              ${canDelete ? `<button class="btn btn-danger btn-delete" data-id="${escapeAttr(r.id)}">刪除此筆</button>` : ``}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function onDelete(id) {
      if (!id) return;
      if (!canDelete) { alert('只有 boss（admin）可以刪除'); return; }
      const ok = confirm(`確定要刪除這筆資料嗎？\nID：${id}\n（刪除後無法復原）`);
      if (!ok) return;

      msg.textContent = '刪除中...';
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      try {
        const res = await fetch('/api/inspections?id=' + encodeURIComponent(id), {
          method: 'DELETE',
          headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }
        });
        const text = await res.text();
        if (!res.ok) {
          if (res.status === 401) {
            ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
            msg.textContent = '❌ 登入已過期，請重新登入再試。';
            return;
          }
          throw new Error(`HTTP ${res.status}：${text || '（無訊息）'}`);
        }
        records = records.filter(r => r.id !== id);
        render();
        msg.textContent = '✅ 已刪除 1 筆。';
      } catch (e) {
        msg.textContent = '❌ 刪除失敗：' + e.message;
      }
    }

    /* --------- 工具群（相容舊/新資料） ---------- */
    function listFromJson(x) {
      if (!x) return [];
      if (Array.isArray(x)) return x.flatMap(listFromJson).filter(Boolean);
      if (looksLikeRecord(x)) return [x];
      if (x && typeof x === 'object') {
        if (x.record !== undefined) return listFromJson(x.record);
        if (x.records !== undefined) return listFromJson(x.records);
      }
      return [];
    }
    function looksLikeRecord(o) {
      return o && typeof o === 'object'
        && typeof o.id === 'string'
        && typeof o.timestamp === 'string'
        && Array.isArray(o.measurements);
    }
    function isValidReco
