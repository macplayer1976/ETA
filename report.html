<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="reportTitle">ÂìÅÊ™¢Â†±ÂëäÔºàÂÆâÂèØÔºâ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1120px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 8px; flex:1 }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn-outline { background: #f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-gray { background:#111827; color:#fff; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media print { .noprint { display: none; } body { padding: 0; } }
    .mini th, .mini td { font-size: 12px; padding:6px; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:12px; padding:16px; width: min(92vw, 420px); box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal h3 { margin:0 0 8px 0; }
    .modal .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="reportTitle">ÂìÅÊ™¢Â†±ÂëäÔºàÂÆâÂèØÔºâ</h2>
    <p class="muted" style="margin:6px 0 12px 0">‰ΩôÂßöÂ∏ÇÂÆâÂèØÁ¥ßÂõ∫‰ª∂ÊúâÈôêÂÖ¨Âè∏ÔΩú<strong>YUYAO AKF FASTENERS CO.,LTD</strong></p>
    <div class="noprint row">
      <input id="filterText" placeholder="ÈóúÈçµÂ≠óÔºà‰æõÊáâÂïÜ/ÊñôËôü/ÂúñËôü/Ê™¢È©ó‰∫∫Âì°Ôºâ" />
      <button class="btn" id="btnReload" data-i18n="btnReload">ÈáçÊñ∞ËºâÂÖ•</button>
      <button class="btn btn-outline" id="btnClear" data-i18n="btnClear">Ê∏ÖÈô§ÈóúÈçµÂ≠ó</button>
      <button class="btn btn-outline" id="btnReset" data-i18n="btnReset">ÈáçË®≠Â∏≥Ëôü</button>
      <button class="btn btn-outline" id="btnDiag" data-i18n="btnDiag">Ë®∫Êñ∑Ë≥áÊñô</button>
      <button class="btn btn-outline" id="btnRepair" style="display:none" data-i18n="btnRepair">‰∏ÄÈçµ‰øÆÂæ©</button>
      <button class="btn" id="btnPrint" data-i18n="btnPrint">ÂàóÂç∞ / Â≠òÊàê PDF</button>
<button class="btn" id="btnExport" data-i18n="btnExport">‰∏ãËºâ ExcelÔºàÈõ¢Á∑öÔºâ</button>
      <a class="btn" href="index.html" id="btnBack" data-i18n="btnBackToInput">ÂõûÁèæÂ†¥Ëº∏ÂÖ•</a>
      <button class="btn btn-outline" id="btnLang">üåê Ë™ûË®Ä</button>
    </div>
    <p class="muted noprint" id="tipDebug"></p>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:20%" data-i18n="thBasic">Âü∫Êú¨Ë≥áË®ä</th>
          <th style="width:22%" data-i18n="thPart">Êñô‰ª∂Ë≥áË®ä</th>
          <th style="width:42%" data-i18n="thUnified">Â§ñËßÄËàáÈáèÊ∏¨ÊòéÁ¥∞</th>
          <th style="width:16%" data-i18n="thResultOps">ÁµêÊûú / Êìç‰Ωú</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="muted"></p>
    <pre id="raw" class="noprint" style="display:none"></pre>
  </div>

  <!-- Ë™ûË®ÄÈÅ∏ÊìáÂΩàÁ™ó -->
  <div class="modal-backdrop" id="langModal">
    <div class="modal">
      <h3 data-i18n="langTitle">ÈÅ∏ÊìáË™ûË®Ä / Language</h3>
      <p class="muted" data-i18n="langHint">Ë´ãÈÅ∏Êìá‰ªãÈù¢Ë™ûË®ÄÔºö</p>
      <div class="grid">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ÁπÅÈ´î‰∏≠Êñá</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ÁÆÄ‰Ωì‰∏≠Êñá</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== I18N ===== */
    const I18N = {
      'zh-TW': {
        reportTitle:'ÂìÅÊ™¢Â†±ÂëäÔºàÂÆâÊãìÔºâ',
        filterPh:'ÈóúÈçµÂ≠óÔºà‰æõÊáâÂïÜ/ÊñôËôü/ÂúñËôü/Ê™¢È©ó‰∫∫Âì°Ôºâ',
        btnReload:'ÈáçÊñ∞ËºâÂÖ•', btnClear:'Ê∏ÖÈô§ÈóúÈçµÂ≠ó', btnReset:'ÈáçË®≠Â∏≥Ëôü', btnDiag:'Ë®∫Êñ∑Ë≥áÊñô', btnRepair:'‰∏ÄÈçµ‰øÆÂæ©',
        btnPrint:'ÂàóÂç∞ / Â≠òÊàê PDF', btnExport:'‰∏ãËºâ ExcelÔºàÈõ¢Á∑öÔºâ', btnBackToInput:'ÂõûÁèæÂ†¥Ëº∏ÂÖ•', langTitle:'ÈÅ∏ÊìáË™ûË®Ä / Language', langHint:'Ë´ãÈÅ∏Êìá‰ªãÈù¢Ë™ûË®ÄÔºö',
        debugTip:'ÊèêÁ§∫ÔºöÁ∂≤ÂùÄÂä†‰∏ä ?debug=1 ÂèØÈ°ØÁ§∫‰º∫ÊúçÂô®ÂéüÂßãÂõûÊáâÔºõÁ∂≤ÂùÄÂä† #resetpass ÂèØÊ∏ÖÈô§ÈÄöÈóúÁ¢º„ÄÇ',
        thBasic:'Âü∫Êú¨Ë≥áË®ä', thPart:'Êñô‰ª∂Ë≥áË®ä', thUnified:'Â§ñËßÄËàáÈáèÊ∏¨ÊòéÁ¥∞', thResultOps:'ÁµêÊûú / Êìç‰Ωú',
        labelID:'IDÔºö', labelTime:'ÊôÇÈñìÔºö', labelInspector:'‰∫∫Âì°Ôºö', labelSupplier:'‰æõÊáâÂïÜÔºö',
        labelOrderNo:'Ë®ÇÂñÆËôüÁ¢ºÔºö', labelLotNo:'ÁîüÁî¢ÊâπËôüÔºö', labelPartNo:'ÊñôËôüÔºö', labelDrawingNo:'ÂúñËôüÔºö', labelRevision:'ÁâàÊ¨°Ôºö', labelMaterial:'ÊùêË≥™Ôºö', labelSpec:'Ë¶èÊ†ºÔºö', labelCategory:'Áî¢ÂìÅÈ°ûÂà•Ôºö', labelProcess:'Ë£ΩÁ®ãÔºö', labelHeatNo:'ÁàêËôüÔºö', labelNotes:'ÂÇôË®ªÔºö',
        labelOverall:'Êï¥È´îÁµêÊûúÔºö', btnPrintOne:'ÂñÆÁ≠ÜÂàóÂç∞', btnDelete:'Âà™Èô§Ê≠§Á≠Ü',
        msgNoPerm:'ÊÇ®ÁöÑÂ∏≥ËôüÊ≤íÊúâÊ™¢Ë¶ñÂ†±ÂëäÁöÑÊ¨äÈôêÔºàinputÔºâ„ÄÇ', msgVerify:'È©óË≠â‰∏≠...', msgLoading:'ËºâÂÖ•‰∏≠...',
        msgLoadFail:'‚ùå ËºâÂÖ•Â§±ÊïóÔºö', msgEmpty:'ÁõÆÂâçÊ≤íÊúâÂèØÈ°ØÁ§∫ÁöÑË≥áÊñô„ÄÇ', msgCount:'ÂÖ± {n} Á≠Ü„ÄÇÂèØÁî®ÈóúÈçµÂ≠óÂø´ÈÄüÈÅéÊøæ„ÄÇ',
        msgDeleting:'Âà™Èô§‰∏≠...', msgDeleted:'‚úÖ Â∑≤Âà™Èô§ 1 Á≠Ü„ÄÇ', msgDeleteFail:'‚ùå Âà™Èô§Â§±ÊïóÔºö', msgReLogin:'‚ùå ÁôªÂÖ•Â∑≤ÈÅéÊúüÔºåË´ãÈáçÊñ∞ÁôªÂÖ•ÂÜçË©¶„ÄÇ',
        theadCode:'‰ª£Ëôü', theadItem:'È†ÖÁõÆ / Â∞∫ÂØ∏', theadNom:'Ê®ôÊ∫ñÂÄº', theadLo:'‰∏ãÈôêÂÖ¨Â∑Æ', theadHi:'‰∏äÈôêÂÖ¨Â∑Æ',
        theadM1:'Ê®£ÂìÅ/ÂØ¶Ê∏¨1', theadM2:'Ê®£ÂìÅ/ÂØ¶Ê∏¨2', theadM3:'Ê®£ÂìÅ/ÂØ¶Ê∏¨3', theadM4:'Ê®£ÂìÅ/ÂØ¶Ê∏¨4', theadM5:'Ê®£ÂìÅ/ÂØ¶Ê∏¨5', theadDecision:'Âà§ÂÆö',
        appearance:'Â§ñËßÄ'
      },
      'zh-CN': {
        reportTitle:'ÂìÅÊ£ÄÊä•ÂëäÔºàÂÆâÊãìÔºâ',
        filterPh:'ÂÖ≥ÈîÆÂ≠óÔºà‰æõÂ∫îÂïÜ/ÊñôÂè∑/ÂõæÂè∑/Ê£ÄÈ™å‰∫∫ÂëòÔºâ',
        btnReload:'ÈáçÊñ∞ËΩΩÂÖ•', btnClear:'Ê∏ÖÈô§ÂÖ≥ÈîÆÂ≠ó', btnReset:'ÈáçËÆæÂ∏êÂè∑', btnDiag:'ËØäÊñ≠ËµÑÊñô', btnRepair:'‰∏ÄÈîÆ‰øÆÂ§ç',
        btnPrint:'ÊâìÂç∞ / Â≠òÊàê PDF', btnExport:'Á¶ªÁ∫øÂØºÂá∫ Excel', btnBackToInput:'ÂõûÁé∞Âú∫ËæìÂÖ•', langTitle:'ÈÄâÊã©ËØ≠Ë®Ä / Language', langHint:'ËØ∑ÈÄâÊã©ÁïåÈù¢ËØ≠Ë®ÄÔºö',
        debugTip:'ÊèêÁ§∫ÔºöÁΩëÂùÄÂä†‰∏ä ?debug=1 ÂèØÊòæÁ§∫ÊúçÂä°Âô®ÂéüÂßãÂõûÂ∫îÔºõÁΩëÂùÄÂä† #resetpass ÂèØÊ∏ÖÈô§ÈÄöÂÖ≥Á†Å„ÄÇ',
        thBasic:'Âü∫Êú¨ËµÑËÆØ', thPart:'Êñô‰ª∂ËµÑËÆØ', thUnified:'Â§ñËßÇ‰∏éÈáèÊµãÊòéÁªÜ', thResultOps:'ÁªìÊûú / Êìç‰Ωú',
        labelID:'IDÔºö', labelTime:'Êó∂Èó¥Ôºö', labelInspector:'‰∫∫ÂëòÔºö', labelSupplier:'‰æõÂ∫îÂïÜÔºö',
        labelOrderNo:'ËÆ¢ÂçïÂè∑Á†ÅÔºö', labelLotNo:'Áîü‰∫ßÊâπÂè∑Ôºö', labelPartNo:'ÊñôÂè∑Ôºö', labelDrawingNo:'ÂõæÂè∑Ôºö', labelRevision:'ÁâàÊ¨°Ôºö', labelMaterial:'ÊùêË¥®Ôºö', labelSpec:'ËßÑÊ†ºÔºö', labelCategory:'‰∫ßÂìÅÁ±ªÂà´Ôºö', labelProcess:'Âà∂Á®ãÔºö', labelHeatNo:'ÁÇâÂè∑Ôºö', labelNotes:'Â§áÊ≥®Ôºö',
        labelOverall:'Êï¥‰ΩìÁªìÊûúÔºö', btnPrintOne:'ÂçïÁ¨îÊâìÂç∞', btnDelete:'Âà†Èô§Ê≠§Á¨î',
        msgNoPerm:'ÊÇ®ÁöÑË¥¶Âè∑Ê≤°ÊúâÊ£ÄËßÜÊä•ÂëäÁöÑÊùÉÈôêÔºàinputÔºâ„ÄÇ', msgVerify:'È™åËØÅ‰∏≠...', msgLoading:'ËΩΩÂÖ•‰∏≠...',
        msgLoadFail:'‚ùå ËΩΩÂÖ•Â§±Ë¥•Ôºö', msgEmpty:'ÁõÆÂâçÊ≤°ÊúâÂèØÊòæÁ§∫ÁöÑËµÑÊñô„ÄÇ', msgCount:'ÂÖ± {n} Á¨î„ÄÇÂèØÁî®ÂÖ≥ÈîÆÂ≠óÂø´ÈÄüËøáÊª§„ÄÇ',
        msgDeleting:'Âà†Èô§‰∏≠...', msgDeleted:'‚úÖ Â∑≤Âà†Èô§ 1 Á¨î„ÄÇ', msgDeleteFail:'‚ùå Âà†Èô§Â§±Ë¥•Ôºö', msgReLogin:'‚ùå ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÂÜçËØï„ÄÇ',
        theadCode:'‰ª£Âè∑', theadItem:'È°πÁõÆ / Â∞∫ÂØ∏', theadNom:'Ê†áÂáÜÂÄº', theadLo:'‰∏ãÈôêÂÖ¨Â∑Æ', theadHi:'‰∏äÈôêÂÖ¨Â∑Æ',
        theadM1:'Ê†∑ÂìÅ/ÂÆûÊµã1', theadM2:'Ê†∑ÂìÅ/ÂÆûÊµã2', theadM3:'Ê†∑ÂìÅ/ÂÆûÊµã3', theadM4:'Ê†∑ÂìÅ/ÂÆûÊµã4', theadM5:'Ê†∑ÂìÅ/ÂÆûÊµã5', theadDecision:'Âà§ÂÆö',
        appearance:'Â§ñËßÇ'
      },
      'en': {
        reportTitle:'QC Reports (Anchor)',
        filterPh:'Keyword (supplier/part/drawing/inspector)',
        btnReload:'Reload', btnClear:'Clear', btnReset:'Reset account', btnDiag:'Diagnose', btnRepair:'Repair',
        btnPrint:'Print / Save as PDF', btnExport:'Export Excel (offline)', btnBackToInput:'Back to Input', langTitle:'Choose language', langHint:'Select UI language:',
        debugTip:'Tip: add ?debug=1 to show raw response; add #resetpass to clear pass.',
        thBasic:'Basic Info', thPart:'Part Info', thUnified:'Appearance & Measurements', thResultOps:'Result / Actions',
        labelID:'ID: ', labelTime:'Time: ', labelInspector:'Inspector: ', labelSupplier:'Supplier: ',
        labelOrderNo:'Order No.: ', labelLotNo:'Lot No.: ', labelPartNo:'Part No.: ', labelDrawingNo:'Drawing No.: ', labelRevision:'Revision: ', labelMaterial:'Material: ', labelSpec:'Spec: ', labelCategory:'Category: ', labelProcess:'Process: ', labelHeatNo:'Heat No.: ', labelNotes:'Notes: ',
        labelOverall:'Overall: ', btnPrintOne:'Print single', btnDelete:'Delete',
        msgNoPerm:'Your account has no view permission (input).', msgVerify:'Verifying...', msgLoading:'Loading...',
        msgLoadFail:'‚ùå Load failed: ', msgEmpty:'No data to display.', msgCount:'Total {n}. Use keyword to filter.',
        msgDeleting:'Deleting...', msgDeleted:'‚úÖ Deleted.', msgDeleteFail:'‚ùå Delete failed: ', msgReLogin:'‚ùå Session expired. Please sign in again.',
        theadCode:'Code', theadItem:'Item / Dimension', theadNom:'Nominal', theadLo:'Lower Tol.', theadHi:'Upper Tol.',
        theadM1:'Sample1', theadM2:'Sample2', theadM3:'Sample3', theadM4:'Sample4', theadM5:'Sample5', theadDecision:'Decision',
        appearance:'Appearance'
      }
    };
    function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
    function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
    function selectLang(lang){ setLang(lang); closeLangModal(); render(); }
    function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
    function closeLangModal(){ document.getElementById('langModal').style.display='none'; }
    function t(key){ const lang=getLang()||'zh-TW'; const d=I18N[lang]||I18N['zh-TW']; return d[key]??(I18N['zh-TW'][key]??key); }
    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); el.innerHTML = t(k); });
      const filter = document.getElementById('filterText'); if (filter) filter.placeholder = t('filterPh');
      const titleEl = document.querySelector('title[data-i18n="reportTitle"]'); if (titleEl) titleEl.textContent = t('reportTitle');
      document.getElementById('tipDebug').textContent = t('debugTip');
    }

    // Ë£ΩÁ®ãÈ°ØÁ§∫
    const PROCESSES = [
      { code:'WIRE',     zh:'Á∑öÊùê',   cn:'Á∫øÊùê',   en:'WIRE' },
      { code:'FORMING',  zh:'ÊàêÂΩ¢',   cn:'ÊàêÂΩ¢',   en:'FORMING' },
      { code:'TAPING',   zh:'ÊîªÁâô',   cn:'ÊîªÁâô',   en:'TAPING' },
      { code:'CUTTING',  zh:'Ââ≤Ê∫ù',   cn:'Ââ≤Ê≤ü',   en:'CUTTING' },
      { code:'PLATING',  zh:'ÈõªÈçç',   cn:'ÁîµÈïÄ',   en:'PLATING' },
      { code:'FINISHED', zh:'ÊàêÂìÅ',   cn:'ÊàêÂìÅ',   en:'FINISHED' },
      { code:'ASSEMBLY', zh:'ÁµÑÁ´ã',   cn:'ÁªÑÁ´ã',   en:'ASSEMBLY' },
      { code:'FINAL',    zh:'ÊúÄÁµÇÊàêÂìÅ', cn:'ÊúÄÁªàÊàêÂìÅ', en:'FINAL FINISHED' }
    ];
    function mapProcess(code){
      if (!code) return '';
      const p = PROCESSES.find(x => x.code === String(code).toUpperCase());
      const lang = getLang() || 'zh-TW';
      if (!p) return code;
      if (lang==='en') return p.en;
      if (lang==='zh-CN') return `${p.cn} (${p.en})`;
      return `${p.zh} (${p.en})`;
    }


// Áî¢ÂìÅÈ°ûÂà•È°ØÁ§∫ÔºàÈõôË™ûÔºâ
const CATEGORIES = [
  { code:'PLUG',        zh:'Â°ûÂ≠ê',         cn:'Â°ûÂ≠ê',       en:'plug' },
  { code:'SLEEVE_A',    zh:'ÁÆ°Â≠ê_A type',  cn:'ÁÆ°Â≠ê_A type', en:'sleeve_A type' },
  { code:'SLEEVE_B',    zh:'ÁÆ°Â≠ê_B type',  cn:'ÁÆ°Â≠ê_B type', en:'sleeve_B type' },
  { code:'SLEEVE_H',    zh:'ÁÆ°Â≠ê_H type',  cn:'ÁÆ°Â≠ê_H type', en:'sleeve_H type' },
  { code:'FINISHED_A',  zh:'ÊàêÂìÅ_A type',  cn:'ÊàêÂìÅ_A type', en:'Finished_A type' },
  { code:'FINISHED_B',  zh:'ÊàêÂìÅ_B type',  cn:'ÊàêÂìÅ_B type', en:'Finished_B type' },
  { code:'FINISHED_H',  zh:'ÊàêÂìÅ_H type',  cn:'ÊàêÂìÅ_H type', en:'Finished_H type' },
  { code:'TOOL',        zh:'ÂÖßËø´Â∑•ÂÖ∑',     cn:'ÂÜÖËø´Â∑•ÂÖ∑',    en:'special tool' }
];
function mapCategory(code){
  if (!code) return '';
  const c = CATEGORIES.find(x => x.code === String(code).toUpperCase());
  const lang = getLang() || 'zh-TW';
  if (!c) return code;
  if (lang==='en') return c.en;
  if (lang==='zh-CN') return `${c.cn} (${c.en})`;
  return `${c.zh} (${c.en})`;
}
function showCategory(v){
  // ÂêëÂæåÁõ∏ÂÆπÔºöËàäË≥áÊñôËã•ÊòØÁ¥îÊñáÂ≠óÔºåÁõ¥Êé•ÂõûÂÇ≥ÔºõËã•ÁÇ∫‰ª£Á¢ºÔºåËΩâÊèõÁÇ∫ÈõôË™û
  const txt = String(v||'');
  const found = CATEGORIES.find(x => x.code === txt.toUpperCase());
  return found ? mapCategory(txt) : txt;
}



    // ‰∫ã‰ª∂
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    
    document.getElementById('btnExport').addEventListener('click', exportExcel);
    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { document.getElementById('filterText').value = ''; render(); });
    document.getElementById('btnReset').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      alert('Cleared. / Â∑≤Ê∏ÖÈô§„ÄÇ');
    });
    document.getElementById('btnDiag').addEventListener('click', diag);
    document.getElementById('btnRepair').addEventListener('click', repair);
    document.getElementById('btnLang').addEventListener('click', ()=> openLangModal());
    document.getElementById('filterText').addEventListener('input', render);

    let role = '', currentUser = '', canDelete = false, records = [];
    const tbody = document.getElementById('tbody');
    const msg = document.getElementById('msg');
    const raw = document.getElementById('raw');

    // Âà™Èô§ÔºàÈôê boss+adminÔºâ
    tbody.addEventListener('click', async (e)=>{
      const a = e.target.closest('button.btn-danger[data-id]');
      if (!a) return;
      const id = a.getAttribute('data-id');
      if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜÔºü\nAre you sure to delete this record?')) return;
      msg.textContent = t('msgDeleting');
      try{
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const r = await fetch('/api/inspections?id='+encodeURIComponent(id), { method:'DELETE', headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const ttxt = await r.text(); let j={}; try{ j=JSON.parse(ttxt);}catch{}
        if (!r.ok || (j && j.error)) throw new Error(j.error || ttxt);
        msg.textContent = t('msgDeleted');
        records = records.filter(x => x.id !== id);
        render();
      }catch(e){
        msg.textContent = t('msgDeleteFail') + (e.message||e);
      }
    });

    async function ensureAuth() {
      const user = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      const pass = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (!user || !pass) return { ok:false };
      try {
        const res = await fetch('/api/inspections?auth=1', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass } });
        const t = await res.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        if (!res.ok || !j.ok) return { ok:false };
        role = (j.role || '').toLowerCase();
        currentUser = (j.user || '');
        canDelete = (role === 'admin' && String(currentUser).toLowerCase() === 'boss');
        document.getElementById('btnRepair').style.display = role === 'admin' ? '' : 'none';
        return { ok:true };
      } catch { return { ok:false }; }
    }

    function listFromJson(data){
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (data.record) return listFromJson(data.record);
      if (data.records) return listFromJson(data.records);
      if (data.id && data.timestamp) return [data];
      return [];
    }

    async function load(){
      applyI18n();
      msg.textContent = t('msgVerify');
      const ok = await ensureAuth();
      if (!ok.ok){ msg.textContent = '‚ùå Unauthorized'; return; }
      if (!['admin','viewer'].includes(role)){ msg.textContent = t('msgNoPerm'); return; }
      msg.textContent = t('msgLoading');
      try{
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const res = await fetch('/api/inspections', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const text = await res.text();
        if (!res.ok) throw new Error(text || ('HTTP '+res.status));
        let data={}; try{ data=JSON.parse(text);}catch{ data=text; }
        records = listFromJson(data).filter(r => r && Array.isArray(r.measurements));
        records.sort((a,b)=>(b.timestamp||'').localeCompare(a.timestamp||''));
        if (new URLSearchParams(location.search).get('debug')==='1'){
          raw.style.display='block'; raw.textContent = text;
        }
        render();
        msg.textContent = records.length ? t('msgCount').replace('{n}', records.length) : t('msgEmpty');
      }catch(e){
        msg.textContent = t('msgLoadFail') + (e.message||e);
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
    function num(v){ return (v===0||v) ? Number(v).toFixed(3) : ''; }

    function buildUnifiedTable(r){
      const L = getLang();
      const th = `
        <thead><tr>
          <th>${t('theadCode')}</th>
                    <th>${t('theadItem')}</th>
          <th>${t('theadNom')}</th>
          <th>${t('theadLo')}</th>
          <th>${t('theadHi')}</th>
          <th>${t('theadM1')}</th>
          <th>${t('theadM2')}</th>
          <th>${t('theadM3')}</th>
          <th>${t('theadM4')}</th>
          <th>${t('theadM5')}</th>
          <th>${t('theadDecision')}</th>
        </tr></thead>`;

      // Â§ñËßÄÂàóÔºàÊúâÂ°´ÊâçÈ°ØÁ§∫Ôºâ
      const apMap = {};
      if (Array.isArray(r.appearance)){
        for (const a of r.appearance){
          const m = String(a.sample||'').match(/(\d+)/);
          const idx = m ? Number(m[1]) : null;
          if (idx && idx>=1 && idx<=5){
            const ok = String(a.result||'').toUpperCase()==='OK';
            apMap[idx] = ok ? (L==='en'?'OK':'O.K') : 'NG';
          }
        }
      }
      const apRow = Object.keys(apMap).length ? `
        <tr>
          <td></td>
          <td><strong>${t('appearance')}</strong></td>
          <td></td><td></td><td></td>
          <td>${escapeHtml(apMap[1]||'')}</td>
          <td>${escapeHtml(apMap[2]||'')}</td>
          <td>${escapeHtml(apMap[3]||'')}</td>
          <td>${escapeHtml(apMap[4]||'')}</td>
          <td>${escapeHtml(apMap[5]||'')}</td>
          <td>${Object.values(apMap).every(v=>v==='OK'||v==='O.K')?'PASS':'FAIL'}</td>
        </tr>` : '';

      const rows = (Array.isArray(r.measurements)?r.measurements:[]).map(m=>{
        const arr = Array.isArray(m.measured) ? m.measured : ((m.measured===0||m.measured)?[m.measured]:[]);
        const c = [0,1,2,3,4].map(i => (arr[i]===0||arr[i]) ? Number(arr[i]).toFixed(3) : '');
        const dec = (typeof m.pass==='boolean') ? (m.pass?'PASS':'FAIL') : '';
        return `<tr>
          <td>${escapeHtml(m.code||'')}</td>
          <td>${escapeHtml(m.name||'')}</td>
          <td>${num(m.nominal)}</td>
          <td>${num(m.tolMinus)}</td>
          <td>${num(m.tolPlus)}</td>
          <td>${c[0]}</td><td>${c[1]}</td><td>${c[2]}</td><td>${c[3]}</td><td>${c[4]}</td>
          <td>${dec}</td>
        </tr>`;
      }).join('');

      return `<table class="mini">${th}<tbody>${apRow}${rows}</tbody></table>`;
    }

    function render(){
      applyI18n();
      const kw = (document.getElementById('filterText').value || '').trim().toLowerCase();
      const rows = records.filter(r => {
        if (!kw) return true;
        const s = [r.supplier, r.orderNo, r.lotNo, r.partNo, r.material, r.spec, r.category, r.drawingNo, r.inspector, r.process, r.processLabel].join(' ').toLowerCase();
        return s.includes(kw);
      }).map(r => {
        return `<tr>
          <td>
            <div>${t('labelID')}${escapeHtml(r.id||'')}</div>
            <div>${t('labelTime')}${escapeHtml(new Date(r.timestamp||'').toLocaleString())}</div>
            <div>${t('labelInspector')}${escapeHtml(r.inspector||'')}</div>
            <div>${t('labelSupplier')}${escapeHtml(r.supplier||'')}</div>
          </td>
          <td>
            <div>${t('labelOrderNo')}${escapeHtml(r.orderNo||'')}</div>
            <div>${t('labelLotNo')}${escapeHtml(r.lotNo||'')}</div>
            <div>${t('labelPartNo')}${escapeHtml(r.partNo||'')}</div>
            <div>${t('labelMaterial')}${escapeHtml(r.material||'')}</div>
            <div>${t('labelSpec')}${escapeHtml(r.spec||'')}</div>
            <div>${t('labelCategory')}${escapeHtml(showCategory(r.category||''))}</div>
            <div>${t('labelDrawingNo')}${escapeHtml(r.drawingNo||'')}</div>
            <div>${t('labelProcess')}${escapeHtml(mapProcess(r.process||r.processCode||''))}</div>
            ${r.heatNo?`<div>${t('labelHeatNo')}${escapeHtml(r.heatNo||'')}</div>`:''}
            <div>${t('labelNotes')}${escapeHtml(r.notes||'')}</div>
          </td>
          <td>${buildUnifiedTable(r)}</td>
          <td>
            <div>${t('labelOverall')}<strong>${r.overallResult==='PASS'?'‚úÖ PASS':'‚ùå FAIL'}</strong></div>
            <div class="noprint" style="margin-top:6px; display:flex; flex-direction:column; gap:6px">
              <a class="btn btn-outline" target="_blank" href="print.html?id=${encodeURIComponent(r.id)}">${t('btnPrintOne')}</a>
              ${canDelete ? `<button class="btn btn-danger" data-id="${r.id}">${t('btnDelete')}</button>` : ''}
            </div>
          </td>
        </tr>`;
      }).join('');

      document.getElementById('tbody').innerHTML = rows || `<tr><td colspan="4" class="muted">${t('msgEmpty')}</td></tr>`;
    }

    async function diag(){
      try{
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const r = await fetch('/api/inspections?diag=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const ttxt = await r.text(); document.getElementById('raw').style.display='block'; document.getElementById('raw').textContent = ttxt;
      }catch(e){ alert(e); }
    }
    async function repair(){
      try{
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const r = await fetch('/api/inspections?repair=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const ttxt = await r.text(); document.getElementById('raw').style.display='block'; document.getElementById('raw').textContent = ttxt;
      }catch(e){ alert(e); }
    }

    
    /* ====== Offline Excel Export (.xls via SpreadsheetML 2003) ====== */
    function getFilteredRecords(){
      const kw = (document.getElementById('filterText').value || '').trim().toLowerCase();
      return (records||[]).filter(r => {
        if (!kw) return true;
        const s = [r.supplier, r.orderNo, r.lotNo, r.partNo, r.material, r.spec, r.category, r.drawingNo, r.inspector, r.process, r.processLabel].join(' ').toLowerCase();
        return s.includes(kw);
      });
    }
    function escapeXml(s){
      return String(s??'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function sheetNameFrom(r){
      const base = (r.supplier||'') + '-' + (r.partNo||'') + '-' + (r.id||'INS');
      // Excel sheet name rules: max 31 chars, cannot contain : \ / ? * [ ]
      let name = base.replace(/[:\\\/\?\*\[\]]/g, ' ').trim();
      if (name.length > 31) name = name.slice(0, 31);
      if (!name) name = 'Sheet';
      return name;
    }
    function cell(v, type, styleId){
      const hasStyle = styleId ? ` ss:StyleID="${styleId}"` : '';
      if (type === 'Number' && v !== '' && v !== null && v !== undefined && !isNaN(Number(v))) {
        return `<Cell${hasStyle}><Data ss:Type="Number">${Number(v)}</Data></Cell>`;
      }
      return `<Cell${hasStyle}><Data ss:Type="String">${escapeXml(v)}</Data></Cell>`;
    }
    function buildSpreadsheetXml(list){
      const now = new Date();
      const docProps = `
        <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
          <Author>Anchor QC</Author>
          <LastAuthor>Anchor QC</LastAuthor>
          <Created>${now.toISOString()}</Created>
          <Company>ANCHOR FASTENERS INDUSTRIAL CO., LTD.</Company>
          <Version>12.00</Version>
        </DocumentProperties>`;
      const styles = `
        <Styles>
          <Style ss:ID="sHeader"><Font ss:Bold="1"/><Interior ss:Color="#EEECE1" ss:Pattern="Solid"/></Style>
          <Style ss:ID="sSub"><Font ss:Bold="1"/></Style>
          <Style ss:ID="sNum3"><NumberFormat ss:Format="0.000"/></Style>
          <Style ss:ID="sCenter"><Alignment ss:Horizontal="Center"/></Style>
        </Styles>`;

      const ws = list.map((r, idx) => {
        // Appearance map
        const apMap = {};
        if (Array.isArray(r.appearance)) {
          for (const a of r.appearance) {
            const m = String(a.sample||'').match(/(\d+)/);
            const i = m ? Number(m[1]) : null;
            if (i && i>=1 && i<=5) apMap[i] = String(a.result||'').toUpperCase()==='OK' ? (getLang()==='en'?'OK':'O.K') : 'NG';
          }
        }
        // Header + sections
        const rows = [];
        rows.push(`<Row>${cell('QC Report / ÂìÅÊ™¢Â†±Âëä', 'String', 'sHeader')}${cell('', 'String', 'sHeader')}${cell('', 'String', 'sHeader')}${cell('', 'String', 'sHeader')}</Row>`);

        // Basic Info
        rows.push(`<Row>${cell(t('thBasic'), 'String', 'sSub')}</Row>`);
        rows.push(`<Row>${cell(t('labelID') + (r.id||''))}${cell(t('labelTime') + new Date(r.timestamp||'').toLocaleString())}${cell(t('labelInspector') + (r.inspector||''))}${cell(t('labelOverall') + (r.overallResult||''))}</Row>`);
        rows.push(`<Row>${cell(t('labelSupplier') + (r.supplier||''))}${cell(t('labelOrderNo') + (r.orderNo||''))}${cell(t('labelLotNo') + (r.lotNo||''))}${cell('')}</Row>`);

        // Part Info
        rows.push(`<Row/>`);
        rows.push(`<Row>${cell(t('thPart'), 'String', 'sSub')}</Row>`);
        rows.push(`<Row>${cell(t('labelPartNo') + (r.partNo||''))}${cell(t('labelDrawingNo') + (r.drawingNo||''))}${cell(t('labelMaterial') + (r.material||''))}${cell(t('labelSpec') + (r.spec||''))}</Row>`);
        rows.push(`<Row>${cell(t('labelCategory') + (showCategory(r.category||'')))}${cell(t('labelProcess') + (mapProcess(r.process||'')))}${cell(t('labelNotes') + (r.notes||''))}${cell('')}</Row>`);

        // Measurements table header
        rows.push(`<Row/>`);
        rows.push(`<Row>${cell(t('thUnified'), 'String', 'sSub')}</Row>`);
        rows.push(`<Row>${cell(t('theadCode'),'String','sHeader')}${cell(t('theadItem'),'String','sHeader')}${cell(t('theadNom'),'String','sHeader')}${cell(t('theadLo'),'String','sHeader')}${cell(t('theadHi'),'String','sHeader')}${cell(t('theadM1'),'String','sHeader')}${cell(t('theadM2'),'String','sHeader')}${cell(t('theadM3'),'String','sHeader')}${cell(t('theadM4'),'String','sHeader')}${cell(t('theadM5'),'String','sHeader')}${cell(t('theadDecision'),'String','sHeader')}</Row>`);

        // Appearance row (optional)
        if (Object.keys(apMap).length) {
          const pass = Object.values(apMap).every(v => v==='OK' || v==='O.K') ? 'PASS' : 'FAIL';
          rows.push(`<Row>${cell('')}${cell(t('appearance'))}${cell('')}${cell('')}${cell('')}${cell(apMap[1]||'')}${cell(apMap[2]||'')}${cell(apMap[3]||'')}${cell(apMap[4]||'')}${cell(apMap[5]||'')}${cell(pass)}</Row>`);
        }

        // Measurement rows
        const ms = Array.isArray(r.measurements) ? r.measurements : [];
        for (const m of ms) {
          const arr = Array.isArray(m.measured) ? m.measured : ((m.measured===0||m.measured)?[m.measured]:[]);
          const c = [0,1,2,3,4].map(i => (arr[i]===0||arr[i]) ? Number(arr[i]) : '');
          const dec = (typeof m.pass==='boolean') ? (m.pass ? 'PASS' : 'FAIL') : '';
          rows.push(
            `<Row>` +
            cell(m.code||'') +
            cell(m.name||'') +
            cell(m.nominal, 'Number', 'sNum3') +
            cell(m.tolMinus, 'Number', 'sNum3') +
            cell(m.tolPlus, 'Number', 'sNum3') +
            cell(c[0], 'Number', 'sNum3') +
            cell(c[1], 'Number', 'sNum3') +
            cell(c[2], 'Number', 'sNum3') +
            cell(c[3], 'Number', 'sNum3') +
            cell(c[4], 'Number', 'sNum3') +
            cell(dec) +
            `</Row>`
          );
        }

        const table = `<Table>${rows.join('')}</Table>`;
        const name = escapeXml(sheetNameFrom(r) || ('Sheet'+(idx+1)));
        return `<Worksheet ss:Name="${name}">${table}</Worksheet>`;
      }).join('');

      const xml = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 ${docProps}
 ${styles}
 ${ws}
</Workbook>`;
      return xml;
    }

    function exportExcel(){
      const list = getFilteredRecords();
      if (!list.length){ alert(t('msgEmpty') || 'No data'); return; }
      const xml = buildSpreadsheetXml(list);
      const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
      const a = document.createElement('a');
      const dt = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const fname = `QC_Reports_${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}_${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}.xls`;
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    }

    window.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
