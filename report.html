<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>å®‰æ‹“ï½œå ±å‘Šåˆ—è¡¨</title><style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:#f8fafc;color:#111}.wrap{max-width:1100px;margin:0 auto;padding:16px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}h1{margin:0 0 8px 0;font-size:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}th{background:#f3f4f6}.toolbar{display:flex;gap:8px;align-items:center;margin:8px 0}.btn{padding:8px 12px;border:none;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer}.btn.gray{background:#e5e7eb;color:#111}.hidden{display:none!important}.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}.panel{background:#fff;border-radius:14px;padding:16px;width:360px;box-shadow:0 10px 25px rgba(0,0,0,.15)}
</style></head><body><div class="wrap">
<div class="card"><h1>å“æª¢å ±å‘Šåˆ—è¡¨</h1>
<div class="toolbar">
  <button class="btn gray" id="btnLang">ğŸŒ èªè¨€</button>
  <select id="fSupplier"><option value="">å…¨éƒ¨ä¾›æ‡‰å•†</option><option value="å®‰æ‹“">å®‰æ‹“</option><option value="å®‰å¯">å®‰å¯</option></select>
  <input id="fPart" placeholder="æ–™è™Ÿé—œéµå­—"/>
  <button class="btn" id="btnReload">é‡æ–°è¼‰å…¥</button>
  <span id="tip" style="margin-left:auto;color:#6b7280"></span>
</div>
<table id="grid"><thead><tr>
  <th>æ“ä½œ</th><th>å ±å‘Šç·¨è™Ÿ</th><th>æ™‚é–“</th><th>æª¢é©—äººå“¡</th><th>ä¾›æ‡‰å•†</th><th>è£½ç¨‹</th><th>æ–™è™Ÿ</th><th>åœ–è™Ÿ</th><th>ç‰ˆæ¬¡</th><th>çµæœ</th>
</tr></thead><tbody></tbody></table>
</div></div>

<div id="langModal" class="modal hidden"><div class="panel">
  <h3>é¸æ“‡èªè¨€</h3><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
    <button class="btn gray" data-lang="zh-Hant">ç¹é«”</button>
    <button class="btn gray" data-lang="zh-Hans">ç®€ä½“</button>
    <button class="btn gray" data-lang="en">English</button>
  </div>
</div></div>

<script>
const tip=document.getElementById('tip'),tbody=document.querySelector('#grid tbody'); let ROLE="",USER="";
function getLang(){const s=localStorage.getItem('qci_lang');return["zh-Hant","zh-Hans","en"].includes(s)?s:"zh-Hant"}
document.getElementById('btnLang').onclick=()=>document.getElementById('langModal').classList.remove('hidden');
document.getElementById('langModal').addEventListener('click',e=>{if(e.target.dataset.lang){localStorage.setItem('qci_lang',e.target.dataset.lang);document.getElementById('langModal').classList.add('hidden');location.reload()} if(e.target.id==='langModal')e.currentTarget.classList.add('hidden')});

async function ensureAuth(){let u=localStorage.getItem('qci_user')||"",p=localStorage.getItem('qci_pass')||"";if(!u||!p){u=prompt('å¸³è™Ÿ')||"";p=prompt('å¯†ç¢¼')||"";if(!u||!p)return!1;localStorage.setItem('qci_user',u);localStorage.setItem('qci_pass',p)}try{const r=await fetch('/api/inspections?auth=1',{headers:{'x-user':u,'x-pass':p,'x-passcode':p}});const t=await r.text();let j={};try{j=JSON.parse(t)}catch{} if(!r.ok||!j.ok) return!1;ROLE=(j.role||"").toLowerCase();USER=u;return["admin","viewer"].includes(ROLE)}catch{return!1}}
function listFromJson(x){if(Array.isArray(x))return x.length&&x[0]&&x[0].record&&x[0].record.record?x[0].record.record:x; if(x&&Array.isArray(x.record))return x.record; return[]}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function row(r){const del=(ROLE==='admin'&&String((localStorage.getItem('qci_user')||'')).toLowerCase()==='boss')?`<button class="btn gray" onclick="delRec('${esc(r.id)}')">åˆª</button>`:""; return `<tr>
  <td><a class="btn" href="print.html?id=${encodeURIComponent(r.id)}" target="_blank">åˆ—å°</a> ${del}</td>
  <td>${esc(r.id)}</td><td>${esc((r.timestamp||'').replace('T',' ').replace('Z',''))}</td>
  <td>${esc(r.inspector)}</td><td>${esc(r.supplier)}</td><td>${esc(r.process||'')}</td>
  <td>${esc(r.partNo)}</td><td>${esc(r.drawingNo)}</td><td>${esc(r.revision)}</td><td>${esc(r.overallResult||'')}</td></tr>`}
async function load(){tip.textContent='è®€å–ä¸­...'; tbody.innerHTML=''; try{const u=localStorage.getItem('qci_user')||"",p=localStorage.getItem('qci_pass')||""; const r=await fetch('/api/inspections',{headers:{'x-user':u,'x-pass':p,'x-passcode':p}});const t=await r.text();if(!r.ok)throw new Error(t||('HTTP '+r.status));let j={};try{j=JSON.parse(t)}catch{j=[]} let list=listFromJson(j).filter(rec=>rec&&rec.id); const fs=document.getElementById('fSupplier').value,fp=document.getElementById('fPart').value.trim(); if(fs) list=list.filter(x=>String(x.supplier)===fs); if(fp) list=list.filter(x=>String(x.partNo||'').includes(fp));
  list.sort((a,b)=>String(a.timestamp).localeCompare(String(b.timestamp))); for(const r0 of list) tbody.insertAdjacentHTML('beforeend',row(r0)); tip.textContent='å…± '+list.length+' ç­†'; }catch(e){tip.textContent='âŒ è¼‰å…¥å¤±æ•—ï¼š'+(e.message||e)}}
document.getElementById('btnReload').onclick=load;
async function delRec(id){if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼Ÿ'))return; try{const u=localStorage.getItem('qci_user')||"",p=localStorage.getItem('qci_pass')||"";const r=await fetch('/api/inspections?id='+encodeURIComponent(id),{method:'DELETE',headers:{'x-user':u,'x-pass':p,'x-passcode':p}});const t=await r.text();let j={};try{j=JSON.parse(t)}catch{} if(!r.ok||!j.ok) throw new Error(t||('HTTP '+r.status)); load();}catch(e){alert('åˆªé™¤å¤±æ•—ï¼š'+(e.message||e))}}
(async()=>{const ok=await ensureAuth(); if(!ok){alert('æœªæˆæ¬Šæˆ–ç™»å…¥å¤±æ•—');location.href='index.html';return;} load();})();
</script>
</body></html>
