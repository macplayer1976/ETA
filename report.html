<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="reportTitle">å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1160px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input { padding:8px; border:1px solid #ccc; border-radius:8px; flex:1 }
    .btn { padding:10px 14px; border:none; border-radius:10px; background:#2563eb; color:#fff; cursor:pointer; }
    .btn-outline { background:#f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    a.btn { text-decoration:none; display:inline-block; }
    .mini th, .mini td { font-size:12px; padding:6px; }
    @media print { .noprint { display: none; } body { padding: 0; } }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="reportTitle">å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰</h2>
    <p class="noprint" style="color:#666">ANCHOR FASTENERS INDUSTRIAL CO., LTD.</p>
    <div class="noprint row">
      <input id="filterText" placeholder="é—œéµå­—ï¼ˆä¾›æ‡‰å•†/æ–™è™Ÿ/åœ–è™Ÿ/æª¢é©—äººå“¡ï¼‰" />
      <button class="btn" id="btnReload" data-i18n="btnReload">é‡æ–°è¼‰å…¥</button>
      <button class="btn btn-outline" id="btnClear" data-i18n="btnClear">æ¸…é™¤</button>
      <a class="btn btn-outline" href="index.html" data-i18n="btnBack">å›ç¾å ´è¼¸å…¥</a>
      <button class="btn btn-outline" id="btnLang">ğŸŒ</button>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:21%" data-i18n="thBasic">åŸºæœ¬è³‡è¨Š</th>
          <th style="width:27%" data-i18n="thPart">æ–™ä»¶è³‡è¨Š</th>
          <th style="width:36%" data-i18n="thUnified">å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°</th>
          <th style="width:16%" data-i18n="thOps">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="noprint" style="color:#666"></p>
  </div>

  <!-- Language modal -->
  <div id="langModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; border-radius:12px; padding:16px; width:min(92vw,420px)">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
        <button onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

<script>
const I18N = {
  'zh-TW': {
    reportTitle:'å“æª¢å ±å‘Šï¼ˆå®‰æ‹“ï¼‰', btnReload:'é‡æ–°è¼‰å…¥', btnClear:'æ¸…é™¤', btnBack:'å›ç¾å ´è¼¸å…¥',
    thBasic:'åŸºæœ¬è³‡è¨Š', thPart:'æ–™ä»¶è³‡è¨Š', thUnified:'å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°', thOps:'æ“ä½œ',
    labelID:'IDï¼š', labelTime:'æ™‚é–“ï¼š', labelInspector:'äººå“¡ï¼š',
    labelSupplier:'ä¾›æ‡‰å•†ï¼š', labelOrder:'è¨‚å–®è™Ÿç¢¼ï¼š', labelLot:'ç”Ÿç”¢æ‰¹è™Ÿï¼š', labelPartNo:'ç”¢å“æ–™è™Ÿï¼š', labelDrawingNo:'åœ–è™Ÿï¼š',
    labelMaterial:'æè³ªï¼š', labelSpec:'è¦æ ¼ï¼š', labelProductType:'ç”¢å“é¡åˆ¥ï¼š', labelProcess:'è£½ç¨‹ï¼š', labelNotes:'å‚™è¨»ï¼š',
    btnPrintOne:'å–®ç­†åˆ—å°', btnDelete:'åˆªé™¤', langTitle:'é¸æ“‡èªè¨€',
    theadItem:'é …ç›®/å°ºå¯¸', theadNom:'åç›®', theadLo:'ä¸‹é™', theadHi:'ä¸Šé™', theadM1:'å¯¦æ¸¬1', theadM2:'å¯¦æ¸¬2', theadM3:'å¯¦æ¸¬3', theadM4:'å¯¦æ¸¬4', theadM5:'å¯¦æ¸¬5', theadDecision:'åˆ¤å®š',
    appearance:'å¤–è§€'
  },
  'zh-CN': {
    reportTitle:'å“æ£€æŠ¥å‘Šï¼ˆå®‰æ‹“ï¼‰', btnReload:'é‡æ–°è½½å…¥', btnClear:'æ¸…é™¤', btnBack:'å›ç°åœºè¾“å…¥',
    thBasic:'åŸºæœ¬ä¿¡æ¯', thPart:'æ–™ä»¶ä¿¡æ¯', thUnified:'å¤–è§‚ä¸é‡æµ‹æ˜ç»†', thOps:'æ“ä½œ',
    labelID:'IDï¼š', labelTime:'æ—¶é—´ï¼š', labelInspector:'äººå‘˜ï¼š',
    labelSupplier:'ä¾›åº”å•†ï¼š', labelOrder:'è®¢å•å·ç ï¼š', labelLot:'ç”Ÿäº§æ‰¹å·ï¼š', labelPartNo:'äº§å“æ–™å·ï¼š', labelDrawingNo:'å›¾å·ï¼š',
    labelMaterial:'æè´¨ï¼š', labelSpec:'è§„æ ¼ï¼š', labelProductType:'äº§å“ç±»åˆ«ï¼š', labelProcess:'åˆ¶ç¨‹ï¼š', labelNotes:'å¤‡æ³¨ï¼š',
    btnPrintOne:'å•ç¬”æ‰“å°', btnDelete:'åˆ é™¤', langTitle:'é€‰æ‹©è¯­è¨€',
    theadItem:'é¡¹ç›®/å°ºå¯¸', theadNom:'åä¹‰', theadLo:'ä¸‹é™', theadHi:'ä¸Šé™', theadM1:'å®æµ‹1', theadM2:'å®æµ‹2', theadM3:'å®æµ‹3', theadM4:'å®æµ‹4', theadM5:'å®æµ‹5', theadDecision:'åˆ¤å®š',
    appearance:'å¤–è§‚'
  },
  'en': {
    reportTitle:'QC Reports (Anchor)', btnReload:'Reload', btnClear:'Clear', btnBack:'Back to Input',
    thBasic:'Basic Info', thPart:'Part Info', thUnified:'Appearance & Measurements', thOps:'Actions',
    labelID:'ID: ', labelTime:'Time: ', labelInspector:'Inspector: ',
    labelSupplier:'Supplier: ', labelOrder:'Order No.: ', labelLot:'Lot No.: ', labelPartNo:'Part No.: ', labelDrawingNo:'Drawing No.: ',
    labelMaterial:'Material: ', labelSpec:'Spec: ', labelProductType:'Product Category: ', labelProcess:'Process: ', labelNotes:'Notes: ',
    btnPrintOne:'Print single', btnDelete:'Delete', langTitle:'Choose language',
    theadItem:'Item/Dim.', theadNom:'Nominal', theadLo:'Lower', theadHi:'Upper', theadM1:'Sample1', theadM2:'Sample2', theadM3:'Sample3', theadM4:'Sample4', theadM5:'Sample5', theadDecision:'Decision',
    appearance:'Appearance'
  }
};
function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
function setLang(x){ localStorage.setItem('qci_lang', x); applyI18n(); render(); }
function selectLang(x){ setLang(x); document.getElementById('langModal').style.display='none'; }
function t(k){ const d = I18N[getLang()] || I18N['zh-TW']; return d[k] ?? (I18N['zh-TW'][k] ?? k); }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); el.innerHTML=t(k); });
  const titleEl = document.querySelector('title[data-i18n="reportTitle"]'); if (titleEl) titleEl.textContent = t('reportTitle');
}
document.getElementById('btnLang').addEventListener('click', ()=> document.getElementById('langModal').style.display='flex');

const tbody = document.getElementById('tbody'); const msg = document.getElementById('msg');
document.getElementById('btnReload').addEventListener('click', load);
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('filterText').value=''; render(); });
document.getElementById('filterText').addEventListener('input', render);

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
function num(v){ return (v===0||v) ? Number(v).toFixed(3) : ''; }

let records = [];
function listFromJson(data){
  if (!data) return [];
  if (Array.isArray(data)) return data;
  if (data.record) return listFromJson(data.record);
  if (data.records) return listFromJson(data.records);
  if (data.id && data.timestamp) return [data];
  return [];
}

async function load(){
  applyI18n(); msg.textContent='Loading...';
  try{
    const u = localStorage.getItem('qci_user')||'';
    const p = localStorage.getItem('qci_pass')||'';
    const res = await fetch('/api/inspections', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
    const text = await res.text(); let data={}; try{ data=JSON.parse(text);}catch{ data=text; }
    records = listFromJson(data).filter(r => r && Array.isArray(r.measurements));
    records.sort((a,b)=>(b.timestamp||'').localeCompare(a.timestamp||''));
    render(); msg.textContent = `å…± ${records.length} ç­†`;
  }catch(e){ msg.textContent = 'è¼‰å…¥å¤±æ•—ï¼š'+(e.message||e); }
}

function buildUnifiedTable(r){
  const th = `<thead><tr>
    <th>${t('theadItem')}</th><th>${t('theadNom')}</th><th>${t('theadLo')}</th><th>${t('theadHi')}</th>
    <th>${t('theadM1')}</th><th>${t('theadM2')}</th><th>${t('theadM3')}</th><th>${t('theadM4')}</th><th>${t('theadM5')}</th><th>${t('theadDecision')}</th>
  </tr></thead>`;

  const apMap = {};
  if (Array.isArray(r.appearance)){
    for (const a of r.appearance){
      const m = String(a.sample||'').match(/(\d+)/);
      const idx = m ? Number(m[1]) : null;
      if (idx && idx>=1 && idx<=5){
        apMap[idx] = String(a.result||'').toUpperCase().startsWith('OK') ? (getLang()==='en'?'OK':'O.K') : 'NG';
      }
    }
  }
  const apRow = Object.keys(apMap).length ? `<tr>
    <td><strong>${t('appearance')}</strong></td><td></td><td></td><td></td>
    <td>${escapeHtml(apMap[1]||'')}</td><td>${escapeHtml(apMap[2]||'')}</td><td>${escapeHtml(apMap[3]||'')}</td><td>${escapeHtml(apMap[4]||'')}</td><td>${escapeHtml(apMap[5]||'')}</td>
    <td>${Object.values(apMap).every(v=>v==='OK'||v==='O.K')?'PASS':'FAIL'}</td>
  </tr>` : '';

  const rows = (Array.isArray(r.measurements)?r.measurements:[]).map(m=>{
    const arr = Array.isArray(m.measured) ? m.measured : ((m.measured===0||m.measured)?[m.measured]:[]);
    const vals = [0,1,2,3,4].map(i => num(arr[i]));
    // åˆ¤å®š
    let dec=''; 
    if ((m.nominal===0||m.nominal) && (m.tolMinus===0||m.tolMinus) && (m.tolPlus===0||m.tolPlus) && arr.length){
      const min = Number(m.nominal)+Number(m.tolMinus), max = Number(m.nominal)+Number(m.tolPlus);
      const ok = arr.filter(v=>v===0||v).map(Number).every(v => v>=min && v<=max);
      dec = ok?'PASS':'FAIL';
    }
    return `<tr><td>${escapeHtml(m.name||'')}</td>
      <td>${num(m.nominal)}</td><td>${num(m.tolMinus)}</td><td>${num(m.tolPlus)}</td>
      <td>${vals[0]}</td><td>${vals[1]}</td><td>${vals[2]}</td><td>${vals[3]}</td><td>${vals[4]}</td><td>${dec}</td></tr>`;
  }).join('');

  return `<table class="mini">${th}<tbody>${apRow}${rows}</tbody></table>`;
}

function render(){
  const kw = (document.getElementById('filterText').value||'').toLowerCase();
  tbody.innerHTML = records.filter(r=>{
    const hay = [r.supplier,r.partNo,r.drawingNo,r.inspector,r.orderNo,r.lotNo].join(' ').toLowerCase();
    return !kw || hay.includes(kw);
  }).map(r=>{
    return `<tr>
      <td>
        <div>${t('labelID')}${escapeHtml(r.id||'')}</div>
        <div>${t('labelTime')}${escapeHtml(r.timestamp||'')}</div>
        <div>${t('labelInspector')}${escapeHtml(r.inspector||'')}</div>
      </td>
      <td>
        <div>${t('labelSupplier')}${escapeHtml(r.supplier||'')}</div>
        <div>${t('labelOrder')}${escapeHtml(r.orderNo||'')}</div>
        <div>${t('labelLot')}${escapeHtml(r.lotNo||'')}</div>
        <div>${t('labelPartNo')}${escapeHtml(r.partNo||'')}</div>
        <div>${t('labelDrawingNo')}${escapeHtml(r.drawingNo||'')}</div>
        <div>${t('labelMaterial')}${escapeHtml(r.material||'')}</div>
        <div>${t('labelSpec')}${escapeHtml(r.spec||'')}</div>
        <div>${t('labelProductType')}${escapeHtml(r.productType||'')}</div>
        <div>${t('labelProcess')}${escapeHtml(r.process||'')}</div>
        <div>${t('labelNotes')}${escapeHtml(r.notes||'')}</div>
      </td>
      <td>${buildUnifiedTable(r)}</td>
      <td>
        <a class="btn" href="print.html?id=${encodeURIComponent(r.id||'')}" target="_blank">${t('btnPrintOne')}</a>
      </td>
    </tr>`;
  }).join('');
}

load();
</script>
</body>
</html>
