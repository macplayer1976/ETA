<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>品檢報告｜QC</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans',sans-serif;background:#f8fafc;margin:0}
    header{background:#0f172a;color:#fff;padding:10px 16px}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .btn{background:#0ea5e9;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.outline{background:#fff;color:#0ea5e9;border:1px solid #0ea5e9}
    .muted{color:#64748b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:12px}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{border:1px solid #e5e7eb;padding:4px 6px;text-align:center}
    th{background:#f1f5f9}
    .result{font-weight:700}
    .pass{color:#16a34a}.fail{color:#dc2626}
    #loginMask{position:fixed;inset:0;background:rgba(2,6,23,.6);display:flex;align-items:center;justify-content:center;z-index:20}
    #loginPanel{width:min(480px,92vw);background:#fff;border-radius:12px;padding:16px}
  </style>
</head>
<body>
  <header>安拓實業有限公司｜品檢報告</header>
  <div class="wrap">
    <div class="toolbar">
      <button class="btn" id="btnReload">重新讀取</button>
      <a class="btn outline" href="index.html">回現場輸入</a>
      <input id="kw" placeholder="關鍵字（供應商/料號/圖號/人員）" style="flex:1 1 280px;padding:8px;border:1px solid #cbd5e1;border-radius:8px">
      <span class="muted" id="tip"></span>
    </div>
    <div class="grid" id="list"></div>
  </div>

  <!-- 登入遮罩 -->
  <div id="loginMask" class="hidden">
    <div id="loginPanel">
      <h3>登入</h3>
      <div class="row" style="display:flex;gap:8px;margin-top:6px">
        <input id="user" placeholder="帳號" style="flex:1 1 160px;padding:8px;border:1px solid #cbd5e1;border-radius:8px">
        <input id="pwd" type="password" placeholder="密碼" style="flex:1 1 160px;padding:8px;border:1px solid #cbd5e1;border-radius:8px">
        <button class="btn" id="btnLogin">登入</button>
      </div>
      <div class="muted" id="loginMsg"></div>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const tip = document.getElementById('tip');
    const kw = document.getElementById('kw');

    function showLogin(show, text){
      document.getElementById('loginMask').classList.toggle('hidden', !show);
      if (text) document.getElementById('loginMsg').textContent = text;
    }

    async function authCheck(u,p){
      try{
        const r = await fetch('/api/inspections?auth=1', { headers:{'x-user':u,'x-pass':p,'x-passcode':p} });
        const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        return r.ok && j && j.ok !== false ? { ok:true, role: (j.role||'').toLowerCase() } : { ok:false };
      }catch{ return { ok:false };}
    }

    async function ensureLogin(){
      const u = localStorage.getItem('qci_user')||'';
      const p = localStorage.getItem('qci_pass')||'';
      if (!u || !p){ showLogin(true); return false; }
      const info = await authCheck(u,p);
      if (!info.ok){ showLogin(true,'登入失敗，請重試'); return false; }
      localStorage.setItem('qci_role', info.role||'');
      showLogin(false);
      return true;
    }

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pwd').value.trim();
      if (!u || !p){ document.getElementById('loginMsg').textContent='請輸入帳密'; return; }
      const ok = await authCheck(u,p);
      if (!ok.ok){ document.getElementById('loginMsg').textContent='帳號或密碼錯誤'; return; }
      localStorage.setItem('qci_user', u);
      localStorage.setItem('qci_pass', p);
      localStorage.setItem('qci_role', ok.role||'');
      showLogin(false);
      load();
    });

    function looksLikeRecord(o){
      return o && typeof o==='object' && ('id'in o) && Array.isArray(o.measurements);
    }
    function listFromJson(data){
      // 平展各種 JSONBin 回傳格式
      if (Array.isArray(data)){
        // 可能是乾淨陣列或每筆包 record/metadata
        return data.flatMap(x => {
          if (looksLikeRecord(x)) return [x];
          if (x && typeof x==='object'){
            if (looksLikeRecord(x.record)) return [x.record];
            if (x.record && Array.isArray(x.record)) return x.record.filter(looksLikeRecord);
            if (Array.isArray(x.records)) return x.records.filter(looksLikeRecord);
          }
          return [];
        });
      }
      if (data && typeof data==='object'){
        if (looksLikeRecord(data)) return [data];
        if (data.record && Array.isArray(data.record)) return data.record.filter(looksLikeRecord);
        if (Array.isArray(data.records)) return data.records.filter(looksLikeRecord);
      }
      return [];
    }
    function dedupById(list){
      const map = new Map();
      for (const r of list){ if (r && r.id) map.set(String(r.id), r); }
      return Array.from(map.values());
    }

    function rowJudgement(m){
      const nom = Number(m.nominal), lo=Number(m.tolMinus), hi=Number(m.tolPlus);
      if (isNaN(nom)||isNaN(lo)||isNaN(hi)) return '';
      const min = nom+lo, max=nom+hi;
      const vals = (m.measured||[]).filter(v=>v===0||v).map(Number);
      if (vals.length===0) return '';
      return vals.every(v=>v>=min && v<=max) ? 'PASS' : 'FAIL';
    }

    function buildCard(r, role){
      const head = document.createElement('div');
      head.className='head';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${r.supplier||''}</strong>｜${r.partNo||''}｜${r.drawingNo||''}<br>
        <small>ID：${r.id||''} ｜ 檢驗：${r.inspector||''} ｜ 時間：${r.timestamp?new Date(r.timestamp).toLocaleString():''} ｜ 總結果：<span class="result ${r.overallResult==='PASS'?'pass':'fail'}">${r.overallResult||''}</span></small>`;
      head.appendChild(left);
      const right = document.createElement('div');
      right.innerHTML = `<a class="btn outline" href="print.html?id=${encodeURIComponent(r.id)}">單筆列印</a>`;
      head.appendChild(right);

      const part = document.createElement('div');
      part.innerHTML = `<div class="muted" style="margin-bottom:6px">備註：${(r.notes||'')}</div>`;

      const tbl = document.createElement('table');
      const hasAp = Array.isArray(r.appearance) && r.appearance.some(a => a && (a.result||a.sample));
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>項目 / 尺寸</th><th>名目</th><th>下限公差</th><th>上限公差</th>
        <th>樣品/實測1</th><th>樣品/實測2</th><th>樣品/實測3</th><th>樣品/實測4</th><th>樣品/實測5</th><th>判定</th>
      </tr>`;
      const tbody = document.createElement('tbody');
      if (hasAp){
        const ap = r.appearance||[];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">外觀</td>
          <td></td><td></td><td></td>
          ${[0,1,2,3,4].map(i=>`<td>${ap[i]?(ap[i].result||''):''}</td>`).join('')}
          <td>${ap.length? (ap.every(a=>String(a.result||'').toUpperCase()==='OK')?'PASS':'FAIL') : ''}</td>`;
        tbody.appendChild(tr);
      }
      (r.measurements||[]).forEach(m=>{
        const vals = Array.isArray(m.measured)?m.measured:[];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${m.name||''}</td>
          <td>${m.nominal??''}</td><td>${m.tolMinus??''}</td><td>${m.tolPlus??''}</td>
          ${[0,1,2,3,4].map(i=>`<td>${vals[i]??''}</td>`).join('')}
          <td>${rowJudgement(m)}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody);

      const card = document.createElement('div');
      card.className='card';
      card.appendChild(head);
      card.appendChild(part);
      card.appendChild(tbl);
      return card;
    }

    async function load(){
      tip.textContent='讀取中...';
      listEl.innerHTML='';
      try{
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const r = await fetch('/api/inspections', { headers:{'x-user':u,'x-pass':p,'x-passcode':p} });
        const text = await r.text();
        if (!r.ok) throw new Error(text||('HTTP '+r.status));
        let data = {}; try{ data = JSON.parse(text);}catch{ data = []; }
        let list = listFromJson(data);
        list = dedupById(list);
        // 依時間排序新→舊
        list.sort((a,b)=> String(b.timestamp||'').localeCompare(String(a.timestamp||'')));
        const role = (localStorage.getItem('qci_role')||'').toLowerCase();

        const key = (kw.value||'').trim().toLowerCase();
        if (key){
          list = list.filter(r => (r.supplier||'').toLowerCase().includes(key) ||
                                  (r.partNo||'').toLowerCase().includes(key) ||
                                  (r.drawingNo||'').toLowerCase().includes(key) ||
                                  (r.inspector||'').toLowerCase().includes(key));
        }

        if (!list.length){ tip.textContent='（沒有資料）'; return; }

        const frag = document.createDocumentFragment();
        list.forEach(rec => frag.appendChild(buildCard(rec, role)));
        listEl.appendChild(frag);
        tip.textContent = `共 ${list.length} 筆`;
      }catch(e){
        tip.textContent = '❌ 載入失敗：' + (e.message||e);
      }
    }

    document.getElementById('btnReload').addEventListener('click', load);
    kw.addEventListener('input', load);

    (async () => {
      const ok = await ensureLogin();
      if (ok) load();
    })();
  </script>
</body>
</html>