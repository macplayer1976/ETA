<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品檢報告（安拓）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1100px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media print { .noprint { display: none; } body { padding: 0; } }
    pre { background:#f7f7f7; padding:12px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>品檢報告（安拓）</h2>
    <div class="noprint row">
      <input id="filterText" placeholder="關鍵字（供應商/料號/圖號/檢驗人員）" style="flex:1" />
      <button class="btn" id="btnReload">重新載入</button>
      <button class="btn" id="btnClear">清除關鍵字</button>
      <button class="btn" id="btnReset">重設通關碼</button>
      <button class="btn" id="btnDiag">診斷資料</button>
      <button class="btn" id="btnPrint">列印 / 存成 PDF</button>
      <a class="btn" href="index.html">回現場輸入</a>
    </div>
    <p class="muted noprint">提示：網址加上 <code>?debug=1</code> 可顯示伺服器原始回應；網址加 <code>#resetpass</code> 可清除通關碼。</p>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:18%">基本資訊</th>
          <th style="width:22%">料件資訊</th>
          <th style="width:44%">量測明細</th>
          <th style="width:16%">結果</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="muted"></p>
    <pre id="raw" class="noprint" style="display:none"></pre>
  </div>

  <script>
    // ====== 設定與元素 ======
    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
    const tbody = document.getElementById('tbody');
    const filterText = document.getElementById('filterText');
    const msg = document.getElementById('msg');
    const raw = document.getElementById('raw');

    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { filterText.value = ''; render(); });
    document.getElementById('btnReset').addEventListener('click', () => {
      localStorage.removeItem('qci_passcode');
      alert('通關碼已清除，請重新整理頁面並輸入通關碼。');
    });
    document.getElementById('btnDiag').addEventListener('click', diag);

    filterText.addEventListener('input', render);

    let records = [];

    // 若網址加 #resetpass，自動清通關碼
    if (location.hash === '#resetpass') {
      localStorage.removeItem('qci_passcode');
      history.replaceState(null, '', location.pathname + location.search);
    }

    // 把回傳資料標準化成陣列
    function normalizeRecords(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.record)) return data.record;
      if (data && Array.isArray(data.records)) return data.records;
      if (data && typeof data === 'object') return [data];
      return [];
    }

    // 只接受像樣的紀錄，避免空白列
    function isValidRecord(r) {
      if (!r || typeof r !== 'object') return false;
      const hasId = typeof r.id === 'string' && r.id.trim().length > 0;
      const hasTime = typeof r.timestamp === 'string' && r.timestamp.trim().length > 0;
      const hasAnyInfo = !!(r.supplier || r.partNo || r.drawingNo || r.inspector);
      const hasMeasurements = Array.isArray(r.measurements);
      return hasId && hasTime && hasAnyInfo && hasMeasurements;
    }

    // 載入資料
    async function load() {
      msg.textContent = '載入中...';
      raw.style.display = 'none';
      raw.textContent = '';
      const code = await ensurePasscode();
      try {
        const res = await fetch('/api/inspections', { headers: { 'x-passcode': code } });
        const text = await res.text();

        if (DEBUG) {
          raw.style.display = 'block';
          raw.textContent = '原始回應（前 1000 字）:\\n' + (text || '').slice(0, 1000);
        }

        if (!res.ok) throw new Error(`HTTP ${res.status}：${text || '（無訊息）'}`);

        let data = {};
        try { data = JSON.parse(text); } catch (e) { data = text; }

        let list = normalizeRecords(data);
        if (!Array.isArray(list)) list = [];

        const before = list.length;
        list = list.filter(isValidRecord);
        const dropped = before - list.length;

        // 依時間新到舊
        list.sort((a,b) => (b.timestamp || '').localeCompare(a.timestamp || ''));

        records = list;
        render();

        if (records.length === 0) {
          msg.textContent = '目前沒有可顯示的資料。請回現場輸入頁新增一筆，或按「診斷資料」檢查雲端狀態。' + (dropped>0?`（已忽略 ${dropped} 筆格式不完整的舊資料）`:'');
        } else if (dropped > 0) {
          msg.textContent = `共 ${records.length} 筆（已忽略 ${dropped} 筆格式不完整的舊資料）。可用關鍵字快速過濾。`;
        } else {
          msg.textContent = `共 ${records.length} 筆。可用關鍵字快速過濾。`;
        }
      } catch (e) {
        msg.textContent = '❌ 載入失敗：' + e.message;
      }
    }

    // 畫面渲染
    function render() {
      const source = Array.isArray(records) ? records : [];
      const kw = (filterText.value || '').toLowerCase();

      const filtered = source.filter(r => {
        const text = [ r.inspector, r.supplier, r.partNo, r.drawingNo, r.revision, r.notes ]
          .filter(Boolean).join(' ').toLowerCase();
        return text.includes(kw);
      });

      tbody.innerHTML = '';
      for (const r of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div><strong>ID：</strong>${escapeHtml(r.id || '')}</div>
            <div><strong>時間：</strong>${escapeHtml(formatTime(r.timestamp))}</div>
            <div><strong>人員：</strong>${escapeHtml(r.inspector || '')}</div>
            <div><strong>供應商：</strong>${escapeHtml(r.supplier || '')}</div>
          </td>
          <td>
            <div><strong>料號：</strong>${escapeHtml(r.partNo || '')}</div>
            <div><strong>圖號：</strong>${escapeHtml(r.drawingNo || '')}</div>
            <div><strong>版次：</strong>${escapeHtml(r.revision || '')}</div>
            <div><strong>備註：</strong>${escapeHtml(r.notes || '')}</div>
          </td>
          <td>${buildMeasurements(r.measurements || [])}</td>
          <td><strong>${r.overallResult === 'PASS' ? '✅ PASS' : '❌ FAIL'}</strong></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function buildMeasurements(list) {
      if (!list.length) return '(無)';
      const rows = list.map(m => `
        <tr>
          <td>${escapeHtml(m.name)}</td>
          <td>${num(m.nominal)}</td>
          <td>${num(m.tolMinus)}</td>
          <td>${num(m.tolPlus)}</td>
          <td>${num(m.measured)}</td>
          <td>${num(m.deviation)}</td>
          <td>${m.pass ? 'PASS' : 'FAIL'}</td>
        </tr>
      `).join('');
      return `
        <table>
          <thead>
            <tr>
              <th>尺寸</th><th>名目</th><th>下限公差</th><th>上限公差</th>
              <th>實測</th><th>偏差</th><th>判定</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // 小工具
    function num(v){ return (v===0 || v) ? Number(v).toFixed(3) : ''; }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]);
      });
    }
    function formatTime(iso){ if(!iso) return ''; try{ const d=new Date(iso); return d.toLocaleString(); }catch{ return iso; } }

    async function ensurePasscode() {
      let code = localStorage.getItem('qci_passcode') || '';
      if (!code) {
        code = prompt('請輸入通關碼（與現場輸入相同）') || '';
        localStorage.setItem('qci_passcode', code);
      }
      return code;
    }

    async function diag() {
      const code = await ensurePasscode();
      try {
        const r = await fetch('/api/inspections?diag=1', { headers: { 'x-passcode': code }});
        const t = await r.text();
        raw.style.display = 'block';
        raw.textContent = '診斷結果：\\n' + t;
      } catch (e) {
        raw.style.display = 'block';
        raw.textContent = '診斷失敗：' + e.message;
      }
    }

    // 初始載入
    load();
  </script>
</body>
</html>
