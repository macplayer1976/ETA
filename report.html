<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品檢報告</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1120px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn-outline { background: #f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-gray { background:#111827; color:#fff; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media print { .noprint { display: none; } body { padding: 0; } }
    pre { background:#f7f7f7; padding:12px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>品檢報告</h2>
    <div class="noprint row">
      <input id="filterText" placeholder="關鍵字（供應商/料號/圖號/檢驗人員）" style="flex:1" />
      <button class="btn" id="btnReload">重新載入</button>
      <button class="btn btn-outline" id="btnClear">清除關鍵字</button>
      <button class="btn btn-outline" id="btnReset">重設帳號</button>
      <button class="btn btn-outline" id="btnDiag">診斷資料</button>
      <button class="btn" id="btnPrint">列印 / 存成 PDF</button>
      <a class="btn" href="index.html">回現場輸入</a>
    </div>
    <p class="muted noprint">提示：網址加上 <code>?debug=1</code> 可顯示伺服器原始回應；網址加 <code>#resetpass</code> 可清除通關碼。</p>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:18%">基本資訊</th>
          <th style="width:22%">料件資訊</th>
          <th style="width:48%">外觀與量測明細</th>
          <th style="width:12%">結果</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="muted"></p>
    <pre id="raw" class="noprint" style="display:none"></pre>
  </div>

  <script>
    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
    const tbody = document.getElementById('tbody');
    const filterText = document.getElementById('filterText');
    const msg = document.getElementById('msg');
    const raw = document.getElementById('raw');

    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { filterText.value = ''; render(); });
    document.getElementById('btnReset').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      alert('本機登入資訊已清除。請重新整理頁面登入。');
    });
    document.getElementById('btnDiag').addEventListener('click', diag);
    filterText.addEventListener('input', render);

    if (location.hash === '#resetpass') {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      history.replaceState(null, '', location.pathname + location.search);
    }

    let records = [];

    async function ensureAuth() {
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      if (!user || !pass) {
        const u = prompt('請輸入帳號（檢驗人員）') || '';
        const p = prompt('請輸入密碼（通關碼/密碼）') || '';
        if (!u || !p) return { ok:false };
        localStorage.setItem('qci_user', u);
        localStorage.setItem('qci_pass', p);
      }
      try {
        const u2 = localStorage.getItem('qci_user') || '';
        const p2 = localStorage.getItem('qci_pass') || '';
        const res = await fetch('/api/inspections?auth=1', { headers: { 'x-user': u2, 'x-pass': p2, 'x-passcode': p2 } });
        const t = await res.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        if (!res.ok || !j.ok) return { ok:false };
        const role = (j.role||'').toLowerCase();
        if (!['admin','viewer'].includes(role)) return { ok:false, msg:'您的帳號沒有檢視報告的權限（input）' };
        return { ok:true };
      } catch { return { ok:false }; }
    }

    async function load(){
      msg.textContent = '驗證中...';
      const auth = await ensureAuth();
      if (!auth.ok){ msg.textContent = auth.msg || '❌ 請重新登入（帳號/密碼）'; return; }

      msg.textContent = '載入中...';
      raw.style.display = 'none'; raw.textContent = '';
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      try{
        const res = await fetch('/api/inspections', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }});
        const text = await res.text();
        if (DEBUG){ raw.style.display='block'; raw.textContent = '原始回應（前 1000 字）：\n' + (text||'').slice(0,1000); }
        if (!res.ok) throw new Error(`HTTP ${res.status}：${text || '（無訊息）'}`);

        let data={}; try{ data = JSON.parse(text);}catch{ data = text; }
        let list = listFromJson(data).filter(isValidRecord);
        // 最新在上
        list.sort((a,b) => String(b.timestamp||'').localeCompare(String(a.timestamp||'')));
        records = list;
        render();
        msg.textContent = records.length ? `共 ${records.length} 筆。` : '目前沒有可顯示的資料。';
      }catch(e){
        msg.textContent = '❌ 載入失敗：' + (e.message||e);
      }
    }

    function render(){
      const kw = (filterText.value || '').toLowerCase();
      const filtered = records.filter(r => {
        const text = [ r.inspector, r.supplier, r.partNo, r.drawingNo, r.notes, r.processLabel ].filter(Boolean).join(' ').toLowerCase();
        return text.includes(kw);
      });
      tbody.innerHTML = '';
      for (const r of filtered){
        const apBlock = buildAppearance(r.appearance || []);
        const msBlock = buildMeasurements(r.measurements || []);
        const details = apBlock ? (apBlock + '<div style="height:6px"></div>' + msBlock) : msBlock;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div><strong>ID：</strong>${escapeHtml(r.id||'')}</div>
            <div><strong>時間：</strong>${escapeHtml(formatTime(r.timestamp))}</div>
            <div><strong>人員：</strong>${escapeHtml(r.inspector||'')}</div>
            <div><strong>供應商：</strong>${escapeHtml(r.supplier||'')}</div>
          </td>
          <td>
            <div><strong>料號：</strong>${escapeHtml(r.partNo||'')}</div>
            <div><strong>圖號：</strong>${escapeHtml(r.drawingNo||'')}</div>
            <div><strong>製程：</strong>${escapeHtml(r.processLabel || r.process || '')}</div>
            <div><strong>備註：</strong>${escapeHtml(r.notes||'')}</div>
          </td>
          <td>${details}</td>
          <td>
            <div><strong>${r.overallResult==='PASS' ? '✅ PASS' : '❌ FAIL'}</strong></div>
            <div class="noprint" style="margin-top:6px">
              <a class="btn btn-gray" target="_blank" href="print.html?id=${encodeURIComponent(r.id)}">單筆列印</a>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ----- blocks -----
    function buildAppearance(list){
      if (!Array.isArray(list) || list.length===0) return '';
      const rows = list.map(a => \`<tr><td>\${escapeHtml(a.sample||'')}</td><td>\${escapeHtml(a.result||'')}</td></tr>\`).join('');
      return \`
        <table>
          <thead><tr><th>外觀樣品</th><th>結果</th></tr></thead>
          <tbody>\${rows}</tbody>
        </table>\`;
    }
    function buildMeasurements(list){
      if (!list.length) return '(無尺寸資料)';
      const rows = list.map(m => {
        const arr = Array.isArray(m.measured) ? m.measured
                 : ((typeof m.measured === 'number') || (typeof m.measured === 'string' && m.measured!=='')) ? [m.measured] : [];
        const cells = [0,1,2,3,4].map(i => num(arr[i]));
        const judge = (m.pass===''? '' : (m.pass ? 'PASS' : 'FAIL'));
        return \`
          <tr>
            <td>\${escapeHtml(m.name||'')}</td>
            <td>\${num(m.nominal)}</td>
            <td>\${num(m.tolMinus)}</td>
            <td>\${num(m.tolPlus)}</td>
            <td>\${cells[0]}</td>
            <td>\${cells[1]}</td>
            <td>\${cells[2]}</td>
            <td>\${cells[3]}</td>
            <td>\${cells[4]}</td>
            <td>\${judge}</td>
          </tr>\`;
      }).join('');
      return \`
        <table>
          <thead>
            <tr>
              <th>尺寸</th><th>名目</th><th>下限公差</th><th>上限公差</th>
              <th>實測1</th><th>實測2</th><th>實測3</th><th>實測4</th><th>實測5</th>
              <th>判定</th>
            </tr>
          </thead>
          <tbody>\${rows}</tbody>
        </table>\`;
    }

    // ----- helpers -----
    function listFromJson(x){
      if (!x) return [];
      if (Array.isArray(x)) return x.flatMap(listFromJson).filter(Boolean);
      if (looksLikeRecord(x)) return [x];
      if (typeof x === 'object'){
        if (x.data) return listFromJson(x.data);
        if (x.record !== undefined) return listFromJson(x.record);
        if (x.records !== undefined) return listFromJson(x.records);
      }
      return [];
    }
    function looksLikeRecord(o){
      return o && typeof o==='object'
        && typeof o.id==='string'
        && typeof o.timestamp==='string'
        && Array.isArray(o.measurements);
    }
    function isValidRecord(r){ return looksLikeRecord(r) && !!(r.supplier || r.partNo || r.drawingNo || r.inspector); }
    function num(v){ return (v===0 || v) ? Number(v).toFixed(3) : ''; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
    function formatTime(iso){ if(!iso) return ''; try{ const d=new Date(iso); return d.toLocaleString(); }catch{ return iso; } }

    async function diag(){
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      const r = await fetch('/api/inspections?diag=1', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }});
      const t = await r.text();
      raw.style.display='block'; raw.textContent = '診斷結果：\n' + t;
    }

    load();
  </script>
</body>
</html>
