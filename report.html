<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="reportTitle">品檢報告（安拓）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1160px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input { padding:8px; border:1px solid #ccc; border-radius:8px; flex:1 }
    .btn { padding:10px 14px; border:none; border-radius:10px; background:#2563eb; color:#fff; cursor:pointer; }
    .btn-outline { background:#f3f4f6; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    a.btn { text-decoration:none; display:inline-block; }
    .mini th, .mini td { font-size:12px; padding:6px; }
    @media print { .noprint { display: none; } body { padding: 0; } }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="reportTitle">品檢報告（安拓）</h2>
    <p class="noprint" style="color:#666">ANCHOR FASTENERS INDUSTRIAL CO., LTD.</p>
    <div class="noprint row">
      <input id="filterText" placeholder="關鍵字（供應商/料號/圖號/檢驗人員）" />
      <button class="btn" id="btnReload" data-i18n="btnReload">重新載入</button>
      <button class="btn btn-outline" id="btnClear" data-i18n="btnClear">清除</button>
      <a class="btn btn-outline" href="index.html" data-i18n="btnBack">回現場輸入</a>
      <button class="btn btn-outline" id="btnLang">🌐</button>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:21%" data-i18n="thBasic">基本資訊</th>
          <th style="width:27%" data-i18n="thPart">料件資訊</th>
          <th style="width:36%" data-i18n="thUnified">外觀與量測明細</th>
          <th style="width:16%" data-i18n="thOps">操作</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p id="msg" class="noprint" style="color:#666"></p>
  </div>

  <!-- Language modal -->
  <div id="langModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; border-radius:12px; padding:16px; width:min(92vw,420px)">
      <h3 data-i18n="langTitle">選擇語言</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
        <button onclick="selectLang('zh-TW')">繁體中文</button>
        <button onclick="selectLang('zh-CN')">简体中文</button>
        <button onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

<script>
const I18N = {
  'zh-TW': {
    reportTitle:'品檢報告（安拓）', btnReload:'重新載入', btnClear:'清除', btnBack:'回現場輸入',
    thBasic:'基本資訊', thPart:'料件資訊', thUnified:'外觀與量測明細', thOps:'操作',
    labelID:'ID：', labelTime:'時間：', labelInspector:'人員：',
    labelSupplier:'供應商：', labelOrder:'訂單號碼：', labelLot:'生產批號：', labelPartNo:'產品料號：', labelDrawingNo:'圖號：',
    labelMaterial:'材質：', labelSpec:'規格：', labelProductType:'產品類別：', labelProcess:'製程：', labelNotes:'備註：',
    btnPrintOne:'單筆列印', btnDelete:'刪除', langTitle:'選擇語言',
    theadItem:'項目/尺寸', theadNom:'名目', theadLo:'下限', theadHi:'上限', theadM1:'實測1', theadM2:'實測2', theadM3:'實測3', theadM4:'實測4', theadM5:'實測5', theadDecision:'判定',
    appearance:'外觀'
  },
  'zh-CN': {
    reportTitle:'品检报告（安拓）', btnReload:'重新载入', btnClear:'清除', btnBack:'回现场输入',
    thBasic:'基本信息', thPart:'料件信息', thUnified:'外观与量测明细', thOps:'操作',
    labelID:'ID：', labelTime:'时间：', labelInspector:'人员：',
    labelSupplier:'供应商：', labelOrder:'订单号码：', labelLot:'生产批号：', labelPartNo:'产品料号：', labelDrawingNo:'图号：',
    labelMaterial:'材质：', labelSpec:'规格：', labelProductType:'产品类别：', labelProcess:'制程：', labelNotes:'备注：',
    btnPrintOne:'单笔打印', btnDelete:'删除', langTitle:'选择语言',
    theadItem:'项目/尺寸', theadNom:'名义', theadLo:'下限', theadHi:'上限', theadM1:'实测1', theadM2:'实测2', theadM3:'实测3', theadM4:'实测4', theadM5:'实测5', theadDecision:'判定',
    appearance:'外观'
  },
  'en': {
    reportTitle:'QC Reports (Anchor)', btnReload:'Reload', btnClear:'Clear', btnBack:'Back to Input',
    thBasic:'Basic Info', thPart:'Part Info', thUnified:'Appearance & Measurements', thOps:'Actions',
    labelID:'ID: ', labelTime:'Time: ', labelInspector:'Inspector: ',
    labelSupplier:'Supplier: ', labelOrder:'Order No.: ', labelLot:'Lot No.: ', labelPartNo:'Part No.: ', labelDrawingNo:'Drawing No.: ',
    labelMaterial:'Material: ', labelSpec:'Spec: ', labelProductType:'Product Category: ', labelProcess:'Process: ', labelNotes:'Notes: ',
    btnPrintOne:'Print single', btnDelete:'Delete', langTitle:'Choose language',
    theadItem:'Item/Dim.', theadNom:'Nominal', theadLo:'Lower', theadHi:'Upper', theadM1:'Sample1', theadM2:'Sample2', theadM3:'Sample3', theadM4:'Sample4', theadM5:'Sample5', theadDecision:'Decision',
    appearance:'Appearance'
  }
};
function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
function setLang(x){ localStorage.setItem('qci_lang', x); applyI18n(); render(); }
function selectLang(x){ setLang(x); document.getElementById('langModal').style.display='none'; }
function t(k){ const d = I18N[getLang()] || I18N['zh-TW']; return d[k] ?? (I18N['zh-TW'][k] ?? k); }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); el.innerHTML=t(k); });
  const titleEl = document.querySelector('title[data-i18n="reportTitle"]'); if (titleEl) titleEl.textContent = t('reportTitle');
}
document.getElementById('btnLang').addEventListener('click', ()=> document.getElementById('langModal').style.display='flex');

const tbody = document.getElementById('tbody'); const msg = document.getElementById('msg');
document.getElementById('btnReload').addEventListener('click', load);
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('filterText').value=''; render(); });
document.getElementById('filterText').addEventListener('input', render);

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
function num(v){ return (v===0||v) ? Number(v).toFixed(3) : ''; }

let records = [];
function listFromJson(data){
  if (!data) return [];
  if (Array.isArray(data)) return data;
  if (data.record) return listFromJson(data.record);
  if (data.records) return listFromJson(data.records);
  if (data.id && data.timestamp) return [data];
  return [];
}

async function load(){
  applyI18n(); msg.textContent='Loading...';
  try{
    const u = localStorage.getItem('qci_user')||'';
    const p = localStorage.getItem('qci_pass')||'';
    const res = await fetch('/api/inspections', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
    const text = await res.text(); let data={}; try{ data=JSON.parse(text);}catch{ data=text; }
    records = listFromJson(data).filter(r => r && Array.isArray(r.measurements));
    records.sort((a,b)=>(b.timestamp||'').localeCompare(a.timestamp||''));
    render(); msg.textContent = `共 ${records.length} 筆`;
  }catch(e){ msg.textContent = '載入失敗：'+(e.message||e); }
}

function buildUnifiedTable(r){
  const th = `<thead><tr>
    <th>${t('theadItem')}</th><th>${t('theadNom')}</th><th>${t('theadLo')}</th><th>${t('theadHi')}</th>
    <th>${t('theadM1')}</th><th>${t('theadM2')}</th><th>${t('theadM3')}</th><th>${t('theadM4')}</th><th>${t('theadM5')}</th><th>${t('theadDecision')}</th>
  </tr></thead>`;

  const apMap = {};
  if (Array.isArray(r.appearance)){
    for (const a of r.appearance){
      const m = String(a.sample||'').match(/(\d+)/);
      const idx = m ? Number(m[1]) : null;
      if (idx && idx>=1 && idx<=5){
        apMap[idx] = String(a.result||'').toUpperCase().startsWith('OK') ? (getLang()==='en'?'OK':'O.K') : 'NG';
      }
    }
  }
  const apRow = Object.keys(apMap).length ? `<tr>
    <td><strong>${t('appearance')}</strong></td><td></td><td></td><td></td>
    <td>${escapeHtml(apMap[1]||'')}</td><td>${escapeHtml(apMap[2]||'')}</td><td>${escapeHtml(apMap[3]||'')}</td><td>${escapeHtml(apMap[4]||'')}</td><td>${escapeHtml(apMap[5]||'')}</td>
    <td>${Object.values(apMap).every(v=>v==='OK'||v==='O.K')?'PASS':'FAIL'}</td>
  </tr>` : '';

  const rows = (Array.isArray(r.measurements)?r.measurements:[]).map(m=>{
    const arr = Array.isArray(m.measured) ? m.measured : ((m.measured===0||m.measured)?[m.measured]:[]);
    const vals = [0,1,2,3,4].map(i => num(arr[i]));
    // 判定
    let dec=''; 
    if ((m.nominal===0||m.nominal) && (m.tolMinus===0||m.tolMinus) && (m.tolPlus===0||m.tolPlus) && arr.length){
      const min = Number(m.nominal)+Number(m.tolMinus), max = Number(m.nominal)+Number(m.tolPlus);
      const ok = arr.filter(v=>v===0||v).map(Number).every(v => v>=min && v<=max);
      dec = ok?'PASS':'FAIL';
    }
    return `<tr><td>${escapeHtml(m.name||'')}</td>
      <td>${num(m.nominal)}</td><td>${num(m.tolMinus)}</td><td>${num(m.tolPlus)}</td>
      <td>${vals[0]}</td><td>${vals[1]}</td><td>${vals[2]}</td><td>${vals[3]}</td><td>${vals[4]}</td><td>${dec}</td></tr>`;
  }).join('');

  return `<table class="mini">${th}<tbody>${apRow}${rows}</tbody></table>`;
}

function render(){
  const kw = (document.getElementById('filterText').value||'').toLowerCase();
  tbody.innerHTML = records.filter(r=>{
    const hay = [r.supplier,r.partNo,r.drawingNo,r.inspector,r.orderNo,r.lotNo].join(' ').toLowerCase();
    return !kw || hay.includes(kw);
  }).map(r=>{
    return `<tr>
      <td>
        <div>${t('labelID')}${escapeHtml(r.id||'')}</div>
        <div>${t('labelTime')}${escapeHtml(r.timestamp||'')}</div>
        <div>${t('labelInspector')}${escapeHtml(r.inspector||'')}</div>
      </td>
      <td>
        <div>${t('labelSupplier')}${escapeHtml(r.supplier||'')}</div>
        <div>${t('labelOrder')}${escapeHtml(r.orderNo||'')}</div>
        <div>${t('labelLot')}${escapeHtml(r.lotNo||'')}</div>
        <div>${t('labelPartNo')}${escapeHtml(r.partNo||'')}</div>
        <div>${t('labelDrawingNo')}${escapeHtml(r.drawingNo||'')}</div>
        <div>${t('labelMaterial')}${escapeHtml(r.material||'')}</div>
        <div>${t('labelSpec')}${escapeHtml(r.spec||'')}</div>
        <div>${t('labelProductType')}${escapeHtml(r.productType||'')}</div>
        <div>${t('labelProcess')}${escapeHtml(r.process||'')}</div>
        <div>${t('labelNotes')}${escapeHtml(r.notes||'')}</div>
      </td>
      <td>${buildUnifiedTable(r)}</td>
      <td>
        <a class="btn" href="print.html?id=${encodeURIComponent(r.id||'')}" target="_blank">${t('btnPrintOne')}</a>
      </td>
    </tr>`;
  }).join('');
}

load();
</script>
</body>
</html>
