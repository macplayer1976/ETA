<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>安拓｜QC 輸入</title><style>
*{box-sizing:border-box}body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:#f8fafc;color:#111}.wrap{max-width:1024px;margin:0 auto;padding:16px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}h1{margin:0 0 8px 0;font-size:20px}label{font-size:13px;color:#374151}input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}th{background:#f3f4f6}.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}.muted{color:#6b7280;font-size:12px}.btn{padding:10px 14px;border:none;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer}.btn.secondary{background:#e5e7eb;color:#111}.toolbar{display:flex;gap:8px;align-items:center;margin:8px 0}.noprint{display:block}.hidden{display:none!important}.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}.panel{background:#fff;border-radius:14px;padding:16px;width:360px;box-shadow:0 10px 25px rgba(0,0,0,.15)}.lang-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}.lang-btn{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;cursor:pointer}.lang-btn:hover{background:#eef2ff}
</style></head><body><div class="wrap">
<div class="card" id="loginCard"><h1>登入</h1><div class="row"><div><label>帳號</label><input id="loginUser" autocomplete="username"/></div><div><label>密碼</label><input id="loginPass" type="password" autocomplete="current-password"/></div></div><div class="toolbar"><button class="btn" id="btnLogin">登入</button><span class="muted" id="loginMsg"></span></div></div>

<div class="card hidden" id="mainCard">
  <h1>QC 輸入（安拓）</h1>
  <div class="toolbar">
    <button class="btn secondary" id="btnLang">🌐 語言</button>
    <span class="muted" id="roleTip"></span>
  </div>

  <div class="row3">
    <div><label>供應商 Supplier</label>
      <select id="supplier">
        <!-- 依需求：下拉可增加，見最下方 SUPPLIERS 說明 -->
      </select>
      <div class="muted" id="supplierEn"></div>
    </div>
    <div><label>料號 Part No.</label><input id="partNo"/></div>
    <div><label>圖號 Drawing No.</label><input id="drawingNo"/></div>
  </div>
  <div class="row3" style="margin-top:8px">
    <div><label>版次 Revision</label><input id="revision"/></div>
    <div><label>檢驗製程 Process</label>
      <select id="process">
        <option value="">--</option>
        <option>線材 (WIRE)</option>
        <option>成形 (FORMING)</option>
        <option>攻牙 (TAPING)</option>
        <option>割溝 (CUTTING)</option>
        <option>電鍍 (PLATING)</option>
        <option>成品 (FINISHED)</option>
        <option>組立 (ASSEMBLY)</option>
        <option>最終成品 (FINAL FINISHED)</option>
      </select>
    </div>
    <div><label>備註 Notes</label><input id="notes"/></div>
  </div>

  <div style="margin-top:12px"><strong>外觀與尺寸明細</strong>（第 1 列＝外觀；第 2 列起＝尺寸）</div>
  <table id="tbl">
    <thead><tr>
      <th>項目/尺寸</th><th>名目</th><th>下限公差</th><th>上限公差</th>
      <th>樣品/實測1</th><th>樣品/實測2</th><th>樣品/實測3</th><th>樣品/實測4</th><th>樣品/實測5</th><th>判定</th><th class="noprint">操作</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="toolbar">
    <button class="btn secondary" id="btnAdd">+ 新增尺寸列</button>
    <button class="btn" id="btnSave">儲存至雲端</button>
    <a class="btn secondary" href="report.html">查看/列印</a>
    <span class="muted" id="saveMsg"></span>
  </div>
</div>
</div>

<!-- 語言選擇 -->
<div id="langModal" class="modal hidden"><div class="panel">
  <h3>選擇語言</h3><div class="lang-grid">
    <button class="lang-btn" data-lang="zh-Hant">繁體</button>
    <button class="lang-btn" data-lang="zh-Hans">简体</button>
    <button class="lang-btn" data-lang="en">English</button>
  </div>
</div></div>

<script>
/* ====== 基本與登入 ====== */
const SUPPLIERS=[{id:"安拓",label:"安拓 (Anchor)",en:"Anchor"},{id:"安可",label:"安可 (AKF)",en:"AKF"}];
const loginCard=document.getElementById('loginCard'),mainCard=document.getElementById('mainCard');
const loginUser=document.getElementById('loginUser'),loginPass=document.getElementById('loginPass'),loginMsg=document.getElementById('loginMsg');
const roleTip=document.getElementById('roleTip'); let ROLE=""; let USER="";
function fillSupplierSelect(){const s=document.getElementById('supplier'); s.innerHTML=SUPPLIERS.map(x=>`<option value="${x.id}">${x.label}</option>`).join(''); onSupplierChange(); }
function onSupplierChange(){const id=document.getElementById('supplier').value; const f=SUPPLIERS.find(x=>x.id===id); document.getElementById('supplierEn').textContent=f?`English: ${f.en}`:"";}
document.getElementById('supplier').addEventListener('change',onSupplierChange);

async function authCheck(u,p){try{const r=await fetch('/api/inspections?auth=1',{headers:{'x-user':u,'x-pass':p,'x-passcode':p}});const t=await r.text();let j={};try{j=JSON.parse(t)}catch{}if(!r.ok||!j.ok){loginMsg.innerHTML=`❌ 登入失敗（HTTP ${r.status}）${j.error?`：${j.error}`:""}`;return{ok:!1}}return{ok:!0,role:(j.role||'admin')}}catch(e){loginMsg.textContent='❌ 連線錯誤：'+e;return{ok:!1}}}
document.getElementById('btnLogin').onclick=async()=>{const u=loginUser.value.trim(),p=loginPass.value.trim(); if(!u||!p){loginMsg.textContent='請輸入帳號與密碼';return;} loginMsg.textContent='驗證中...'; const info=await authCheck(u,p); if(!info.ok)return; ROLE=info.role; USER=u; localStorage.setItem('qci_user',u);localStorage.setItem('qci_pass',p);localStorage.setItem('qci_role',ROLE);localStorage.setItem('qci_inspector',u);localStorage.setItem('qci_passcode',p); openLang();};
window.addEventListener('DOMContentLoaded',async()=>{fillSupplierSelect(); const u=localStorage.getItem('qci_user')||"",p=localStorage.getItem('qci_pass')||""; if(u&&p){loginMsg.textContent='自動驗證中...';const info=await authCheck(u,p); if(info.ok){ROLE=info.role;USER=u; showMain();} else loginMsg.innerHTML='❌ 帳號或密碼已變更，請重新登入。';}});

function showMain(){loginCard.classList.add('hidden'); mainCard.classList.remove('hidden'); roleTip.textContent=`目前角色：${ROLE}`; if(ROLE==='viewer'){document.getElementById('btnAdd').disabled=true;document.getElementById('btnSave').disabled=true;document.querySelectorAll('input,select,textarea').forEach(el=>el.disabled=true);} ensureAppearanceRow(); if(countMeasureRows()===0) addMeasureRow();}

/* ====== 語言 ====== */
const langModal=document.getElementById('langModal'); document.getElementById('btnLang').onclick=()=>langModal.classList.remove('hidden');
langModal.addEventListener('click',e=>{if(e.target.classList.contains('lang-btn')){localStorage.setItem('qci_lang',e.target.dataset.lang);langModal.classList.add('hidden');applyI18n();if(loginCard.classList.contains('hidden')===!1){} else showMain();}else if(e.target===langModal){langModal.classList.add('hidden')}}); 
function openLang(){ if(localStorage.getItem('qci_lang')){applyI18n();showMain();} else {langModal.classList.remove('hidden');}}
function applyI18n(){/* 此處如需更多多語，可擴充；頁面主要為中文 UI，略過詳列 */}

/* ====== 明細表（第1列=外觀，可空白；第2列起=尺寸） ====== */
const tbody=document.getElementById('tbody');
function ensureAppearanceRow(){ if(tbody.querySelector('tr[data-kind="appearance"]'))return; const tr=document.createElement('tr'); tr.dataset.kind='appearance'; tr.innerHTML=`
  <td><strong>外觀</strong></td><td></td><td></td><td></td>
  <td>${apSel()}</td><td>${apSel()}</td><td>${apSel()}</td><td>${apSel()}</td><td>${apSel()}</td>
  <td class="ap-judge"></td><td class="noprint"><button class="btn secondary" onclick="clearAppearance(this)">清空</button></td>`; tbody.appendChild(tr); updateAppearanceJudge();}
function apSel(){return `<select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select>`}
function clearAppearance(btn){btn.closest('tr').querySelectorAll('select.ap').forEach(s=>s.value=""); updateAppearanceJudge();}
tbody.addEventListener('change',e=>{if(e.target.classList.contains('ap'))updateAppearanceJudge(); if(e.target.classList.contains('mcell')) updateRowJudge(e.target.closest('tr'));});
function updateAppearanceJudge(){const tr=tbody.querySelector('tr[data-kind="appearance"]'); if(!tr)return; const vals=[...tr.querySelectorAll('select.ap')].map(s=>s.value); const has=vals.some(v=>v); tr.querySelector('.ap-judge').textContent=has?(vals.every(v=>v==='OK')?'PASS':'FAIL'):"";}
function countMeasureRows(){return tbody.querySelectorAll('tr[data-kind="measure"]').length}
function addMeasureRow(){const tr=document.createElement('tr'); tr.dataset.kind='measure'; tr.innerHTML=`
  <td><input class="name" placeholder="尺寸代號/說明"></td>
  <td><input class="nom" type="number" step="0.001"></td>
  <td><input class="lo" type="number" step="0.001"></td>
  <td><input class="hi" type="number" step="0.001"></td>
  <td><input class="mcell" type="number" step="0.001"></td>
  <td><input class="mcell" type="number" step="0.001"></td>
  <td><input class="mcell" type="number" step="0.001"></td>
  <td><input class="mcell" type="number" step="0.001"></td>
  <td><input class="mcell" type="number" step="0.001"></td>
  <td class="judge"></td>
  <td class="noprint"><button class="btn secondary" onclick="delRow(this)">刪除</button></td>`; tbody.appendChild(tr);}
function delRow(btn){btn.closest('tr').remove();}
document.getElementById('btnAdd').onclick=()=>addMeasureRow();

function updateRowJudge(tr){const nom=n(tr.querySelector('.nom')),lo=n(tr.querySelector('.lo')),hi=n(tr.querySelector('.hi')); const ms=[...tr.querySelectorAll('.mcell')].map(i=>i.value===""?null:Number(i.value)); if([nom,lo,hi].some(v=>Number.isNaN(v))) {tr.querySelector('.judge').textContent="";return;} const min=nom+lo,max=nom+hi; const ok=ms.filter(v=>v!==null).every(v=>v>=min&&v<=max); tr.querySelector('.judge').textContent=ms.some(v=>v!==null)?(ok?'PASS':'FAIL'):"";}
function n(x){return x&&x.value!==""?Number(x.value):NaN}

/* ====== 儲存 ====== */
document.getElementById('btnSave').onclick=save;
async function save(){if(ROLE==='viewer'){alert('viewer 無法儲存');return;} const supplier=document.getElementById('supplier').value, partNo=document.getElementById('partNo').value.trim(), drawingNo=document.getElementById('drawingNo').value.trim(), revision=document.getElementById('revision').value.trim(), notes=document.getElementById('notes').value.trim(), process=document.getElementById('process').value;
  const apTr=tbody.querySelector('tr[data-kind="appearance"]'); let appearance=[]; if(apTr){const sel=[...apTr.querySelectorAll('select.ap')]; if(sel.some(s=>s.value)){appearance=sel.map((s,i)=>({sample:`樣品${i+1}`,result:s.value||"",note:""}));}}
  const ms=[...tbody.querySelectorAll('tr[data-kind="measure"]')].map(tr=>{const m=[...tr.querySelectorAll('.mcell')].map(i=>i.value===""?null:Number(i.value)); const nom=n(tr.querySelector('.nom')),lo=n(tr.querySelector('.lo')),hi=n(tr.querySelector('.hi')); const min=nom+lo,max=nom+hi; const has=m.some(v=>v!==null); const pass=has?m.filter(v=>v!==null).every(v=>v>=min&&v<=max):""; return {name:tr.querySelector('.name').value.trim(),nominal:isNaN(nom)?null:nom,tolMinus:isNaN(lo)?null:lo,tolPlus:isNaN(hi)?null:hi,measured:m,pass:pass!==""?!!pass:""};});
  const overall=(()=>{
    const apOk=appearance.length?appearance.every(a=>(a.result||"").toUpperCase()==='OK'):true;
    const mOk=ms.length?ms.every(x=>x.pass!==""?!!x.pass:true):true;
    return apOk&&mOk?'PASS':'FAIL';
  })();
  const body={inspector:USER,supplier,partNo,drawingNo,revision,process,notes,appearance,measurements:ms,overallResult:overall};
  const user=localStorage.getItem('qci_user')||"",pass=localStorage.getItem('qci_pass')||"";
  document.getElementById('saveMsg').textContent='上傳中...';
  try{const r=await fetch('/api/inspections',{method:'POST',headers:{'Content-Type':'application/json','x-user':user,'x-pass':pass,'x-passcode':pass},body:JSON.stringify(body)});const t=await r.text();let j={};try{j=JSON.parse(t)}catch{} if(!r.ok||!j.ok) throw new Error(t||('HTTP '+r.status)); document.getElementById('saveMsg').textContent='✅ 已儲存，ID：'+j.id;}catch(e){document.getElementById('saveMsg').textContent='❌ 儲存失敗：'+(e.message||e);}}
</script>
</body></html>
