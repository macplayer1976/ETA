<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title">ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; background:#fafafa; }
    .card { max-width: 1120px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h2 { margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pass { background: #e7f7ec; color: #116329; }
    .fail { background: #fde8e8; color: #c02020; }
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }
    .btn-ghost { background: #f3f4f6; color:#111827; }
    .muted { color: #6b7280; font-size: 13px; }
    .error { color: #b91c1c; }
    .hidden { display: none; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    a.btn { text-decoration: none; display:inline-block; }
    .hint { margin: 6px 0 0; color:#6b7280; font-size:13px; }
    td.disabled input { background:#fafafa; color:#9ca3af; }
    /* èªè¨€é¸æ“‡å½ˆçª— */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:12px; padding:16px; width: min(92vw, 420px); box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal h3 { margin:0 0 8px 0; }
    .modal .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="title">ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰</h2>

    <!-- ç™»å…¥å€ -->
    <div id="loginView">
      <p class="muted" data-i18n="loginPrompt">è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚</p>
      <div class="row">
        <div>
          <label data-i18n="labelAccount">å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰</label>
          <input id="inspector" />
        </div>
        <div>
          <label data-i18n="labelPassword">å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰</label>
          <input id="passcode" type="password" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" id="btnLogin" data-i18n="btnLogin">ç™»å…¥</button>
        <button class="btn btn-ghost" id="btnResetPass" data-i18n="btnReset">æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„</button>
        <a class="btn btn-ghost" href="/api/inspections?health=1" target="_blank" id="btnHealth" data-i18n="btnHealth">å¥åº·æª¢æŸ¥</a>
        <button class="btn btn-ghost" id="btnLang">ğŸŒ èªè¨€</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- è¡¨å–®å€ï¼ˆinput/admin å¯è¦‹ï¼‰ -->
    <div id="formView" class="hidden">
      <div class="row">
        <div>
          <label data-i18n="labelSupplier">ä¾›æ‡‰å•†</label>
          <select id="supplier"></select>
        <div class="muted" id="supplierEn"></div>
        </div>
        <div>
          <label data-i18n="labelPartNo">æ–™è™Ÿ (Part No.)</label>
          <input id="partNo" />
        </div>
      </div>
      <div class="row">
        <div>
          <label data-i18n="labelDrawingNo">åœ–è™Ÿ (Drawing No.)</label>
          <input id="drawingNo" />
        </div>
        <div>
          <label data-i18n="labelRevision">ç‰ˆæ¬¡ (Revision)</label>
          <input id="revision" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label data-i18n="labelNotes">å‚™è¨»</label>
        <textarea id="notes" rows="2"></textarea>
      </div>

      <!-- æ•´åˆè¡¨ï¼šç¬¬1åˆ—ï¼å¤–è§€ï¼ˆå¯ç•¥éï¼‰ï¼›ç¬¬2åˆ—èµ·ï¼å°ºå¯¸ -->
      <h3 style="margin-top:20px" data-i18n="sectionTitle">å°ºå¯¸èˆ‡å¤–è§€æª¢é©—</h3>
      <p class="hint" data-i18n="hintAppearance">ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚</p>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:14%" data-i18n="thItem">é …ç›® / å°ºå¯¸åç¨±</th>
            <th style="width:10%" data-i18n="thNominal">åç›®å€¼</th>
            <th style="width:10%" data-i18n="thTolMinus">ä¸‹é™å…¬å·®</th>
            <th style="width:10%" data-i18n="thTolPlus">ä¸Šé™å…¬å·®</th>
            <th style="width:8%" data-i18n="thM1">å¯¦æ¸¬1</th>
            <th style="width:8%" data-i18n="thM2">å¯¦æ¸¬2</th>
            <th style="width:8%" data-i18n="thM3">å¯¦æ¸¬3</th>
            <th style="width:8%" data-i18n="thM4">å¯¦æ¸¬4</th>
            <th style="width:8%" data-i18n="thM5">å¯¦æ¸¬5</th>
            <th style="width:8%" data-i18n="thDecision">çµæœ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="toolbar">
        <button class="btn btn-ghost" id="btnAdd" data-i18n="btnAdd">ï¼‹æ–°å¢å°ºå¯¸</button>
        <button class="btn btn-ghost" id="btnRemove" data-i18n="btnRemove">ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—</button>
        <button class="btn btn-ghost" id="btnClearRows" data-i18n="btnClearRows">æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰</button>
        <button class="btn btn-ghost" id="btnLang2">ğŸŒ èªè¨€</button>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="btnSave" data-i18n="btnSave">å„²å­˜åˆ°é›²ç«¯</button>
        <a class="btn btn-secondary" href="report.html" id="btnGoReport" data-i18n="btnGoReport">æŸ¥çœ‹/åˆ—å°å ±å‘Š</a>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>

    <!-- viewer æç¤º -->
    <p id="viewOnlyTip" class="muted hidden" data-i18n="viewOnlyTip">
      æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚
    </p>
  </div>

  <!-- èªè¨€é¸æ“‡å½ˆçª— -->
  <div class="modal-backdrop" id="langModal">
    <div class="modal">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€ / Language</h3>
      <p class="muted" data-i18n="langHint">è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š</p>
      <div class="grid">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

  <script>
    /* ============ I18N å­—å…¸ ============ */
    const I18N = {
      'zh-TW': {
        title:'ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰',
        loginPrompt:'è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚',
        labelAccount:'å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰', labelPassword:'å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰',
        btnLogin:'ç™»å…¥', btnReset:'æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„', btnHealth:'å¥åº·æª¢æŸ¥',
        labelSupplier:'ä¾›æ‡‰å•†', labelPartNo:'æ–™è™Ÿ (Part No.)', labelDrawingNo:'åœ–è™Ÿ (Drawing No.)', labelRevision:'ç‰ˆæ¬¡ (Revision)', labelNotes:'å‚™è¨»',
        sectionTitle:'å°ºå¯¸èˆ‡å¤–è§€æª¢é©—',
        hintAppearance:'ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚',
        thItem:'é …ç›® / å°ºå¯¸åç¨±', thNominal:'åç›®å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
        thM1:'å¯¦æ¸¬1', thM2:'å¯¦æ¸¬2', thM3:'å¯¦æ¸¬3', thM4:'å¯¦æ¸¬4', thM5:'å¯¦æ¸¬5', thDecision:'çµæœ',
        btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—', btnClearRows:'æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰',
        btnSave:'å„²å­˜åˆ°é›²ç«¯', btnGoReport:'æŸ¥çœ‹/åˆ—å°å ±å‘Š',
        viewOnlyTip:'æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚',
        langTitle:'é¸æ“‡èªè¨€ / Language', langHint:'è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š',
        phAccount:'ä¾‹å¦‚ï¼šboss / worker1 / qa1', phPassword:'ä¾‹å¦‚ï¼šadmin123 / in1111 / view2222',
        phSupplier:'ä¾‹å¦‚ï¼šXX è¡¨é¢è™•ç†å» ', phPartNo:'ä¾‹å¦‚ï¼šRT138', phDrawingNo:'ä¾‹å¦‚ï¼šWKNO137-6', phRevision:'ä¾‹å¦‚ï¼šRev.B', phNotes:'ä¾‹å¦‚ï¼šç¾å ´å°ºå¯¸ç©©å®š/å¤–è§€ç„¡ç‘•ç–µ',
        phName:'ä¾‹ï¼šé ­éƒ¨åšåº¦', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100',
        phM1:'å¯¦æ¸¬1', phM2:'å¯¦æ¸¬2', phM3:'å¯¦æ¸¬3', phM4:'å¯¦æ¸¬4', phM5:'å¯¦æ¸¬5',
        login_msg_need:'è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼', login_msg_auto:'è‡ªå‹•é©—è­‰ä¸­...', login_msg_changed:'âŒ å¸³è™Ÿæˆ–å¯†ç¢¼å·²è®Šæ›´ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚', login_msg_wrong:'âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤', login_verifying:'é©—è­‰ä¸­...',
        save_saving:'å„²å­˜ä¸­...', save_ok:'âœ… å·²å„²å­˜åˆ°é›²ç«¯ï¼ˆå¯åˆ°å ±å‘Šé æŸ¥çœ‹/åˆ—å°ï¼‰', save_fail:'âŒ å„²å­˜å¤±æ•—ï¼š',
        need_supplier_part:'è«‹è¼¸å…¥ä¾›æ‡‰å•†èˆ‡æ–™è™Ÿ', row_missing:'å°ºå¯¸è¡¨æœ‰æœªå¡«æ¬„ä½ï¼ˆåç¨±/åç›®/å…¬å·®ï¼‰', need_one_meas:'æ¯åˆ—å°ºå¯¸è‡³å°‘å¡«ä¸€å€‹ã€Œå¯¦æ¸¬ã€', need_one_dim:'è‡³å°‘éœ€è¦ä¸€ç­†å°ºå¯¸è³‡æ–™', need_login:'è«‹å…ˆç™»å…¥',
        appearanceTitle:'å¤–è§€æª¢æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG'
      },
      'zh-CN': {
        title:'ç°åœºå“æ£€ï¼ˆå®‰æ‹“ï¼‰',
        loginPrompt:'è¯·è¾“å…¥ã€Œè´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰ã€ä¸ã€Œå¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰ã€ã€‚',
        labelAccount:'è´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰', labelPassword:'å¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰',
        btnLogin:'ç™»å½•', btnReset:'æ¸…é™¤æœ¬æœºè®°å½•', btnHealth:'å¥åº·æ£€æŸ¥',
        labelSupplier:'ä¾›åº”å•†', labelPartNo:'æ–™å· (Part No.)', labelDrawingNo:'å›¾å· (Drawing No.)', labelRevision:'ç‰ˆæ¬¡ (Revision)', labelNotes:'å¤‡æ³¨',
        sectionTitle:'å°ºå¯¸ä¸å¤–è§‚æ£€éªŒ',
        hintAppearance:'ç¬¬ <strong>1</strong> è¡Œä¸º <strong>å¤–è§‚æ£€æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ <strong>2</strong> è¡Œå¼€å§‹ä¸ºå°ºå¯¸é‡æµ‹ã€‚',
        thItem:'é¡¹ç›® / å°ºå¯¸åç§°', thNominal:'åä¹‰å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
        thM1:'å®æµ‹1', thM2:'å®æµ‹2', thM3:'å®æµ‹3', thM4:'å®æµ‹4', thM5:'å®æµ‹5', thDecision:'åˆ¤å®š',
        btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆ é™¤æœ€åä¸€è¡Œ', btnClearRows:'æ¸…ç©ºå°ºå¯¸è¡Œï¼ˆä¿ç•™å¤–è§‚ï¼‰',
        btnSave:'ä¿å­˜åˆ°äº‘ç«¯', btnGoReport:'æŸ¥çœ‹/æ‰“å°æŠ¥å‘Š',
        viewOnlyTip:'æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/æ‰“å°æŠ¥å‘Šï¼‰ã€‚è¯·æ”¹åˆ° <a href="report.html">æŠ¥å‘Šé¡µ</a>ã€‚',
        langTitle:'é€‰æ‹©è¯­è¨€ / Language', langHint:'è¯·é€‰æ‹©ç•Œé¢è¯­è¨€ï¼š',
        phAccount:'ä¾‹å¦‚ï¼šboss / worker1 / qa1', phPassword:'ä¾‹å¦‚ï¼šadmin123 / in1111 / view2222',
        phSupplier:'ä¾‹å¦‚ï¼šXX è¡¨é¢å¤„ç†å‚', phPartNo:'ä¾‹å¦‚ï¼šRT138', phDrawingNo:'ä¾‹å¦‚ï¼šWKNO137-6', phRevision:'ä¾‹å¦‚ï¼šRev.B', phNotes:'ä¾‹å¦‚ï¼šç°åœºå°ºå¯¸ç¨³å®š/å¤–è§‚æ— ç‘•ç–µ',
        phName:'ä¾‹ï¼šå¤´éƒ¨åšåº¦', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100',
        phM1:'å®æµ‹1', phM2:'å®æµ‹2', phM3:'å®æµ‹3', phM4:'å®æµ‹4', phM5:'å®æµ‹5',
        login_msg_need:'è¯·è¾“å…¥è´¦å·ä¸å¯†ç ', login_msg_auto:'è‡ªåŠ¨éªŒè¯ä¸­...', login_msg_changed:'âŒ è´¦å·æˆ–å¯†ç å·²å˜æ›´ï¼Œè¯·é‡æ–°ç™»å½•ã€‚', login_msg_wrong:'âŒ è´¦å·æˆ–å¯†ç é”™è¯¯', login_verifying:'éªŒè¯ä¸­...',
        save_saving:'ä¿å­˜ä¸­...', save_ok:'âœ… å·²ä¿å­˜åˆ°äº‘ç«¯ï¼ˆå¯åˆ°æŠ¥å‘Šé¡µæŸ¥çœ‹/æ‰“å°ï¼‰', save_fail:'âŒ ä¿å­˜å¤±è´¥ï¼š',
        need_supplier_part:'è¯·è¾“å…¥ä¾›åº”å•†ä¸æ–™å·', row_missing:'å°ºå¯¸è¡¨æœ‰æœªå¡«æ ä½ï¼ˆåç§°/åç›®/å…¬å·®ï¼‰', need_one_meas:'æ¯è¡Œå°ºå¯¸è‡³å°‘å¡«ä¸€ä¸ªã€Œå®æµ‹ã€', need_one_dim:'è‡³å°‘éœ€è¦ä¸€ç¬”å°ºå¯¸èµ„æ–™', need_login:'è¯·å…ˆç™»å½•',
        appearanceTitle:'å¤–è§‚æ£€æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG'
      },
      'en': {
        title:'On-site QC (Antor)',
        loginPrompt:'Please enter â€œAccount (Inspector)â€ and â€œPasswordâ€.',
        labelAccount:'Account (Inspector)', labelPassword:'Password',
        btnLogin:'Sign in', btnReset:'Clear local data', btnHealth:'Health Check',
        labelSupplier:'Supplier', labelPartNo:'Part No.', labelDrawingNo:'Drawing No.', labelRevision:'Revision', labelNotes:'Notes',
        sectionTitle:'Appearance & Dimensional Inspection',
        hintAppearance:'Row <strong>1</strong> is <strong>Appearance</strong> (optional). From row <strong>2</strong> onwards are dimensions.',
        thItem:'Item / Dimension', thNominal:'Nominal', thTolMinus:'Lower Tol.', thTolPlus:'Upper Tol.',
        thM1:'Sample1', thM2:'Sample2', thM3:'Sample3', thM4:'Sample4', thM5:'Sample5', thDecision:'Decision',
        btnAdd:'ï¼‹Add dimension', btnRemove:'ï¼Remove last row', btnClearRows:'Clear dimension rows (keep appearance)',
        btnSave:'Save to cloud', btnGoReport:'View/Print Reports',
        viewOnlyTip:'Your role is <strong>viewer</strong> (view/print only). Go to <a href="report.html">Reports</a>.',
        langTitle:'Choose language', langHint:'Select UI language:',
        phAccount:'e.g. boss / worker1 / qa1', phPassword:'e.g. admin123 / in1111 / view2222',
        phSupplier:'e.g. XX Surface Shop', phPartNo:'e.g. RT138', phDrawingNo:'e.g. WKNO137-6', phRevision:'e.g. Rev.B', phNotes:'e.g. Dimensions stable / No defects',
        phName:'e.g. Head thickness', phNominal:'e.g. 3.000', phTolMinus:'e.g. -0.100', phTolPlus:'e.g. 0.100',
        phM1:'Sample1', phM2:'Sample2', phM3:'Sample3', phM4:'Sample4', phM5:'Sample5',
        login_msg_need:'Please enter account & password', login_msg_auto:'Auto checking...', login_msg_changed:'âŒ Account or password changed, sign in again.', login_msg_wrong:'âŒ Wrong account or password', login_verifying:'Verifying...',
        save_saving:'Saving...', save_ok:'âœ… Saved (check the report page to view/print)', save_fail:'âŒ Save failed: ',
        need_supplier_part:'Enter supplier & part no.', row_missing:'Some required fields (name/nominal/tolerance) are missing', need_one_meas:'Enter at least 1 sample for each row', need_one_dim:'Enter at least one dimension row', need_login:'Please sign in first',
        appearanceTitle:'Appearance', optionDash:'â€”', optionOK:'O.K', optionNG:'NG'
      }
    };

    function getLang(){ return localStorage.getItem('qci_lang') || ''; }
    function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
    function selectLang(lang){ setLang(lang); closeLangModal(); if (typeof _afterPick === 'function') _afterPick(); }
    function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
    function closeLangModal(){ document.getElementById('langModal').style.display='none'; }

    function t(key){
      const lang = getLang() || 'zh-TW';
      const dict = I18N[lang] || I18N['zh-TW'];
      return dict[key] ?? (I18N['zh-TW'][key] ?? key);
    }

    function applyI18n(){
      // æ–‡æ¡ˆ
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (k) { el.innerHTML = t(k); }
      });
      // placeholder
      const m = {
        '#inspector':'phAccount', '#passcode':'phPassword',
        '#supplier':'phSupplier', '#partNo':'phPartNo', '#drawingNo':'phDrawingNo', '#revision':'phRevision', '#notes':'phNotes'
      };
      Object.entries(m).forEach(([sel,key])=>{
        const el = document.querySelector(sel); if (el) el.placeholder = t(key);
      });

      // æ—¢æœ‰çš„å°ºå¯¸åˆ— placeholder ä¹Ÿæ›´æ–°
      document.querySelectorAll('tr[data-type="measure"]').forEach(tr=>{
        const ins = tr.querySelectorAll('input');
        if (ins[0]) ins[0].placeholder = t('phName');
        if (ins[1]) ins[1].placeholder = t('phNominal');
        if (ins[2]) ins[2].placeholder = t('phTolMinus');
        if (ins[3]) ins[3].placeholder = t('phTolPlus');
        if (ins[4]) ins[4].placeholder = t('phM1');
        if (ins[5]) ins[5].placeholder = t('phM2');
        if (ins[6]) ins[6].placeholder = t('phM3');
        if (ins[7]) ins[7].placeholder = t('phM4');
        if (ins[8]) ins[8].placeholder = t('phM5');
      });

      // å¤–è§€åˆ—é¸å–®é¡¯ç¤º
      document.querySelectorAll('tr[data-type="appearance"] select.ap').forEach(sel=>{
        sel.options[0].text = t('optionDash');
        sel.options[1].text = t('optionOK');
        sel.options[2].text = t('optionNG');
      });

      // <title>
      const titleEl = document.querySelector('title[data-i18n="title"]');
      if (titleEl) titleEl.textContent = t('title');
    }

    /* ====== æ—¢æœ‰åŠŸèƒ½ ====== */
    const loginView = document.getElementById('loginView');
    const formView  = document.getElementById('formView');
    const inspector = document.getElementById('inspector');
    const passcode  = document.getElementById('passcode');
    const loginMsg  = document.getElementById('loginMsg');
    const viewOnlyTip = document.getElementById('viewOnlyTip');

    const tbody = document.getElementById('tbody');
    const msg   = document.getElementById('msg');

    document.getElementById('btnLogin').addEventListener('click', onLogin);
    document.getElementById('btnResetPass').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector','qci_lang'].forEach(k => localStorage.removeItem(k));
      alert('Cleared. / å·²æ¸…é™¤ã€‚');
    });
    document.getElementById('btnLang').addEventListener('click', ()=>{ _afterPick = applyI18n; openLangModal(); });
    document.getElementById('btnLang2').addEventListener('click', ()=>{ _afterPick = applyI18n; openLangModal(); });

    // è¡¨æ ¼æŒ‰éˆ•
    document.getElementById('btnAdd').addEventListener('click', addMeasureRow);
    document.getElementById('btnRemove').addEventListener('click', removeLastMeasureRow);
    document.getElementById('btnClearRows').addEventListener('click', () => { clearMeasureRows(); ensureMeasureRows(2); });

    document.getElementById('btnSave').addEventListener('click', save);

    // è‡ªå‹•é©—è­‰
    window.addEventListener('DOMContentLoaded', async () => {
      applyI18n(); // å…ˆå¥—ç”¨ç¾æœ‰ï¼ˆæˆ–é è¨­ç¹ä¸­ï¼‰
      const u = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      const p = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (u) inspector.value = u;
      if (p) passcode.value = p;

      if (u && p) {
        loginMsg.textContent = t('login_msg_auto');
        const info = await authCheck(u, p);
        if (info && info.ok) {
          localStorage.setItem('qci_user', u);
          localStorage.setItem('qci_pass', p);
          localStorage.setItem('qci_role', info.role);
          const go = () => {
            showByRole(info.role);
            if (info.role !== 'viewer') {
              ensureAppearanceRow();
              if (countMeasureRows() === 0) ensureMeasureRows(2);
            }
            loginMsg.textContent = '';
          };
          if (!getLang()) { _afterPick = ()=>{ applyI18n(); go(); }; openLangModal(); }
          else { applyI18n(); go(); }
          return;
        }
        loginMsg.innerHTML = t('login_msg_changed');
      }
    });

    async function onLogin() {
      const u = inspector.value.trim();
      const p = passcode.value.trim();
      if (!u || !p) { loginMsg.innerHTML = '<span class="error">'+t('login_msg_need')+'</span>'; return; }

      loginMsg.textContent = t('login_verifying');
      const info = await authCheck(u, p);
      if (!info || !info.ok) {
        loginMsg.innerHTML = '<span class="error">'+t('login_msg_wrong')+'</span>'; return;
      }

      localStorage.setItem('qci_user', u);
      localStorage.setItem('qci_pass', p);
      localStorage.setItem('qci_role', info.role);
      localStorage.setItem('qci_inspector', u);
      localStorage.setItem('qci_passcode', p);

      const go = () => {
        showByRole(info.role);
        if (info.role !== 'viewer') {
          ensureAppearanceRow();
          if (countMeasureRows() === 0) ensureMeasureRows(2);
        }
        loginMsg.textContent = '';
      };
      if (!getLang()) { _afterPick = ()=>{ applyI18n(); go(); }; openLangModal(); }
      else { applyI18n(); go(); }
    }

    function showByRole(role) {
      if (role === 'viewer') {
        loginView.classList.add('hidden');
        formView.classList.add('hidden');
        viewOnlyTip.classList.remove('hidden');
      } else {
        loginView.classList.add('hidden');
        formView.classList.remove('hidden');
        viewOnlyTip.classList.add('hidden');
      }
    }

    async function authCheck(user, pass) {
      try {
        const res = await fetch('/api/inspections?auth=1', {
          headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }
        });
        const t = await res.text();
        let j = {}; try { j = JSON.parse(t); } catch {}
        return { ok: res.ok && j.ok, role: j.role || 'admin', mode: j.mode || 'passcode' };
      } catch { return null; }
    }

    /* ======== å¤–è§€ï¼ˆç¬¬1åˆ—ï¼Œå¯ç•™ç©ºï¼‰ + å°ºå¯¸ï¼ˆç¬¬2åˆ—èµ·ï¼‰ ======== */

    function ensureAppearanceRow() {
      if (tbody.querySelector('tr[data-type="appearance"]')) return;
      const tr = document.createElement('tr');
      tr.dataset.type = 'appearance';
      tr.innerHTML = `
        <td><strong>${t('appearanceTitle')}</strong></td>
        <td class="disabled"><input value="" placeholder="â€”" disabled /></td>
        <td class="disabled"><input value="" placeholder="â€”" disabled /></td>
        <td class="disabled"><input value="" placeholder="â€”" disabled /></td>
        <td>${buildApSelect('ap1')}</td>
        <td>${buildApSelect('ap2')}</td>
        <td>${buildApSelect('ap3')}</td>
        <td>${buildApSelect('ap4')}</td>
        <td>${buildApSelect('ap5')}</td>
        <td><span class="tag">â€”</span></td>
      `;
      tr.querySelectorAll('select.ap').forEach(s => s.addEventListener('change', () => updateAppearanceRow(tr)));
      tbody.prepend(tr);
    }
    function buildApSelect(id){
      return `
        <select id="${id}" class="ap">
          <option value="">${t('optionDash')}</option>
          <option value="OK">${t('optionOK')}</option>
          <option value="NG">${t('optionNG')}</option>
        </select>`;
    }

    function updateAppearanceRow(tr) {
      const sels = [...tr.querySelectorAll('select.ap')];
      const values = sels.map(s => (s.value || '').toUpperCase()).filter(Boolean);
      const tag = tr.querySelector('.tag');

      if (values.length === 0) { tag.textContent = 'â€”'; tag.className = 'tag'; return; }
      const pass = values.every(v => v === 'OK');
      tag.textContent = pass ? 'PASS' : 'FAIL';
      tag.className = 'tag ' + (pass ? 'pass' : 'fail');
    }

    function countMeasureRows() {
      return [...tbody.querySelectorAll('tr')].filter(tr => tr.dataset.type !== 'appearance').length;
    }

    function ensureMeasureRows(n) { for (let i=0; i<n; i++) addMeasureRow(); }

    function addMeasureRow() {
      const tr = document.createElement('tr');
      tr.dataset.type = 'measure';
      tr.innerHTML = `
        <td><input placeholder="${t('phName')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phNominal')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phTolMinus')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phTolPlus')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phM1')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phM2')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phM3')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phM4')}" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="${t('phM5')}" /></td>
        <td><span class="tag">â€”</span></td>
      `;
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => updateMeasureRow(tr)));
      tbody.appendChild(tr);
    }

    function removeLastMeasureRow(){
      const rows = [...tbody.querySelectorAll('tr')].filter(tr => tr.dataset.type !== 'appearance');
      const last = rows[rows.length - 1];
      if (last) tbody.removeChild(last);
    }

    function clearMeasureRows() {
      [...tbody.querySelectorAll('tr')].forEach(tr => { if (tr.dataset.type !== 'appearance') tr.remove(); });
    }

    function updateMeasureRow(tr) {
      const inputs = [...tr.querySelectorAll('input')].map(i => i.value);
      const [name, nominal, tolMinus, tolPlus, m1, m2, m3, m4, m5] = inputs;
      const tag = tr.querySelector('.tag');

      if (nominal === '' || tolMinus === '' || tolPlus === '') {
        tag.textContent = 'â€”'; tag.className = 'tag'; return;
      }
      const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus);
      const arr = [m1, m2, m3, m4, m5].filter(s => s !== '');
      if (arr.length === 0) { tag.textContent = 'â€”'; tag.className = 'tag'; return; }

      let ok = true;
      for (const s of arr) {
        const m = parseFloat(s); const dev = m - n;
        if (!(dev >= lo && dev <= hi)) { ok = false; break; }
      }
      tag.textContent = ok ? 'PASS' : 'FAIL';
      tag.className = 'tag ' + (ok ? 'pass' : 'fail');
    }

    /* ========= å„²å­˜ ========= */
    async function save() {
      const role = (localStorage.getItem('qci_role') || '').toLowerCase();
      if (role === 'viewer') { alert('viewer æ²’æœ‰ä¸Šå‚³æ¬Šé™'); return; }

      const record = buildRecord(); if (!record) return;
      msg.textContent = t('save_saving');
      const btn = document.getElementById('btnSave'); btn.disabled = true;

      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      const code = pass;

      try {
        const res = await fetch('/api/inspections', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json','x-user': user,'x-pass': pass,'x-passcode': code },
          body: JSON.stringify({ record })
        });
        const text = await res.text();
        if (!res.ok) {
          if (res.status === 401) { showLogin('âŒ ç™»å…¥éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚'); }
          throw new Error(`HTTP ${res.status}ï¼›${text || ''}`);
        }
        msg.textContent = t('save_ok');
        // é‡ç½®ï¼šå¤–è§€æ¸…ç©ºã€å°ºå¯¸é‡å»º
        tbody.querySelectorAll('tr[data-type="appearance"] select.ap').forEach(s => s.value = '');
        const apTag = tbody.querySelector('tr[data-type="appearance"] .tag');
        if (apTag) { apTag.textContent = 'â€”'; apTag.className = 'tag'; }
        clearMeasureRows(); ensureMeasureRows(2);
        applyI18n(); // é‡å»ºåˆ—ä¹Ÿè¦æ›´æ–° placeholder èªè¨€
      } catch (e) {
        msg.textContent = t('save_fail') + e.message;
      } finally { btn.disabled = false; }
    }

    function showLogin(s){ loginView.classList.remove('hidden'); formView.classList.add('hidden'); if (s) loginMsg.innerHTML = '<span class="error">'+s+'</span>'; }

    function buildRecord() {
      const inspectorName = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      if (!inspectorName || !pass) { showLogin(t('need_login')); return null; }

      const supplier = document.getElementById('supplier').value.trim();
      const partNo = document.getElementById('partNo').value.trim();
      const drawingNo = document.getElementById('drawingNo').value.trim();
      const revision = document.getElementById('revision').value.trim();
      const notes = document.getElementById('notes').value.trim();
      if (!supplier || !partNo) { alert(t('need_supplier_part')); return null; }

      const rows = [...tbody.querySelectorAll('tr')];

      // 1) å¤–è§€åˆ—ï¼ˆå¯å®Œå…¨ç•™ç©ºï¼‰
      const apRow = rows.find(tr => tr.dataset.type === 'appearance');
      const sels = apRow ? [...apRow.querySelectorAll('select.ap')] : [];
      const apValues = sels.map((s, i) => ({ i: i+1, v: (s.value || '').toUpperCase() })).filter(x => x.v);
      const appearance = apValues.map(x => ({ sample: `æ¨£å“${x.i}`, result: x.v, note: '' }));
      const hasAppearance = appearance.length > 0;
      const appearancePass = !hasAppearance || appearance.every(x => x.result === 'OK'); // ç©ºç™½=ä¸å½±éŸ¿

      // 2) å°ºå¯¸åˆ—
      const measureRows = rows.filter(tr => tr.dataset.type !== 'appearance');
      const measurements = [];
      let allDimPass = true;

      for (const tr of measureRows) {
        const inputs = [...tr.querySelectorAll('input')].map(i => i.value.trim());
        const [name, nominal, tolMinus, tolPlus, m1, m2, m3, m4, m5] = inputs;

        if (!name && !nominal && !tolMinus && !tolPlus && !m1 && !m2 && !m3 && !m4 && !m5) continue;
        if (!name || !nominal || !tolMinus || !tolPlus) { alert(t('row_missing')); return null; }

        const arrRaw = [m1, m2, m3, m4, m5].filter(s => s !== '');
        if (arrRaw.length === 0) { alert(t('need_one_meas')); return null; }

        const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus);
        const arr = arrRaw.map(s => parseFloat(s));

        let passRow = true;
        for (const m of arr) { const dev = m - n; if (!(dev >= lo && dev <= hi)) { passRow = false; break; } }
        if (!passRow) allDimPass = false;

        measurements.push({ name, nominal:n, tolMinus:lo, tolPlus:hi, measured:arr, pass:passRow });
      }
      if (measurements.length === 0) { alert(t('need_one_dim')); return null; }

      // ç¸½çµæœï¼šå¤–è§€ï¼ˆè‹¥æœ‰å¡«æ‰è¨ˆå…¥ï¼‰ï¼‹ å°ºå¯¸
      const overall = (allDimPass && appearancePass) ? 'PASS' : 'FAIL';

      const now = new Date();
      const id = `INS-${now.toISOString().slice(0,19).replace(/[-:T]/g,'')}-${Math.floor(Math.random()*900+100)}`;
      const isoLocal = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString();
      return {
        id, timestamp: isoLocal, inspector: inspectorName,
        supplier, partNo, drawingNo, revision, notes,
        measurements,
        appearance,                  // å¯èƒ½æ˜¯ []ï¼ˆå¤–è§€ç•™ç©ºï¼‰
        overallResult: overall
      };
    }

    // ç¬¬ä¸€æ¬¡é€²é é¢å…ˆæŠŠ UI èªè¨€å¥—ä¸Š
    applyI18n();
    let _afterPick = null;
  </script>
<script>
// === Supplier dropdown init (Anchor/AKF) ===
    (function(){
      if (window.__SUP_INIT__) return; window.__SUP_INIT__ = true;
      const SUPPLIERS = [
        { id: "å®‰æ‹“", label: "å®‰æ‹“ (Anchor)", en: "Anchor" },
        { id: "å®‰å¯", label: "å®‰å¯ (AKF)",    en: "AKF" }
      ];
      const sel = document.getElementById('supplier');
      const hint = document.getElementById('supplierEn');
      function fill(){
        if (!sel) return;
        sel.innerHTML = SUPPLIERS.map(s=>`<option value="${s.id}">${s.label}</option>`).join('');
        // set previous value if any
        const prev = (sel.getAttribute('data-prev')||'').trim();
        if (prev) sel.value = prev;
        updateHint();
      }
      function updateHint(){
        if (!sel || !hint) return;
        const v = sel.value;
        const item = SUPPLIERS.find(s=>s.id===v);
        hint.textContent = item ? `English: ${item.en}` : '';
      }
      if (sel){
        sel.addEventListener('change', updateHint);
        // If there was an input before, try to migrate its value from localStorage (optional)
      }
      // Run after DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fill);
      } else { fill(); }
      // expose helper to other scripts if needed
      window.__SUPPLIERS__ = SUPPLIERS;
    })();
</script>
</body>
</html>
