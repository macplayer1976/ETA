<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>現場品檢（安拓）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 900px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pass { background: #e7f7ec; color: #116329; }
    .fail { background: #fde8e8; color: #c02020; }
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }
    .muted { color: #666; font-size: 13px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>現場品檢（安拓）</h2>

    <!-- 登入區 -->
    <div id="loginView">
      <p class="muted">請輸入檢驗人員姓名與團隊通關碼。</p>
      <div class="row">
        <div>
          <label>檢驗人員</label>
          <input id="inspector" placeholder="例如：王小明" />
        </div>
        <div>
          <label>通關碼（主管設定）</label>
          <input id="passcode" placeholder="例如：A1234" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-primary" id="btnLogin">登入</button>
      </div>
    </div>

    <!-- 表單區 -->
    <div id="formView" class="hidden">
      <div class="row">
        <div>
          <label>供應商</label>
          <input id="supplier" placeholder="例如：XX 表面處理廠" />
        </div>
        <div>
          <label>料號 (Part No.)</label>
          <input id="partNo" placeholder="例如：RT138" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>圖號 (Drawing No.)</label>
          <input id="drawingNo" placeholder="例如：WKNO137-6" />
        </div>
        <div>
          <label>版次 (Revision)</label>
          <input id="revision" placeholder="例如：Rev.B" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label>備註</label>
        <textarea id="notes" rows="2" placeholder="例如：現場尺寸穩定"></textarea>
      </div>

      <h3 style="margin-top:20px">尺寸量測</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:20%">尺寸名稱</th>
            <th style="width:16%">名目值</th>
            <th style="width:16%">下限公差</th>
            <th style="width:16%">上限公差</th>
            <th style="width:16%">實測值</th>
            <th style="width:16%">結果</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div style="margin-top:8px">
        <button class="btn btn-secondary" id="btnAdd">＋新增尺寸</button>
      </div>

      <div style="margin-top:20px">
        <button class="btn btn-primary" id="btnSave">儲存到雲端</button>
        <a class="btn" href="report.html" style="margin-left:8px">查看/列印報告</a>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>
  </div>

  <script>
    const loginView = document.getElementById('loginView');
    const formView  = document.getElementById('formView');
    const inspector = document.getElementById('inspector');
    const passcode  = document.getElementById('passcode');

    const tbody = document.getElementById('tbody');
    const msg   = document.getElementById('msg');

    // 邏輯：登入後才可填表；本機記住 inspector 與 passcode
    document.getElementById('btnLogin').addEventListener('click', () => {
      const name = inspector.value.trim();
      const code = passcode.value.trim();
      if (!name || !code) { alert('請輸入姓名與通關碼'); return; }
      localStorage.setItem('qci_inspector', name);
      localStorage.setItem('qci_passcode', code);
      loginView.classList.add('hidden');
      formView.classList.remove('hidden');
      ensureRows(3); // 預設三列尺寸
    });

    // 若已登入過，自動帶入
    window.addEventListener('DOMContentLoaded', () => {
      const name = localStorage.getItem('qci_inspector') || '';
      const code = localStorage.getItem('qci_passcode') || '';
      if (name && code) {
        inspector.value = name;
        passcode.value = code;
        loginView.classList.add('hidden');
        formView.classList.remove('hidden');
        ensureRows(3);
      }
    });

    document.getElementById('btnAdd').addEventListener('click', () => addRow());

    function ensureRows(n) { for (let i=0; i<n; i++) addRow(); }

    function addRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="例：頭部厚度"/></td>
        <td><input type="number" step="0.001" placeholder="例：3.00"/></td>
        <td><input type="number" step="0.001" placeholder="例：-0.10"/></td>
        <td><input type="number" step="0.001" placeholder="例：0.10"/></td>
        <td><input type="number" step="0.001" placeholder="例：3.06"/></td>
        <td><span class="tag">—</span></td>
      `;
      // 綁定即時計算
      const inputs = tr.querySelectorAll('input');
      inputs.forEach(inp => inp.addEventListener('input', () => updateRow(tr)));
      tbody.appendChild(tr);
    }

    function updateRow(tr) {
      const [name, nominal, tolMinus, tolPlus, measured] = [...tr.querySelectorAll('input')].map(i => i.value);
      const tag = tr.querySelector('.tag');
      if (nominal !== '' && tolMinus !== '' && tolPlus !== '' && measured !== '') {
        const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus), m = parseFloat(measured);
        const dev = m - n;
        const ok  = dev >= lo && dev <= hi;
        tag.textContent = ok ? 'PASS' : 'FAIL';
        tag.className = 'tag ' + (ok ? 'pass' : 'fail');
      } else {
        tag.textContent = '—';
        tag.className = 'tag';
      }
    }

    document.getElementById('btnSave').addEventListener('click', async () => {
      const record = buildRecord();
      if (!record) return;

      msg.textContent = '儲存中...';
      const code = localStorage.getItem('qci_passcode');

      try {
        const res = await fetch('/api/inspections', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
           'x-passcode': code
         },
         body: JSON.stringify({ record })
       });

      let text = '';
      try { text = await res.text(); } catch {}

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}；訊息：${text || '（無訊息）'}`);
       }

        msg.textContent = '✅ 已儲存到雲端（可到報告頁查看/列印）';
        // 清空測量表（保留供應商/料號等欄位以利連續作業）
        tbody.innerHTML = '';
        ensureRows(3);
      } catch (e) {
        msg.textContent = '❌ 儲存失敗：' + e.message;
      }
    });

    function buildRecord() {
      const inspectorName = localStorage.getItem('qci_inspector') || '';
      const code = localStorage.getItem('qci_passcode') || '';
      if (!inspectorName || !code) { alert('請先登入'); return null; }

      const supplier = document.getElementById('supplier').value.trim();
      const partNo = document.getElementById('partNo').value.trim();
      const drawingNo = document.getElementById('drawingNo').value.trim();
      const revision = document.getElementById('revision').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!supplier || !partNo) { alert('請輸入供應商與料號'); return null; }

      const rows = [...tbody.querySelectorAll('tr')];
      const measurements = [];
      let allPass = true;

      for (const tr of rows) {
        const [name, nominal, tolMinus, tolPlus, measured] = [...tr.querySelectorAll('input')].map(i => i.value.trim());
        if (!name && !nominal && !tolMinus && !tolPlus && !measured) continue; // 空白列略過
        if (!name || !nominal || !tolMinus || !tolPlus || !measured) { alert('有未填欄位'); return null; }

        const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus), m = parseFloat(measured);
        const dev = +(m - n).toFixed(3);
        const pass = dev >= lo && dev <= hi;
        if (!pass) allPass = false;

        measurements.push({ name, nominal: n, tolMinus: lo, tolPlus: hi, measured: m, deviation: dev, pass });
      }

      const now = new Date();
      const id = `INS-${now.toISOString().slice(0,19).replace(/[-:T]/g,'')}-${Math.floor(Math.random()*900+100)}`;

      return {
        id,
        timestamp: new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString(), // ISO + 本地時區
        inspector: inspectorName,
        supplier, partNo, drawingNo, revision,
        notes,
        measurements,
        overallResult: allPass ? 'PASS' : 'FAIL'
      };
    }
  </script>
</body>
</html>
