<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="title">ç¾å ´å“æª¢ï¼ˆAKFï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; background:#fafafa; }
    .card { max-width: 1120px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h2 { margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; }
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #111827; color: #fff; }
    .btn-ghost { background: #f3f4f6; color: #111827; }
    .muted { color: #6b7280; font-size: 13px; }
    .hidden { display:none !important; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    a.btn { text-decoration: none; display:inline-block; }
    td.disabled input { background:#fafafa; color:#9ca3af; }
    .sketch-box { margin: 12px 0 6px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background:#f9fafb; }
    .sketch-box h3 { margin: 0 0 6px 0; font-size: 16px; }
    .sketch-wrap { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .sketch-wrap img { max-width: 100%; height: auto; border-radius: 8px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="title">ç¾å ´å“æª¢ï¼ˆAKFï¼‰</h2>

    <!-- ç™»å…¥å€ -->
    <div id="loginView">
      <p class="muted" data-i18n="loginPrompt">è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚</p>
      <div class="row">
        <div>
          <label data-i18n="labelAccount">å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰</label>
          <input id="inspector" />
        </div>
        <div>
          <label data-i18n="labelPassword">å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰</label>
          <input id="passcode" type="password" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" id="btnLogin" data-i18n="btnLogin">ç™»å…¥</button>
        <button class="btn btn-ghost" id="btnResetPass" data-i18n="btnReset">æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„</button>
        <a class="btn btn-ghost" href="/api/inspections?health=1" target="_blank" id="btnHealth" data-i18n="btnHealth">å¥åº·æª¢æŸ¥</a>
        <button class="btn btn-ghost" id="btnLang">ğŸŒ èªè¨€</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- è¡¨å–®å€ï¼ˆinput/admin å¯è¦‹ï¼‰ -->
    <div id="formView" class="hidden">
      <div class="row">
        <div>
          <label data-i18n="labelSupplier">ä¾›æ‡‰å•†</label>
          <select id="supplier"></select>
          <div class="muted" id="supplierEn"></div>
        </div>
        <div>
          <label data-i18n="labelOrderNo">è¨‚å–®è™Ÿç¢¼</label>
          <input id="orderNo" />
        </div>
      </div>
      <div class="row">
        <div>
          <label data-i18n="labelLotNo">ç”Ÿç”¢æ‰¹è™Ÿ</label>
          <input id="lotNo" />
        </div>
        <div>
          <label data-i18n="labelPartNo">æ–™è™Ÿ (Part No.)</label>
          <input id="partNo" />
        </div>
      </div>
      <div class="row">
        <div>
          <label data-i18n="labelDrawingNo">åœ–è™Ÿ (Drawing No.)</label>
          <select id="drawingNo">
            <option value="">è«‹é¸æ“‡åœ–è™Ÿ / Select Drawing</option>
            <option value="AKF-TOF-GRH2021A-3">AKF-TOF-GRH2021A-3</option>
            <option value="AKF-TOF-GRH2021B-3">AKF-TOF-GRH2021B-3</option>
            <option value="AKF-TOF-GRH2021H-4">AKF-TOF-GRH2021H-4</option>
            <option value="AKF-TOF-WXH2059A-2">AKF-TOF-WXH2059A-2</option>
            <option value="AKF-TOF-WXH2059B-2">AKF-TOF-WXH2059B-2</option>
            <option value="AKF-TOF-WXH2059H-2">AKF-TOF-WXH2059H-2</option>
          </select>
        </div>
        <div>
          <label data-i18n="labelMaterial">æè³ª</label>
          <select id="material">
            <option value="">è«‹é¸æ“‡æè³ª / Select Material</option>
            <option value="STEEL">ç¢³é‹¼ (STEEL)</option>
            <option value="STAINLESS STEEL">ä¸é½é‹¼ (STAINLESS STEEL)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label data-i18n="labelSpec">è¦æ ¼</label>
          <select id="spec">
            <option value="">è«‹é¸æ“‡è¦æ ¼ / Select Spec</option>
            <option value="M6X8X25">M6X8X25</option>
            <option value="M8X10X25">M8X10X25</option>
            <option value="M8X10X30">M8X10X30</option>
            <option value="M8X10X40">M8X10X40</option>
            <option value="M10X12X25">M10X12X25</option>
            <option value="M10X12X30">M10X12X30</option>
            <option value="M10X12X40">M10X12X40</option>
            <option value="M12X15X25">M12X15X25</option>
            <option value="M12X15X50">M12X15X50</option>
            <option value="M16X20X65">M16X20X65</option>
          </select>
        </div>
        <div>
          <label data-i18n="labelCategory">ç”¢å“é¡åˆ¥</label>
          <select id="category"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label data-i18n="labelProcess">è£½ç¨‹ (Process)</label>
          <select id="process"></select>
        </div>
        <div>
          <label data-i18n="labelNotes">å‚™è¨»</label>
          <textarea id="notes" rows="2"></textarea>
        </div>
      </div>

      <div class="sketch-box">
        <h3 data-i18n="sketchTitle">åƒè€ƒç°¡åœ–</h3>
        <div class="sketch-wrap">
          <img id="sketchImg" src="final_finished.jpg" alt="åƒè€ƒç°¡åœ– / Reference sketch" style="max-width:100%;">
          <div class="sketch-note" data-i18n="sketchHint">ä¾›æª¢é©—æ™‚å¿«é€Ÿåƒè€ƒä¸»è¦å°ºå¯¸èˆ‡å½¢ç‹€ï¼ˆåœ–æª”ï¼š{file}ï¼‰ã€‚</div>
        </div>
      </div>

      <h3 style="margin-top:20px" data-i18n="sectionTitle">å°ºå¯¸èˆ‡å¤–è§€æª¢é©—</h3>
      <p class="hint" data-i18n="hintAppearance">ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚</p>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:8%"  data-i18n="thCode">ä»£è™Ÿ</th>
            <th style="width:14%" data-i18n="thItem">é …ç›® / å°ºå¯¸åç¨±</th>
            <th style="width:10%" data-i18n="thNominal">æ¨™æº–å€¼</th>
            <th style="width:10%" data-i18n="thTolMinus">ä¸‹é™å…¬å·®</th>
            <th style="width:10%" data-i18n="thTolPlus">ä¸Šé™å…¬å·®</th>
            <th style="width:8%"  data-i18n="thM1">å¯¦æ¸¬1</th>
            <th style="width:8%"  data-i18n="thM2">å¯¦æ¸¬2</th>
            <th style="width:8%"  data-i18n="thM3">å¯¦æ¸¬3</th>
            <th style="width:8%"  data-i18n="thM4">å¯¦æ¸¬4</th>
            <th style="width:8%"  data-i18n="thM5">å¯¦æ¸¬5</th>
            <th style="width:8%"  data-i18n="thDecision">çµæœ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="toolbar">
        <button class="btn btn-ghost" id="btnAdd" data-i18n="btnAdd">ï¼‹æ–°å¢å°ºå¯¸</button>
        <button class="btn btn-ghost" id="btnRemove" data-i18n="btnRemove">ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—</button>
        <button class="btn btn-ghost" id="btnClearRows" data-i18n="btnClearRows">æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰</button>
        <button class="btn btn-ghost" id="btnLang2">ğŸŒ èªè¨€</button>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="btnSave" data-i18n="btnSave">å„²å­˜åˆ°é›²ç«¯</button>
        <a class="btn btn-secondary" href="report.html" id="btnGoReport" data-i18n="btnGoReport">æŸ¥çœ‹/åˆ—å°å ±å‘Š</a>
        <button class="btn btn-ghost" id="btnSaveTpl" data-i18n="btnSaveTpl">é è¨­ç‰ˆå‹å„²å­˜</button>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>

    <p id="viewOnlyTip" class="muted hidden" data-i18n="viewOnlyTip">
      æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚
    </p>
  </div>

  <div class="modal-backdrop" id="langModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:9999;">
    <div class="modal" style="background:#fff;border-radius:12px;padding:16px;width:min(92vw,420px);box-shadow:0 10px 30px rgba(0,0,0,.18)">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€ / Language</h3>
      <p class="muted" data-i18n="langHint">è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š</p>
      <div class="grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

  <script>
  const I18N = {
    'zh-TW': { title:'ç¾å ´å“æª¢ï¼ˆAKFï¼‰', loginPrompt:'è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚', labelAccount:'å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰', labelPassword:'å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰', btnLogin:'ç™»å…¥', btnReset:'æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„', btnHealth:'å¥åº·æª¢æŸ¥', labelSupplier:'ä¾›æ‡‰å•†', labelPartNo:'æ–™è™Ÿ (Part No.)', labelDrawingNo:'åœ–è™Ÿ (Drawing No.)', labelRevision:'ç‰ˆæ¬¡ (Revision)', labelProcess:'è£½ç¨‹ (Process)', labelNotes:'å‚™è¨»', labelOrderNo:'è¨‚å–®è™Ÿç¢¼', labelLotNo:'ç”Ÿç”¢æ‰¹è™Ÿ', labelMaterial:'æè³ª', labelSpec:'è¦æ ¼', labelCategory:'ç”¢å“é¡åˆ¥', sectionTitle:'å°ºå¯¸èˆ‡å¤–è§€æª¢é©—', hintAppearance:'ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚', thItem:'é …ç›® / å°ºå¯¸åç¨±', thCode:'ä»£è™Ÿ', thNominal:'æ¨™æº–å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®', thM1:'å¯¦æ¸¬1', thM2:'å¯¦æ¸¬2', thM3:'å¯¦æ¸¬3', thM4:'å¯¦æ¸¬4', thM5:'å¯¦æ¸¬5', thDecision:'çµæœ', btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—', btnClearRows:'æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰', btnSave:'å„²å­˜åˆ°é›²ç«¯', btnGoReport:'æŸ¥çœ‹/åˆ—å°å ±å‘Š', viewOnlyTip:'æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚', langTitle:'é¸æ“‡èªè¨€ / Language', langHint:'è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š', btnSaveTpl:'é è¨­ç‰ˆå‹å„²å­˜', tplSaving:'å„²å­˜ç‰ˆå‹ä¸­â€¦', tplSaved:'âœ… å·²å„²å­˜ç‚ºé è¨­ç‰ˆå‹', tplFail:'âŒ ç‰ˆå‹å„²å­˜å¤±æ•—ï¼š', tplApplied:'âœ… å·²è‡ªå‹•å¥—ç”¨é è¨­ç‰ˆå‹', tplNoMatch:'ï¼ˆå°šæœªæ‰¾åˆ°å¯å¥—ç”¨çš„é è¨­ç‰ˆå‹ï¼‰', appearanceTitle:'å¤–è§€æª¢æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG', phAccount:'ä¾‹å¦‚ï¼šboss / work1 / QC1', phPassword:'ä¾‹å¦‚ï¼šadmin*** / in*** / view***', phOrderNo:'ä¾‹å¦‚ï¼šPO12345', phLotNo:'ä¾‹å¦‚ï¼š2025-09-A', phMaterial:'ä¾‹å¦‚ï¼šSCM435', phSpec:'ä¾‹å¦‚ï¼šM8 x 30', phCategory:'ä¾‹å¦‚ï¼šèºæ “', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100', phM1:'å¯¦æ¸¬1', phM2:'å¯¦æ¸¬2', phM3:'å¯¦æ¸¬3', phM4:'å¯¦æ¸¬4', phM5:'å¯¦æ¸¬5' },
    'zh-CN': { title:'ç°åœºå“æ£€ï¼ˆAKFï¼‰', loginPrompt:'è¯·è¾“å…¥ã€Œè´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰ã€ä¸ã€Œå¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰ã€ã€‚', labelAccount:'è´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰', labelPassword:'å¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰', btnLogin:'ç™»å½•', btnReset:'æ¸…é™¤æœ¬æœºè®°å½•', btnHealth:'å¥åº·æ£€æŸ¥', labelSupplier:'ä¾›åº”å•†', labelPartNo:'æ–™å· (Part No.)', labelDrawingNo:'å›¾å· (Drawing No.)', labelRevision:'ç‰ˆæ¬¡ (Revision)', labelProcess:'åˆ¶ç¨‹ (Process)', labelNotes:'å¤‡æ³¨', labelOrderNo:'è®¢å•å·ç ', labelLotNo:'ç”Ÿäº§æ‰¹å·', labelMaterial:'æè´¨', labelSpec:'è§„æ ¼', labelCategory:'äº§å“ç±»åˆ«', sectionTitle:'å°ºå¯¸ä¸å¤–è§‚æ£€éªŒ', hintAppearance:'ç¬¬ <strong>1</strong> è¡Œä¸º <strong>å¤–è§‚æ£€æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ <strong>2</strong> è¡Œå¼€å§‹ä¸ºå°ºå¯¸é‡æµ‹ã€‚', thItem:'é¡¹ç›® / å°ºå¯¸åç§°', thCode:'ä»£å·', thNominal:'æ ‡å‡†å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®', thM1:'å®æµ‹1', thM2:'å®æµ‹2', thM3:'å®æµ‹3', thM4:'å®æµ‹4', thM5:'å®æµ‹5', thDecision:'åˆ¤å®š', btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆ é™¤æœ€åä¸€è¡Œ', btnClearRows:'æ¸…ç©ºå°ºå¯¸è¡Œï¼ˆä¿ç•™å¤–è§‚ï¼‰', btnSave:'ä¿å­˜åˆ°äº‘ç«¯', btnGoReport:'æŸ¥çœ‹/æ‰“å°æŠ¥å‘Š', viewOnlyTip:'æ‚¨çš„è´¦å·æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/æ‰“å°ï¼‰ã€‚è¯·å‰å¾€ <a href="report.html">æŠ¥å‘Šé¡µ</a>ã€‚', langTitle:'é€‰æ‹©è¯­è¨€ / Language', langHint:'è¯·é€‰æ‹©ç•Œé¢è¯­è¨€ï¼š', btnSaveTpl:'é¢„è®¾ç‰ˆå‹ä¿å­˜', tplSaving:'ä¿å­˜ç‰ˆå‹ä¸­â€¦', tplSaved:'âœ… å·²ä¿å­˜ä¸ºé¢„è®¾ç‰ˆå‹', tplFail:'âŒ ç‰ˆå‹ä¿å­˜å¤±è´¥ï¼š', tplApplied:'âœ… å·²è‡ªåŠ¨å¥—ç”¨é¢„è®¾ç‰ˆå‹', tplNoMatch:'ï¼ˆå°šæœªæ‰¾åˆ°å¯å¥—ç”¨çš„é¢„è®¾ç‰ˆå‹ï¼‰', appearanceTitle:'å¤–è§‚æ£€æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG', phAccount:'ä¾‹å¦‚ï¼šboss / work1 / QC1', phPassword:'ä¾‹å¦‚ï¼šadmin*** / in*** / view***', phOrderNo:'ä¾‹å¦‚ï¼šPO12345', phLotNo:'ä¾‹å¦‚ï¼š2025-09-A', phMaterial:'ä¾‹å¦‚ï¼šSCM435', phSpec:'ä¾‹å¦‚ï¼šM8 x 30', phCategory:'ä¾‹å¦‚ï¼šèºæ “', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100', phM1:'å®æµ‹1', phM2:'å®æµ‹2', phM3:'å®æµ‹3', phM4:'å®æµ‹4', phM5:'å®æµ‹5' },
    'en':    { title:'On-site QC (Anchor)', loginPrompt:'Please enter â€œAccount (Inspector)â€ and â€œPasswordâ€.', labelAccount:'Account (Inspector)', labelPassword:'Password', btnLogin:'Sign in', btnReset:'Clear local data', btnHealth:'Health Check', labelSupplier:'Supplier', labelPartNo:'Part No.', labelDrawingNo:'Drawing No.', labelRevision:'Revision', labelProcess:'Process', labelNotes:'Notes', labelOrderNo:'Order No.', labelLotNo:'Lot No.', labelMaterial:'Material', labelSpec:'Spec', labelCategory:'Product Category', sectionTitle:'Appearance & Dimensional Inspection', hintAppearance:'Row <strong>1</strong> is <strong>Appearance</strong> (optional). From row <strong>2</strong> onwards are dimensions.', thItem:'Item / Dimension', thCode:'Code', thNominal:'Nominal', thTolMinus:'Lower Tol.', thTolPlus:'Upper Tol.', thM1:'Sample1', thM2:'Sample2', thM3:'Sample3', thM4:'Sample4', thM5:'Sample5', thDecision:'Decision', btnAdd:'ï¼‹Add dimension', btnRemove:'ï¼Remove last row', btnClearRows:'Clear dimension rows (keep appearance)', btnSave:'Save to cloud', btnGoReport:'View/Print Reports', viewOnlyTip:'Your role is <strong>viewer</strong> (view/print only). Go to <a href="report.html">Reports</a>.', langTitle:'Choose language', langHint:'Select UI language:', btnSaveTpl:'Save as Template', tplSaving:'Saving templateâ€¦', tplSaved:'âœ… Template saved', tplFail:'âŒ Template save failed:', tplApplied:'âœ… Autoâ€‘applied template', tplNoMatch:'(no matching template yet)', appearanceTitle:'Appearance', optionDash:'â€”', optionOK:'O.K', optionNG:'NG', phAccount:'e.g. boss / work1 / QC1', phPassword:'e.g. admin*** / in*** / view***', phOrderNo:'e.g. PO12345', phLotNo:'e.g. 2025-09-A', phMaterial:'e.g. SCM435', phSpec:'e.g. M8 x 30', phCategory:'e.g. Bolt', phNominal:'e.g. 3.000', phTolMinus:'e.g. -0.100', phTolPlus:'e.g. 0.100', phM1:'Sample1', phM2:'Sample2', phM3:'Sample3', phM4:'Sample4', phM5:'Sample5' }
  };
  function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
  function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
  function selectLang(lang){ setLang(lang); closeLangModal(); }
  function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
  function closeLangModal(){ document.getElementById('langModal').style.display='none'; }
  function t(key){ const lang = getLang(); const dict = I18N[lang] || I18N['zh-TW']; return dict[key] ?? (I18N['zh-TW'][key] ?? key); }

  const SUPPLIERS = [{ code:'å®‰å¯', zh:'å®‰å¯', en:'AKF' },{ code:'å®‰æ‹“', zh:'å®‰æ‹“', en:'ANCHOR' }];
  const PROCESSES = [{ code:'WIRE', zh:'ç·šæ', en:'WIRE' },{ code:'FORMING', zh:'æˆå½¢', en:'FORMING' },{ code:'TAPING', zh:'æ”»ç‰™', en:'TAPING' },{ code:'CUTTING', zh:'å‰²æº', en:'CUTTING' },{ code:'PLATING', zh:'é›»é', en:'PLATING' },{ code:'FINISHED', zh:'æˆå“', en:'FINISHED' },{ code:'ASSEMBLY', zh:'çµ„ç«‹', en:'ASSEMBLY' },{ code:'FINAL', zh:'æœ€çµ‚æˆå“', en:'FINAL FINISHED' }];
  const CATEGORIES = [{ code:'PLUG', zh:'å¡å­', en:'plug' },{ code:'SLEEVE_A', zh:'ç®¡å­_A type', en:'sleeve_A type' },{ code:'SLEEVE_B', zh:'ç®¡å­_B type', en:'sleeve_B type' },{ code:'SLEEVE_H', zh:'ç®¡å­_H type', en:'sleeve_H type' },{ code:'FINISHED_A', zh:'æˆå“_A type', en:'Finished_A type' },{ code:'FINISHED_B', zh:'æˆå“_B type', en:'Finished_B type' },{ code:'FINISHED_H', zh:'æˆå“_H type', en:'Finished_H type' },{ code:'TOOL', zh:'å…§è¿«å·¥å…·', en:'special tool' }];

  function fillSupplierSelect(){ const sel = document.getElementById('supplier'); if (!sel) return; sel.innerHTML = SUPPLIERS.map(s=>`<option value="${s.code}" data-zh="${s.zh}" data-en="${s.en}">${s.zh} (${s.en})</option>`).join(''); const hint = document.getElementById('supplierEn'); sel.onchange = ()=>{ const opt = sel.options[sel.selectedIndex]; hint.textContent = opt ? `English: ${opt.dataset.en}` : ''; updateSketchByCategory(); tryAutoApply(); }; sel.dispatchEvent(new Event('change')); }
  function fillProcessSelect(){ const sel = document.getElementById('process'); if (!sel) return; sel.innerHTML = '<option value=""></option>' + PROCESSES.map(p=>`<option value="${p.code}" data-zh="${p.zh}" data-en="${p.en}">${p.zh} (${p.en})</option>`).join(''); }
  function fillCategorySelect(){ const sel = document.getElementById('category'); if (!sel) return; const prev = sel.value; sel.innerHTML = '<option value=""></option>' + CATEGORIES.map(c=>`<option value="${c.code}">${c.zh} (${c.en})</option>`).join(''); if (prev) sel.value = prev; sel.onchange = ()=>{ updateSketchByCategory(); tryAutoApply(); }; updateSketchByCategory(); }
  function getSketchFileForCategory(code){ switch(String(code||'').toUpperCase()){ case 'PLUG': return 'plug.jpg'; case 'TOOL': return 'special_tool.jpg'; case 'SLEEVE_A': return 'sleeve_A.jpg'; case 'SLEEVE_B': return 'sleeve_B.jpg'; case 'SLEEVE_H': return 'sleeve_H.jpg'; case 'FINISHED_A': return 'finish_A.jpg'; case 'FINISHED_B': return 'finish_A.jpg'; case 'FINISHED_H': return 'finish_H.jpg'; default: return 'final_finished.jpg'; } }
  function updateSketchByCategory(){ const sel = document.getElementById('category'); const file = getSketchFileForCategory(sel ? sel.value : ''); const img = document.getElementById('sketchImg'); if (img) img.src = file; const note = document.querySelector('.sketch-note'); if (note){ const base = t('sketchHint'); note.innerHTML = String(base||'').replace('{file}', file); } }

  const tbody = document.getElementById('tbody');
  function ensureAppearanceRow(){ if (!tbody.querySelector('tr[data-type="appearance"]')){ const tr = document.createElement('tr'); tr.dataset.type = 'appearance'; tr.innerHTML = `<td></td><td><strong data-i18n="appearanceTitle">${t('appearanceTitle')}</strong></td><td colspan="3" class="muted">ï¼ˆå¯ç•™ç©ºï¼‰</td><td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td><td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td><td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td><td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td><td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td><td></td>`; tbody.appendChild(tr); updateDecisionForRow(tr); } }
  function addMeasureRow(){ const tr = document.createElement('tr'); tr.dataset.type = 'measure'; tr.innerHTML = `<td><input class="code" /></td><td><input class="name" /></td><td><input class="nom" type="number" step="0.001" placeholder="${t('phNominal')}" /></td><td><input class="lo" type="number" step="0.001" placeholder="${t('phTolMinus')}" /></td><td><input class="hi" type="number" step="0.001" placeholder="${t('phTolPlus')}" /></td><td><input class="m m1" type="number" step="0.001" placeholder="${t('phM1')}" /></td><td><input class="m m2" type="number" step="0.001" placeholder="${t('phM2')}" /></td><td><input class="m m3" type="number" step="0.001" placeholder="${t('phM3')}" /></td><td><input class="m m4" type="number" step="0.001" placeholder="${t('phM4')}" /></td><td><input class="m m5" type="number" step="0.001" placeholder="${t('phM5')}" /></td><td></td>`; tbody.appendChild(tr); updateDecisionForRow(tr); }
  function countMeasureRows(){ return tbody.querySelectorAll('tr[data-type="measure"]').length; }
  function ensureMeasureRows(n){ while (countMeasureRows() < n) addMeasureRow(); }
  function clearMeasureRows(){ tbody.querySelectorAll('tr[data-type="measure"]').forEach(tr=>tr.remove()); }
  function removeLastMeasureRow(){ const rows = tbody.querySelectorAll('tr[data-type="measure"]'); if (rows.length) rows[rows.length-1].remove(); }

  function decidePass(nom, lo, hi, measured){ const hasNom = (nom===0 || nom) && !isNaN(Number(nom)); const hasLo = (lo===0 || lo) && !isNaN(Number(lo)); const hasHi = (hi===0 || hi) && !isNaN(Number(hi)); const vals = Array.isArray(measured) ? measured.filter(v => v===0 || v).map(Number) : []; if (!(hasNom && hasLo && hasHi) || vals.length===0) return undefined; const min = Number(nom)+Number(lo), max = Number(nom)+Number(hi); return vals.every(v => v>=min && v<=max); }
  function updateDecisionForRow(tr){ const type = (tr && tr.dataset.type) || ''; if (type !== 'measure') return; const nom = Number(tr.querySelector('.nom')?.value || ''); const lo = Number(tr.querySelector('.lo')?.value || ''); const hi = Number(tr.querySelector('.hi')?.value || ''); const ms = [...tr.querySelectorAll('.m')].map(i=>i.value).filter(v=>v!==''); const res = decidePass(nom, lo, hi, ms); const td = tr.querySelector('td:last-child'); if (!td) return; td.innerHTML = res===undefined ? '' : `<span class="tag ${res?'pass':'fail'}">${res?'PASS':'FAIL'}</span>`; }

  let AUTH = null; let TEMPLATES = [];
  function headers(){ const h={ 'Content-Type':'application/json' }; if (!AUTH) return h; if (AUTH.mode==='accounts'){ h['x-user']=AUTH.user||''; h['x-pass']=AUTH.pass||''; } if (AUTH.mode==='passcode'){ h['x-passcode']=AUTH.passcode||''; h['x-user']=AUTH.user||''; } return h; }
  async function loadTemplates(){ try{ const r = await fetch('/api/inspections?templates=1', { headers: headers() }); const j = await r.json().catch(()=>({})); if (j && j.ok && Array.isArray(j.templates)) TEMPLATES = j.templates; }catch(e){ console.warn('loadTemplates failed', e); } }
  function keyOf(obj){ const fields = ['supplier','partNo','drawingNo','material','spec','category','process']; const out = {}; fields.forEach(k => { const v = String(obj[k]||'').trim(); if (v) out[k]=v; }); return out; }
  function scoreMatch(tplKey, currentKey){ let s = 0; for (const k of Object.keys(currentKey)){ if (tplKey[k] && String(tplKey[k]).toUpperCase() === String(currentKey[k]).toUpperCase()) s++; } return s; }
  function hasAnyMeasuredValue(){ return !!tbody.querySelector('tr[data-type="measure"] input.m[value]:not([value=""])'); }

  function applyTemplate(tpl){ if (!tpl) return; ensureAppearanceRow(); if (Array.isArray(tpl.appearance) && tpl.appearance.length){ const aps = tbody.querySelectorAll('tr[data-type="appearance"] select.ap'); aps.forEach((sel, i)=>{ sel.value = tpl.appearance[i] || ''; }); } if (hasAnyMeasuredValue()) return; clearMeasureRows(); const defs = Array.isArray(tpl.measurements) ? tpl.measurements : []; ensureMeasureRows(defs.length || 1); const rows = tbody.querySelectorAll('tr[data-type="measure"]'); defs.forEach((d, idx)=>{ const tr = rows[idx] || rows[rows.length-1]; if (!tr) return; tr.querySelector('.code').value = d.code || ''; tr.querySelector('.name').value = d.name || ''; tr.querySelector('.nom').value = d.nom ?? ''; tr.querySelector('.lo').value = d.lo ?? ''; tr.querySelector('.hi').value = d.hi ?? ''; updateDecisionForRow(tr); }); }

  function tryAutoApply(){ const current = { supplier: document.getElementById('supplier').value, partNo: document.getElementById('partNo').value, drawingNo:document.getElementById('drawingNo').value, material: document.getElementById('material').value, spec: document.getElementById('spec').value, category: document.getElementById('category').value, process: document.getElementById('process').value }; const currentKey = keyOf(current); if (!Object.keys(currentKey).length) return; let best = null, bestScore = 0; for (const t of TEMPLATES){ if (!(Array.isArray(t.measurements) && t.measurements.length)) continue; const s = scoreMatch(t.key || keyOf(t), currentKey); if (s > bestScore){ best = t; bestScore = s; } } if (best && bestScore >= 2){ applyTemplate(best); showMsg(t('tplApplied')); } }
  function collectRecord(){ ensureAppearanceRow(); const aps = [...tbody.querySelectorAll('tr[data-type="appearance"] select.ap')].map(s=>s.value||''); const ms  = [...tbody.querySelectorAll('tr[data-type="measure"]')].map(tr => ({ code: tr.querySelector('.code')?.value || '', name: tr.querySelector('.name')?.value || '', nom: tr.querySelector('.nom')?.value || '', lo: tr.querySelector('.lo')?.value || '', hi: tr.querySelector('.hi')?.value || '' })); return { supplier: document.getElementById('supplier').value, supplierEn: document.getElementById('supplierEn').textContent || '', partNo: document.getElementById('partNo').value, drawingNo:document.getElementById('drawingNo').value, orderNo: document.getElementById('orderNo').value, lotNo: document.getElementById('lotNo').value, material: document.getElementById('material').value, spec: document.getElementById('spec').value, category: document.getElementById('category').value, process: document.getElementById('process').value, notes: document.getElementById('notes').value, appearance: aps, measurements: ms }; }
  async function saveTemplate(){ const record = collectRecord(); const tpl = { type:'template', key: keyOf(record), appearance: record.appearance, measurements: record.measurements }; showMsg(t('tplSaving')); const r = await fetch('/api/inspections?template=1', { method:'POST', headers: headers(), body: JSON.stringify({ template: tpl }) }); const j = await r.json().catch(()=>({})); if (j && j.ok){ showMsg(t('tplSaved')); await loadTemplates(); } else { showErr(t('tplFail') + (j && j.error ? j.error : r.status)); } }

  const loginView = document.getElementById('loginView'); const formView  = document.getElementById('formView'); const viewOnlyTip = document.getElementById('viewOnlyTip');
  function showMsg(s){ const el=document.getElementById('msg'); if (el) el.textContent = s || ''; }
  function showErr(s){ const el=document.getElementById('msg'); if (el) el.textContent = s || ''; el.classList.add('error'); }

  async function login(){ const user = document.getElementById('inspector').value.trim(); const pass = document.getElementById('passcode').value.trim(); if (!user || !pass){ document.getElementById('loginMsg').textContent = 'è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼/é€šé—œç¢¼'; return; } document.getElementById('loginMsg').textContent = 'é©—è­‰ä¸­â€¦'; const h = { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }; try{ const r = await fetch('/api/inspections?auth=1', { headers: h }); const j = await r.json(); if (j && j.ok){ AUTH = { ...j, user, pass, passcode: pass }; sessionStorage.setItem('qci_auth', JSON.stringify(AUTH)); loginView.classList.add('hidden'); if (j.role === 'viewer'){ viewOnlyTip.classList.remove('hidden'); } else { formView.classList.remove('hidden'); } applyI18n(); await loadTemplates(); bindAutoApplyListeners(); tryAutoApply(); } else { document.getElementById('loginMsg').textContent = 'ç™»å…¥å¤±æ•—'; } }catch(e){ document.getElementById('loginMsg').textContent = 'ç™»å…¥å¤±æ•—'; } }

  function applyI18n(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k = el.getAttribute('data-i18n'); if (k) el.innerHTML = t(k); }); const ph = { '#inspector':'phAccount','#passcode':'phPassword', '#orderNo':'phOrderNo','#lotNo':'phLotNo','#material':'phMaterial','#spec':'phSpec','#category':'phCategory' }; Object.entries(ph).forEach(([sel,key])=>{ const el=document.querySelector(sel); if (el) el.placeholder=t(key); }); fillSupplierSelect(); fillProcessSelect(); fillCategorySelect(); }
  function bindAutoApplyListeners(){ const ids = ['supplier','partNo','drawingNo','material','spec','category','process']; ids.forEach(id => { const el = document.getElementById(id); if (!el) return; el.addEventListener('change', tryAutoApply, { passive:true }); el.addEventListener('blur', tryAutoApply, { passive:true }); if (el.tagName === 'INPUT') el.addEventListener('input', tryAutoApply, { passive:true }); }); }

  document.getElementById('btnLogin').addEventListener('click', login);
  document.getElementById('btnResetPass').addEventListener('click', ()=>{ localStorage.clear(); sessionStorage.clear(); location.reload(); });
  document.getElementById('btnLang').addEventListener('click', ()=>{ document.getElementById('langModal').style.display='flex'; });
  document.getElementById('btnLang2').addEventListener('click', ()=>{ document.getElementById('langModal').style.display='flex'; });
  document.getElementById('btnAdd').addEventListener('click', ()=>{ addMeasureRow(); });
  document.getElementById('btnRemove').addEventListener('click', removeLastMeasureRow);
  document.getElementById('btnClearRows').addEventListener('click', ()=>{ clearMeasureRows(); ensureMeasureRows(1); });
  document.getElementById('btnSaveTpl').addEventListener('click', saveTemplate);

  (function init(){ applyI18n(); const cached = sessionStorage.getItem('qci_auth'); if (cached){ try { AUTH = JSON.parse(cached); } catch {} if (AUTH && AUTH.role){ loginView.classList.add('hidden'); if (AUTH.role === 'viewer') viewOnlyTip.classList.remove('hidden'); else formView.classList.remove('hidden'); loadTemplates().then(()=>{ bindAutoApplyListeners(); tryAutoApply(); }); } } })();
  </script>
</body>
</html>
