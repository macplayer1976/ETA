<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>現場品檢（安拓）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; background:#fafafa; }
    .card { max-width: 1120px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h2 { margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pass { background: #e7f7ec; color: #116329; }
    .fail { background: #fde8e8; color: #c02020; }
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }
    .btn-ghost { background: #f3f4f6; color:#111827; }
    .muted { color: #6b7280; font-size: 13px; }
    .error { color: #b91c1c; }
    .hidden { display: none; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    a.btn { text-decoration: none; display:inline-block; }
    .hint { margin: 6px 0 0; color:#6b7280; font-size:13px; }
    td.disabled input { background:#fafafa; color:#9ca3af; }
  </style>
</head>
<body>
  <div class="card">
    <h2>現場品檢（安拓）</h2>

    <!-- 登入區 -->
    <div id="loginView">
      <p class="muted">請輸入「帳號（檢驗人員）」與「密碼（通關碼/密碼）」。</p>
      <div class="row">
        <div>
          <label>帳號（檢驗人員）</label>
          <input id="inspector" placeholder="例如：boss / worker1 / qa1" />
        </div>
        <div>
          <label>密碼（通關碼/密碼）</label>
          <input id="passcode" type="password" placeholder="例如：admin123 / in1111 / view2222" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" id="btnLogin">登入</button>
        <button class="btn btn-ghost" id="btnResetPass">清除本機記錄</button>
        <a class="btn btn-ghost" href="/api/inspections?health=1" target="_blank">健康檢查</a>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- 表單區（input/admin 可見） -->
    <div id="formView" class="hidden">
      <div class="row">
        <div>
          <label>供應商</label>
          <input id="supplier" placeholder="例如：XX 表面處理廠" />
        </div>
        <div>
          <label>料號 (Part No.)</label>
          <input id="partNo" placeholder="例如：RT138" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>圖號 (Drawing No.)</label>
          <input id="drawingNo" placeholder="例如：WKNO137-6" />
        </div>
        <div>
          <label>版次 (Revision)</label>
          <input id="revision" placeholder="例如：Rev.B" />
        </div>
      </div>
      <div style="margin-top:12px">
        <label>備註</label>
        <textarea id="notes" rows="2" placeholder="例如：現場尺寸穩定/外觀無瑕疵"></textarea>
      </div>

      <!-- 整合表：第1列＝外觀（可略過）；第2列起＝尺寸 -->
      <h3 style="margin-top:20px">尺寸與外觀檢驗</h3>
      <p class="hint">第 <strong>1</strong> 列為 <strong>外觀檢查</strong>（可留空）；從第 <strong>2</strong> 列開始為尺寸量測。</p>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:14%">項目 / 尺寸名稱</th>
            <th style="width:10%">名目值</th>
            <th style="width:10%">下限公差</th>
            <th style="width:10%">上限公差</th>
            <th style="width:8%">實測1</th>
            <th style="width:8%">實測2</th>
            <th style="width:8%">實測3</th>
            <th style="width:8%">實測4</th>
            <th style="width:8%">實測5</th>
            <th style="width:8%">結果</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="toolbar">
        <button class="btn btn-ghost" id="btnAdd">＋新增尺寸</button>
        <button class="btn btn-ghost" id="btnRemove">－刪除最後一列</button>
        <button class="btn btn-ghost" id="btnClearRows">清空尺寸列（保留外觀）</button>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="btnSave">儲存到雲端</button>
        <a class="btn btn-secondary" href="report.html">查看/列印報告</a>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>

    <!-- viewer 提示 -->
    <p id="viewOnlyTip" class="muted hidden">
      您的角色是 <strong>viewer</strong>（只能看/印報告）。請改到 <a href="report.html">報告頁</a>。
    </p>
  </div>

  <script>
    const loginView = document.getElementById('loginView');
    const formView  = document.getElementById('formView');
    const inspector = document.getElementById('inspector');
    const passcode  = document.getElementById('passcode');
    const loginMsg  = document.getElementById('loginMsg');
    const viewOnlyTip = document.getElementById('viewOnlyTip');

    const tbody = document.getElementById('tbody');
    const msg   = document.getElementById('msg');

    document.getElementById('btnLogin').addEventListener('click', onLogin);
    document.getElementById('btnResetPass').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector'].forEach(k => localStorage.removeItem(k));
      alert('本機登入資訊已清除。');
    });

    // 表格按鈕
    document.getElementById('btnAdd').addEventListener('click', addMeasureRow);
    document.getElementById('btnRemove').addEventListener('click', removeLastMeasureRow);
    document.getElementById('btnClearRows').addEventListener('click', () => { clearMeasureRows(); ensureMeasureRows(2); });

    document.getElementById('btnSave').addEventListener('click', save);

    // 自動驗證
    window.addEventListener('DOMContentLoaded', async () => {
      const u = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      const p = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (u) inspector.value = u;
      if (p) passcode.value = p;

      if (u && p) {
        loginMsg.textContent = '自動驗證中...';
        const info = await authCheck(u, p);
        if (info && info.ok) {
          localStorage.setItem('qci_user', u);
          localStorage.setItem('qci_pass', p);
          localStorage.setItem('qci_role', info.role);
          showByRole(info.role);
          if (info.role !== 'viewer') {
            ensureAppearanceRow();                  // 外觀列（可留空）
            if (countMeasureRows() === 0) ensureMeasureRows(2); // 預設兩列尺寸
          }
          loginMsg.textContent = '';
          return;
        }
        loginMsg.innerHTML = '<span class="error">❌ 帳號或密碼已變更，請重新登入。</span>';
      }
    });

    async function onLogin() {
      const u = inspector.value.trim();
      const p = passcode.value.trim();
      if (!u || !p) { loginMsg.innerHTML = '<span class="error">請輸入帳號與密碼</span>'; return; }

      loginMsg.textContent = '驗證中...';
      const info = await authCheck(u, p);
      if (!info || !info.ok) {
        loginMsg.innerHTML = '<span class="error">❌ 帳號或密碼錯誤</span>'; return;
      }

      localStorage.setItem('qci_user', u);
      localStorage.setItem('qci_pass', p);
      localStorage.setItem('qci_role', info.role);
      localStorage.setItem('qci_inspector', u);
      localStorage.setItem('qci_passcode', p);

      showByRole(info.role);
      if (info.role !== 'viewer') {
        ensureAppearanceRow();
        if (countMeasureRows() === 0) ensureMeasureRows(2);
      }
      loginMsg.textContent = '';
    }

    function showByRole(role) {
      if (role === 'viewer') {
        loginView.classList.add('hidden');
        formView.classList.add('hidden');
        viewOnlyTip.classList.remove('hidden');
      } else {
        loginView.classList.add('hidden');
        formView.classList.remove('hidden');
        viewOnlyTip.classList.add('hidden');
      }
    }

    async function authCheck(user, pass) {
      try {
        const res = await fetch('/api/inspections?auth=1', {
          headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }
        });
        const t = await res.text();
        let j = {}; try { j = JSON.parse(t); } catch {}
        return { ok: res.ok && j.ok, role: j.role || 'admin', mode: j.mode || 'passcode' };
      } catch { return null; }
    }

    /* ======== 外觀（第1列，可留空） + 尺寸（第2列起） ======== */

    function ensureAppearanceRow() {
      if (tbody.querySelector('tr[data-type="appearance"]')) return;
      const tr = document.createElement('tr');
      tr.dataset.type = 'appearance';
      tr.innerHTML = `
        <td><strong>外觀檢查</strong></td>
        <td class="disabled"><input value="" placeholder="—" disabled /></td>
        <td class="disabled"><input value="" placeholder="—" disabled /></td>
        <td class="disabled"><input value="" placeholder="—" disabled /></td>
        <td>${buildApSelect('ap1')}</td>
        <td>${buildApSelect('ap2')}</td>
        <td>${buildApSelect('ap3')}</td>
        <td>${buildApSelect('ap4')}</td>
        <td>${buildApSelect('ap5')}</td>
        <td><span class="tag">—</span></td>
      `;
      tr.querySelectorAll('select.ap').forEach(s => s.addEventListener('change', () => updateAppearanceRow(tr)));
      tbody.prepend(tr);
    }
    function buildApSelect(id){
      return `
        <select id="${id}" class="ap">
          <option value="">—</option>
          <option value="OK">O.K</option>
          <option value="NG">NG</option>
        </select>`;
    }

    function updateAppearanceRow(tr) {
      const sels = [...tr.querySelectorAll('select.ap')];
      const values = sels.map(s => (s.value || '').toUpperCase()).filter(Boolean);
      const tag = tr.querySelector('.tag');

      if (values.length === 0) { tag.textContent = '—'; tag.className = 'tag'; return; }
      const pass = values.every(v => v === 'OK');
      tag.textContent = pass ? 'PASS' : 'FAIL';
      tag.className = 'tag ' + (pass ? 'pass' : 'fail');
    }

    function countMeasureRows() {
      return [...tbody.querySelectorAll('tr')].filter(tr => tr.dataset.type !== 'appearance').length;
    }

    function ensureMeasureRows(n) { for (let i=0; i<n; i++) addMeasureRow(); }

    function addMeasureRow() {
      const tr = document.createElement('tr');
      tr.dataset.type = 'measure';
      tr.innerHTML = `
        <td><input placeholder="例：頭部厚度" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="例：3.000" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="例：-0.100" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="例：0.100" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="實測1" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="實測2" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="實測3" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="實測4" /></td>
        <td><input type="number" inputmode="decimal" step="0.001" placeholder="實測5" /></td>
        <td><span class="tag">—</span></td>
      `;
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => updateMeasureRow(tr)));
      tbody.appendChild(tr);
    }

    function removeLastMeasureRow(){
      const rows = [...tbody.querySelectorAll('tr')].filter(tr => tr.dataset.type !== 'appearance');
      const last = rows[rows.length - 1];
      if (last) tbody.removeChild(last);
    }

    function clearMeasureRows() {
      [...tbody.querySelectorAll('tr')].forEach(tr => { if (tr.dataset.type !== 'appearance') tr.remove(); });
    }

    function updateMeasureRow(tr) {
      const inputs = [...tr.querySelectorAll('input')].map(i => i.value);
      const [name, nominal, tolMinus, tolPlus, m1, m2, m3, m4, m5] = inputs;
      const tag = tr.querySelector('.tag');

      if (nominal === '' || tolMinus === '' || tolPlus === '') {
        tag.textContent = '—'; tag.className = 'tag'; return;
      }
      const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus);
      const arr = [m1, m2, m3, m4, m5].filter(s => s !== '');
      if (arr.length === 0) { tag.textContent = '—'; tag.className = 'tag'; return; }

      let ok = true;
      for (const s of arr) {
        const m = parseFloat(s); const dev = m - n;
        if (!(dev >= lo && dev <= hi)) { ok = false; break; }
      }
      tag.textContent = ok ? 'PASS' : 'FAIL';
      tag.className = 'tag ' + (ok ? 'pass' : 'fail');
    }

    /* ========= 儲存 ========= */
    async function save() {
      const role = (localStorage.getItem('qci_role') || '').toLowerCase();
      if (role === 'viewer') { alert('viewer 沒有上傳權限'); return; }

      const record = buildRecord(); if (!record) return;
      msg.textContent = '儲存中...';
      const btn = document.getElementById('btnSave'); btn.disabled = true;

      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      const code = pass;

      try {
        const res = await fetch('/api/inspections', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json','x-user': user,'x-pass': pass,'x-passcode': code },
          body: JSON.stringify({ record })
        });
        const text = await res.text();
        if (!res.ok) {
          if (res.status === 401) { showLogin('❌ 登入過期，請重新登入。'); }
          throw new Error(`HTTP ${res.status}；訊息：${text || '（無訊息）'}`);
        }
        msg.textContent = '✅ 已儲存到雲端（可到報告頁查看/列印）';
        // 重置：外觀清空、尺寸重建
        tbody.querySelectorAll('tr[data-type="appearance"] select.ap').forEach(s => s.value = '');
        const apTag = tbody.querySelector('tr[data-type="appearance"] .tag');
        if (apTag) { apTag.textContent = '—'; apTag.className = 'tag'; }
        clearMeasureRows(); ensureMeasureRows(2);
      } catch (e) {
        msg.textContent = '❌ 儲存失敗：' + e.message;
      } finally { btn.disabled = false; }
    }

    function showLogin(s){ loginView.classList.remove('hidden'); formView.classList.add('hidden'); if (s) loginMsg.innerHTML = '<span class="error">'+s+'</span>'; }

    function buildRecord() {
      const inspectorName = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      if (!inspectorName || !pass) { showLogin('請先登入'); return null; }

      const supplier = document.getElementById('supplier').value.trim();
      const partNo = document.getElementById('partNo').value.trim();
      const drawingNo = document.getElementById('drawingNo').value.trim();
      const revision = document.getElementById('revision').value.trim();
      const notes = document.getElementById('notes').value.trim();
      if (!supplier || !partNo) { alert('請輸入供應商與料號'); return null; }

      const rows = [...tbody.querySelectorAll('tr')];

      // 1) 外觀列（可完全留空）
      const apRow = rows.find(tr => tr.dataset.type === 'appearance');
      const sels = apRow ? [...apRow.querySelectorAll('select.ap')] : [];
      const apValues = sels.map((s, i) => ({ i: i+1, v: (s.value || '').toUpperCase() })).filter(x => x.v);
      const appearance = apValues.map(x => ({ sample: `樣品${x.i}`, result: x.v, note: '' }));
      const hasAppearance = appearance.length > 0;
      const appearancePass = !hasAppearance || appearance.every(x => x.result === 'OK'); // 空白=不影響

      // 2) 尺寸列
      const measureRows = rows.filter(tr => tr.dataset.type !== 'appearance');
      const measurements = [];
      let allDimPass = true;

      for (const tr of measureRows) {
        const inputs = [...tr.querySelectorAll('input')].map(i => i.value.trim());
        const [name, nominal, tolMinus, tolPlus, m1, m2, m3, m4, m5] = inputs;

        if (!name && !nominal && !tolMinus && !tolPlus && !m1 && !m2 && !m3 && !m4 && !m5) continue;
        if (!name || !nominal || !tolMinus || !tolPlus) { alert('尺寸表有未填欄位（名稱/名目/公差）'); return null; }

        const arrRaw = [m1, m2, m3, m4, m5].filter(s => s !== '');
        if (arrRaw.length === 0) { alert('每列尺寸至少填一個「實測」'); return null; }

        const n = parseFloat(nominal), lo = parseFloat(tolMinus), hi = parseFloat(tolPlus);
        const arr = arrRaw.map(s => parseFloat(s));

        let passRow = true;
        for (const m of arr) { const dev = m - n; if (!(dev >= lo && dev <= hi)) { passRow = false; break; } }
        if (!passRow) allDimPass = false;

        measurements.push({ name, nominal:n, tolMinus:lo, tolPlus:hi, measured:arr, pass:passRow });
      }
      if (measurements.length === 0) { alert('至少需要一筆尺寸資料'); return null; }

      // 總結果：外觀（若有填才計入）＋ 尺寸
      const overall = (allDimPass && appearancePass) ? 'PASS' : 'FAIL';

      const now = new Date();
      const id = `INS-${now.toISOString().slice(0,19).replace(/[-:T]/g,'')}-${Math.floor(Math.random()*900+100)}`;
      const isoLocal = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString();
      return {
        id, timestamp: isoLocal, inspector: inspectorName,
        supplier, partNo, drawingNo, revision, notes,
        measurements,
        appearance,                  // 可能是 []（外觀留空）
        overallResult: overall
      };
    }
  </script>
</body>
</html>
