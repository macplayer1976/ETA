<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="title">ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; background:#fafafa; }
    .card { max-width: 1160px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h2 { margin-top:0; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    label { font-size: 14px; color: #333; display:block; margin-bottom:4px; }
    input, textarea, select { width:100%; padding:10px; font-size:16px; border:1px solid #cbd5e1; border-radius:10px; box-sizing:border-box; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f7f7f7; }
    .btn { padding:12px 16px; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-ghost { background:#f3f4f6; color:#111827; }
    .muted { color:#6b7280; font-size:13px; }
    .hidden { display:none !important; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    a.btn { text-decoration:none; display:inline-block; }
    .sketch-box { margin: 12px 0 6px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background:#f9fafb; }
    .sketch-box h3 { margin: 0 0 6px 0; font-size: 16px; }
    .sketch-wrap { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .sketch-wrap img { max-width: 100%; height: auto; border-radius: 8px; border:1px solid #e5e7eb; }
    .pass { background:#e7f7ec; color:#116329; }
    .fail { background:#fde8e8; color:#c02020; }
  </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="title">ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰</h2>

    <!-- ç™»å…¥å€ -->
    <div id="loginView">
      <p class="muted" data-i18n="loginPrompt">è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚</p>
      <div class="grid-2">
        <div>
          <label data-i18n="labelAccount">å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰</label>
          <input id="inspector" />
        </div>
        <div>
          <label data-i18n="labelPassword">å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰</label>
          <input id="passcode" type="password" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" id="btnLogin" data-i18n="btnLogin">ç™»å…¥</button>
        <button class="btn btn-ghost" id="btnResetPass" data-i18n="btnReset">æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„</button>
        <a class="btn btn-ghost" href="/api/inspections?health=1" target="_blank" id="btnHealth" data-i18n="btnHealth">å¥åº·æª¢æŸ¥</a>
        <button class="btn btn-ghost" id="btnLang">ğŸŒ èªè¨€</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- è¡¨å–®å€ -->
    <div id="formView" class="hidden">
      <!-- åŸºæœ¬è³‡æ–™ï¼ˆæ–°ç‰ˆï¼‰ -->
      <h3 data-i18n="basicTitle">åŸºæœ¬è³‡æ–™</h3>
      <div class="grid-3">
        <div>
          <label data-i18n="labelSupplier">ä¾›æ‡‰å•†</label>
          <select id="supplier"></select>
          <div class="muted" id="supplierEn"></div>
        </div>
        <div>
          <label data-i18n="labelOrder">è¨‚å–®è™Ÿç¢¼</label>
          <input id="orderNo" />
        </div>
        <div>
          <label data-i18n="labelLot">ç”Ÿç”¢æ‰¹è™Ÿ</label>
          <input id="lotNo" />
        </div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div>
          <label data-i18n="labelPartNo">ç”¢å“æ–™è™Ÿ</label>
          <input id="partNo" />
        </div>
        <div>
          <label data-i18n="labelDrawingNo">åœ–è™Ÿ</label>
          <input id="drawingNo" />
        </div>
        <div>
          <label data-i18n="labelMaterial">æè³ª</label>
          <select id="material"></select>
        </div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div>
          <label data-i18n="labelSpec">è¦æ ¼</label>
          <select id="spec"></select>
        </div>
        <div>
          <label data-i18n="labelProductType">ç”¢å“é¡åˆ¥</label>
          <select id="productType"></select>
        </div>
        <div>
          <label data-i18n="labelProcess">è£½ç¨‹</label>
          <select id="process"></select>
        </div>
      </div>
      <div style="margin-top:8px">
        <label data-i18n="labelNotes">å‚™è¨»</label>
        <textarea id="notes" rows="2"></textarea>
      </div>

      <!-- åƒè€ƒç°¡åœ– -->
      <div class="sketch-box">
        <h3 data-i18n="sketchTitle">åƒè€ƒç°¡åœ–</h3>
        <div class="sketch-wrap">
          <img src="final_finished.jpg" alt="åƒè€ƒç°¡åœ– / Reference sketch">
          <div class="muted" data-i18n="sketchHint">ä¾›æª¢é©—æ™‚å¿«é€Ÿåƒè€ƒä¸»è¦å°ºå¯¸èˆ‡å½¢ç‹€ï¼ˆåœ–æª”ï¼šfinal_finished.jpgï¼‰ã€‚</div>
        </div>
      </div>

      <!-- æ•´åˆè¡¨ï¼šå¤–è§€ï¼‹å°ºå¯¸ -->
      <h3 style="margin-top:6px" data-i18n="sectionTitle">å°ºå¯¸èˆ‡å¤–è§€æª¢é©—</h3>
      <p class="muted" data-i18n="hintAppearance">ç¬¬ 1 åˆ—ç‚ºå¤–è§€ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ 2 åˆ—èµ·ç‚ºå°ºå¯¸é‡æ¸¬ã€‚</p>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:14%" data-i18n="thItem">é …ç›® / å°ºå¯¸åç¨±</th>
            <th style="width:10%" data-i18n="thNominal">åç›®å€¼</th>
            <th style="width:10%" data-i18n="thTolMinus">ä¸‹é™å…¬å·®</th>
            <th style="width:10%" data-i18n="thTolPlus">ä¸Šé™å…¬å·®</th>
            <th style="width:8%" data-i18n="thM1">å¯¦æ¸¬1</th>
            <th style="width:8%" data-i18n="thM2">å¯¦æ¸¬2</th>
            <th style="width:8%" data-i18n="thM3">å¯¦æ¸¬3</th>
            <th style="width:8%" data-i18n="thM4">å¯¦æ¸¬4</th>
            <th style="width:8%" data-i18n="thM5">å¯¦æ¸¬5</th>
            <th style="width:8%" data-i18n="thDecision">çµæœ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="toolbar">
        <button class="btn btn-ghost" id="btnAdd" data-i18n="btnAdd">ï¼‹æ–°å¢å°ºå¯¸</button>
        <button class="btn btn-ghost" id="btnRemove" data-i18n="btnRemove">ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—</button>
        <button class="btn btn-ghost" id="btnClearRows" data-i18n="btnClearRows">æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰</button>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="btnSave" data-i18n="btnSave">å„²å­˜åˆ°é›²ç«¯</button>
        <a class="btn btn-ghost" href="report.html" id="btnGoReport" data-i18n="btnGoReport">æŸ¥çœ‹/åˆ—å°å ±å‘Š</a>
        <button class="btn btn-ghost" id="btnLang2">ğŸŒ èªè¨€</button>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>

    <p id="viewOnlyTip" class="muted hidden" data-i18n="viewOnlyTip">
      æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚
    </p>
  </div>

  <!-- èªè¨€é¸æ“‡å½ˆçª— -->
  <div class="modal-backdrop" id="langModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div class="modal" style="background:#fff; border-radius:12px; padding:16px; width:min(92vw,420px); box-shadow:0 10px 30px rgba(0,0,0,.18);">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€ / Language</h3>
      <p class="muted" data-i18n="langHint">è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š</p>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

<script>
// ===== Utilities & I18N =====
const I18N = {
  'zh-TW': {
    title:'ç¾å ´å“æª¢ï¼ˆå®‰æ‹“ï¼‰',
    loginPrompt:'è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚',
    labelAccount:'å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰', labelPassword:'å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰',
    btnLogin:'ç™»å…¥', btnReset:'æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„', btnHealth:'å¥åº·æª¢æŸ¥',
    basicTitle:'åŸºæœ¬è³‡æ–™',
    labelSupplier:'ä¾›æ‡‰å•†', labelOrder:'è¨‚å–®è™Ÿç¢¼', labelLot:'ç”Ÿç”¢æ‰¹è™Ÿ',
    labelPartNo:'ç”¢å“æ–™è™Ÿ', labelDrawingNo:'åœ–è™Ÿ', labelMaterial:'æè³ª', labelSpec:'è¦æ ¼',
    labelProductType:'ç”¢å“é¡åˆ¥', labelProcess:'è£½ç¨‹', labelNotes:'å‚™è¨»',
    sectionTitle:'å°ºå¯¸èˆ‡å¤–è§€æª¢é©—',
    hintAppearance:'ç¬¬ 1 åˆ—ç‚ºå¤–è§€ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ 2 åˆ—èµ·ç‚ºå°ºå¯¸é‡æ¸¬ã€‚',
    thItem:'é …ç›® / å°ºå¯¸åç¨±', thNominal:'åç›®å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
    thM1:'å¯¦æ¸¬1', thM2:'å¯¦æ¸¬2', thM3:'å¯¦æ¸¬3', thM4:'å¯¦æ¸¬4', thM5:'å¯¦æ¸¬5', thDecision:'çµæœ',
    btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—', btnClearRows:'æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰',
    btnSave:'å„²å­˜åˆ°é›²ç«¯', btnGoReport:'æŸ¥çœ‹/åˆ—å°å ±å‘Š',
    viewOnlyTip:'æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚',
    langTitle:'é¸æ“‡èªè¨€ / Language', langHint:'è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š',
    phAccount:'ä¾‹å¦‚ï¼šboss / worker1 / qa1', phPassword:'ä¾‹å¦‚ï¼šadmin123 / in1111 / view2222',
    phOrder:'ä¾‹ï¼šPO0339398', phLot:'ä¾‹ï¼š2025-08-LOT01', phPartNo:'ä¾‹ï¼šRT138', phDrawingNo:'ä¾‹ï¼šWKNO137-6', phNotes:'ä¾‹ï¼šå°ºå¯¸ç©©å®š/å¤–è§€ç„¡ç‘•ç–µ',
    appearanceTitle:'å¤–è§€æª¢æŸ¥', optionOK:'O.K', optionNG:'NG',
    sketchTitle:'åƒè€ƒç°¡åœ–', sketchHint:'ä¾›æª¢é©—æ™‚å¿«é€Ÿåƒè€ƒä¸»è¦å°ºå¯¸èˆ‡å½¢ç‹€ï¼ˆåœ–æª”ï¼šfinal_finished.jpgï¼‰ã€‚',
    save_saving:'å„²å­˜ä¸­...', save_ok:'âœ… å·²å„²å­˜åˆ°é›²ç«¯ï¼ˆå¯åˆ°å ±å‘Šé æŸ¥çœ‹/åˆ—å°ï¼‰', save_fail:'âŒ å„²å­˜å¤±æ•—ï¼š',
    login_msg_need:'è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼', login_msg_wrong:'âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤', login_verifying:'é©—è­‰ä¸­...',
    need_supplier_part:'è«‹å¡«å¯«ä¾›æ‡‰å•†èˆ‡ç”¢å“æ–™è™Ÿ'
  },
  'zh-CN': {
    title:'ç°åœºå“æ£€ï¼ˆå®‰æ‹“ï¼‰',
    loginPrompt:'è¯·è¾“å…¥ã€Œè´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰ã€ä¸ã€Œå¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰ã€ã€‚',
    labelAccount:'è´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰', labelPassword:'å¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰',
    btnLogin:'ç™»å½•', btnReset:'æ¸…é™¤æœ¬æœºè®°å½•', btnHealth:'å¥åº·æ£€æŸ¥',
    basicTitle:'åŸºæœ¬èµ„æ–™',
    labelSupplier:'ä¾›åº”å•†', labelOrder:'è®¢å•å·ç ', labelLot:'ç”Ÿäº§æ‰¹å·',
    labelPartNo:'äº§å“æ–™å·', labelDrawingNo:'å›¾å·', labelMaterial:'æè´¨', labelSpec:'è§„æ ¼',
    labelProductType:'äº§å“ç±»åˆ«', labelProcess:'åˆ¶ç¨‹', labelNotes:'å¤‡æ³¨',
    sectionTitle:'å°ºå¯¸ä¸å¤–è§‚æ£€éªŒ',
    hintAppearance:'ç¬¬ 1 è¡Œä¸ºå¤–è§‚ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ 2 è¡Œèµ·ä¸ºå°ºå¯¸é‡æµ‹ã€‚',
    thItem:'é¡¹ç›® / å°ºå¯¸åç§°', thNominal:'åä¹‰å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
    thM1:'å®æµ‹1', thM2:'å®æµ‹2', thM3:'å®æµ‹3', thM4:'å®æµ‹4', thM5:'å®æµ‹5', thDecision:'åˆ¤å®š',
    btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆ é™¤æœ€åä¸€è¡Œ', btnClearRows:'æ¸…ç©ºå°ºå¯¸è¡Œï¼ˆä¿ç•™å¤–è§‚ï¼‰',
    btnSave:'ä¿å­˜åˆ°äº‘ç«¯', btnGoReport:'æŸ¥çœ‹/æ‰“å°æŠ¥å‘Š',
    viewOnlyTip:'æ‚¨çš„è´¦å·ä¸º viewerï¼ˆä»…æŸ¥çœ‹/æ‰“å°ï¼‰ã€‚è¯·å‰å¾€æŠ¥å‘Šé¡µã€‚',
    langTitle:'é€‰æ‹©è¯­è¨€ / Language', langHint:'è¯·é€‰æ‹©ç•Œé¢è¯­è¨€ï¼š',
    phAccount:'ä¾‹å¦‚ï¼šboss / worker1 / qa1', phPassword:'ä¾‹å¦‚ï¼šadmin123 / in1111 / view2222',
    phOrder:'ä¾‹ï¼šPO0339398', phLot:'ä¾‹ï¼š2025-08-LOT01', phPartNo:'ä¾‹ï¼šRT138', phDrawingNo:'ä¾‹ï¼šWKNO137-6', phNotes:'ä¾‹ï¼šå°ºå¯¸ç¨³å®š/å¤–è§‚æ— ç‘•ç–µ',
    appearanceTitle:'å¤–è§‚æ£€æŸ¥', optionOK:'O.K', optionNG:'NG',
    sketchTitle:'å‚è€ƒç®€å›¾', sketchHint:'ä¾¿äºæ£€éªŒæ—¶å¿«é€Ÿå‚è€ƒä¸»è¦å°ºå¯¸ä¸å½¢çŠ¶ï¼ˆå›¾æ¡£ï¼šfinal_finished.jpgï¼‰ã€‚',
    save_saving:'ä¿å­˜ä¸­...', save_ok:'âœ… å·²ä¿å­˜åˆ°äº‘ç«¯ï¼ˆå¯å»æŠ¥å‘Šé¡µæŸ¥çœ‹/æ‰“å°ï¼‰', save_fail:'âŒ ä¿å­˜å¤±è´¥ï¼š',
    login_msg_need:'è¯·è¾“å…¥è´¦å·ä¸å¯†ç ', login_msg_wrong:'âŒ è´¦å·æˆ–å¯†ç é”™è¯¯', login_verifying:'éªŒè¯ä¸­...',
    need_supplier_part:'è¯·è¾“å…¥ä¾›åº”å•†ä¸äº§å“æ–™å·'
  },
  'en': {
    title:'On-site QC (Anchor)',
    loginPrompt:'Please enter â€œAccount (Inspector)â€ and â€œPasswordâ€.',
    labelAccount:'Account (Inspector)', labelPassword:'Password',
    btnLogin:'Sign in', btnReset:'Clear local data', btnHealth:'Health Check',
    basicTitle:'Basic Info',
    labelSupplier:'Supplier', labelOrder:'Order No.', labelLot:'Production Lot No.',
    labelPartNo:'Part No.', labelDrawingNo:'Drawing No.', labelMaterial:'Material', labelSpec:'Spec',
    labelProductType:'Product Category', labelProcess:'Process', labelNotes:'Notes',
    sectionTitle:'Appearance & Dimensional Inspection',
    hintAppearance:'Row 1 is Appearance (optional). Rows from 2 are dimensions.',
    thItem:'Item / Dimension', thNominal:'Nominal', thTolMinus:'Lower Tol.', thTolPlus:'Upper Tol.',
    thM1:'Sample1', thM2:'Sample2', thM3:'Sample3', thM4:'Sample4', thM5:'Sample5', thDecision:'Decision',
    btnAdd:'ï¼‹Add dimension', btnRemove:'ï¼Remove last row', btnClearRows:'Clear dimensions (keep appearance)',
    btnSave:'Save to cloud', btnGoReport:'View/Print Reports',
    viewOnlyTip:'Your role is viewer (view/print only). Please go to Reports page.',
    langTitle:'Choose language', langHint:'Select UI language:',
    phAccount:'e.g. boss / worker1 / qa1', phPassword:'e.g. admin123 / in1111 / view2222',
    phOrder:'e.g. PO0339398', phLot:'e.g. 2025-08-LOT01', phPartNo:'e.g. RT138', phDrawingNo:'e.g. WKNO137-6', phNotes:'e.g. Dimensions stable / No defects',
    appearanceTitle:'Appearance', optionOK:'OK', optionNG:'NG',
    sketchTitle:'Reference sketch', sketchHint:'Quick reference for major dims & shape (file: final_finished.jpg).',
    save_saving:'Saving...', save_ok:'âœ… Saved (check the report page to view/print)', save_fail:'âŒ Save failed: ',
    login_msg_need:'Please enter account & password', login_msg_wrong:'âŒ Wrong account or password', login_verifying:'Verifying...',
    need_supplier_part:'Enter supplier & part number'
  }
};

function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
function selectLang(lang){ setLang(lang); document.getElementById('langModal').style.display='none'; }
function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
function t(key){ const d=I18N[getLang()]||I18N['zh-TW']; return d[key] ?? (I18N['zh-TW'][key] ?? key); }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); el.innerHTML = t(k); });
  // placeholders
  const map = {'#inspector':'phAccount','#passcode':'phPassword','#orderNo':'phOrder','#lotNo':'phLot','#partNo':'phPartNo','#drawingNo':'phDrawingNo','#notes':'phNotes'};
  Object.entries(map).forEach(([sel,key])=>{ const el=document.querySelector(sel); if (el) el.placeholder=t(key); });
}

// Dropdown lists
const SUPPLIERS = [
  { zh:'å®‰å¯', en:'AKF' }, { zh:'å®‰æ‹“', en:'ANCHOR' }
];
const MATERIALS = [
  { code:'STEEL', zh:'é»‘éµ', en:'STEEL' },
  { code:'SS', zh:'ä¸é½é‹¼', en:'STAINLESS STEEL' }
];
const SPECS = ['M6X8X25','M8X10X25','M8X10X30','M8X10X40','M10X12X25','M10X12X30','M10X12X40','M12X15X25','M12X15X50','M16X20X65'];
const PRODUCT_TYPES = [
  { code:'PLUG', zh:'å¡å­', en:'plug' },
  { code:'SLEEVE_A', zh:'ç®¡å­_A type', en:'Sleeve_ A type' },
  { code:'SLEEVE_B', zh:'ç®¡å­_B type', en:'Sleeve_ B type' },
  { code:'SLEEVE_H', zh:'ç®¡å­_H type', en:'Sleeve_ H type' },
  { code:'ANCHOR_A', zh:'æˆå“_ A type', en:'Anchor_ A type' },
  { code:'ANCHOR_B', zh:'æˆå“_ B type', en:'Anchor_ B type' },
  { code:'ANCHOR_H', zh:'æˆå“_ H type', en:'Anchor_ H type' }
];
const PROCESSES = [
  { code:'WIRE', zh:'ç·šæ', en:'WIRE' },
  { code:'FORMING', zh:'æˆå½¢', en:'FORMING' },
  { code:'TAPING', zh:'æ”»ç‰™', en:'TAPING' },
  { code:'CUTTING', zh:'å‰²æº', en:'CUTTING' },
  { code:'PLATING', zh:'é›»é', en:'PLATING' },
  { code:'FINISHED', zh:'æˆå“', en:'FINISHED' },
  { code:'ASSEMBLY', zh:'çµ„ç«‹', en:'ASSEMBLY' },
  { code:'FINAL', zh:'æœ€çµ‚æˆå“', en:'FINAL FINISHED' }
];

function fillSelects(){
  const sSel = document.getElementById('supplier');
  sSel.innerHTML = SUPPLIERS.map(x=>`<option value="${x.zh}">${x.zh} (${x.en})</option>`).join('');
  sSel.onchange = ()=>{
    const opt = sSel.options[sSel.selectedIndex];
    document.getElementById('supplierEn').textContent = opt ? `English: ${opt.textContent.match(/\((.*?)\)/)?.[1]||''}` : '';
  };
  sSel.dispatchEvent(new Event('change'));

  const mSel = document.getElementById('material');
  mSel.innerHTML = MATERIALS.map(x=>`<option value="${x.code}">${x.zh} (${x.en})</option>`).join('');

  const spSel = document.getElementById('spec');
  spSel.innerHTML = SPECS.map(x=>`<option value="${x}">${x}</option>`).join('');

  const ptSel = document.getElementById('productType');
  ptSel.innerHTML = PRODUCT_TYPES.map(x=>`<option value="${x.code}">${x.zh} (${x.en})</option>`).join('');

  const pSel = document.getElementById('process');
  pSel.innerHTML = '<option value=""></option>' + PROCESSES.map(x=>`<option value="${x.code}">${x.zh} (${x.en})</option>`).join('');
}

// Table rows
const tbody = document.getElementById('tbody');
function ensureAppearanceRow(){
  if (!tbody.querySelector('tr[data-type="appearance"]')){
    const tr = document.createElement('tr');
    tr.setAttribute('data-type','appearance');
    tr.innerHTML = `
      <td><strong data-i18n="appearanceTitle">${t('appearanceTitle')}</strong></td>
      <td colspan="3" class="muted">ï¼ˆå¯ç•™ç©ºï¼‰</td>
      ${[1,2,3,4,5].map(()=>`<td><select class="ap"><option value=""></option><option value="OK">${t('optionOK')}</option><option value="NG">${t('optionNG')}</option></select></td>`).join('')}
      <td></td>`;
    tbody.appendChild(tr);
    updateDecisionForRow(tr);
  }
}
function addMeasureRow(){
  const tr = document.createElement('tr');
  tr.setAttribute('data-type','measure');
  tr.innerHTML = `
    <td><input class="name" placeholder="e.g. d0 / L" /></td>
    <td><input class="nom" type="number" step="0.001" /></td>
    <td><input class="lo"  type="number" step="0.001" /></td>
    <td><input class="hi"  type="number" step="0.001" /></td>
    ${[1,2,3,4,5].map(i=>`<td><input class="m m${i}" type="number" step="0.001" /></td>`).join('')}
    <td></td>`;
  tbody.appendChild(tr);
}
function updateDecisionForRow(tr){
  const cell = tr.querySelector('td:last-child'); if (!cell) return;
  if (tr.getAttribute('data-type')==='appearance'){
    const oks = Array.from(tr.querySelectorAll('select.ap')).map(s => (s.value||'').toUpperCase());
    const filled = oks.filter(v => v==='OK' || v==='O.K' || v==='NG');
    if (!filled.length){ cell.textContent=''; cell.className=''; return; }
    const allOk = oks.every(v => v==='OK' || v==='O.K');
    cell.textContent = allOk ? 'PASS' : 'FAIL';
    cell.className = allOk ? 'pass' : 'fail';
    return;
  }
  const nom = parseFloat(tr.querySelector('.nom').value);
  const lo  = parseFloat(tr.querySelector('.lo').value);
  const hi  = parseFloat(tr.querySelector('.hi').value);
  const ms  = [1,2,3,4,5].map(i => tr.querySelector('.m'+i).value===''?null:Number(tr.querySelector('.m'+i).value));
  if (Number.isFinite(nom) && Number.isFinite(lo) && Number.isFinite(hi) && ms.some(v => v===0 || Number.isFinite(v))){
    const min = nom + lo, max = nom + hi;
    const ok = ms.filter(v => v===0 || Number.isFinite(v)).every(v => v>=min && v<=max);
    cell.textContent = ok ? 'PASS' : 'FAIL';
    cell.className = ok ? 'pass' : 'fail';
  } else { cell.textContent=''; cell.className=''; }
}
function updateAll(){ tbody.querySelectorAll('tr').forEach(updateDecisionForRow); }

// Events for table
tbody.addEventListener('input', e=>{
  const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr);
});
document.getElementById('btnAdd').addEventListener('click', ()=> addMeasureRow());
document.getElementById('btnRemove').addEventListener('click', ()=>{
  const rows = tbody.querySelectorAll('tr[data-type="measure"]'); if (rows.length) rows[rows.length-1].remove();
});
document.getElementById('btnClearRows').addEventListener('click', ()=>{
  tbody.querySelectorAll('tr[data-type="measure"]').forEach(x=>x.remove());
  updateAll();
});

// ===== Auth & role handling (compatible with existing backend) =====
async function authCheck(u,p){
  try{
    const r = await fetch('/api/inspections?auth=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p }});
    const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{}
    return (r.ok && j && j.ok!==false) ? { ok:true, role:j.role||'input', user:(j.user||u) } : { ok:false };
  }catch{ return { ok:false }; }
}
function showByRole(role){
  document.getElementById('loginView').classList.add('hidden');
  if (role === 'viewer'){
    document.getElementById('formView').classList.add('hidden');
    document.getElementById('viewOnlyTip').classList.remove('hidden');
  }else{
    document.getElementById('formView').classList.remove('hidden');
    document.getElementById('viewOnlyTip').classList.add('hidden');
  }
}

// Login actions
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const u = (document.getElementById('inspector').value||'').trim();
  const p = (document.getElementById('passcode').value||'').trim();
  const msg = document.getElementById('loginMsg');
  if (!u || !p){ msg.textContent = t('login_msg_need'); return; }
  msg.textContent = t('login_verifying');
  const ok = await authCheck(u,p);
  if (!ok.ok){ msg.textContent = t('login_msg_wrong'); return; }
  localStorage.setItem('qci_user', u);
  localStorage.setItem('qci_pass', p);
  localStorage.setItem('qci_role', ok.role);
  localStorage.setItem('qci_inspector', u);
  localStorage.setItem('qci_passcode', p);
  showByRole(ok.role);
});
document.getElementById('btnResetPass').addEventListener('click', ()=>{
  ['qci_user','qci_pass','qci_role','qci_inspector','qci_passcode'].forEach(k=>localStorage.removeItem(k));
  location.reload();
});
document.getElementById('btnLang').addEventListener('click', openLangModal);
document.getElementById('btnLang2').addEventListener('click', openLangModal);

// Save
document.getElementById('btnSave').addEventListener('click', async ()=>{
  const msg = document.getElementById('msg');
  const supplier = document.getElementById('supplier').value;
  const orderNo = document.getElementById('orderNo').value;
  const lotNo = document.getElementById('lotNo').value;
  const partNo = document.getElementById('partNo').value;
  const drawingNo = document.getElementById('drawingNo').value;
  const material = document.getElementById('material').value;
  const spec = document.getElementById('spec').value;
  const productType = document.getElementById('productType').value;
  const process = document.getElementById('process').value;
  const notes = document.getElementById('notes').value;

  if (!supplier || !partNo){ msg.textContent = t('need_supplier_part'); return; }

  // Build appearance & measurements
  const ap = []; const ms = [];
  const rows = tbody.querySelectorAll('tr');
  rows.forEach(r=>{
    if (r.getAttribute('data-type')==='appearance'){
      r.querySelectorAll('select.ap').forEach((s,i)=>{
        const v = (s.value||'').toUpperCase(); if (!v) return;
        ap.push({ sample:'Sample'+(i+1), result:v });
      });
    }else{
      const name = r.querySelector('.name').value;
      const nom  = r.querySelector('.nom').value;
      const lo   = r.querySelector('.lo').value;
      const hi   = r.querySelector('.hi').value;
      const measured = [1,2,3,4,5].map(i=>{
        const v = r.querySelector('.m'+i).value;
        return v===''?null:Number(v);
      });
      ms.push({ name, nominal:nom===''?null:Number(nom), tolMinus:lo===''?null:Number(lo), tolPlus:hi===''?null:Number(hi), measured });
    }
  });

  const payload = {
    supplier, orderNo, lotNo, partNo, drawingNo, material, spec, productType, process, notes,
    appearance: ap, measurements: ms
  };

  const u = localStorage.getItem('qci_user')||'';
  const p = localStorage.getItem('qci_pass')||'';
  try{
    msg.textContent = t('save_saving');
    const res = await fetch('/api/inspections', { method:'POST', headers:{
      'content-type':'application/json','x-user':u,'x-pass':p,'x-passcode':p
    }, body: JSON.stringify(payload)});
    const text = await res.text(); let j={}; try{ j=JSON.parse(text);}catch{}
    if (!res.ok || (j && j.error)) throw new Error(j.error||text);
    msg.textContent = t('save_ok');
  }catch(e){
    msg.textContent = t('save_fail') + (e.message||e);
  }
});

// init
(function init(){
  applyI18n(); fillSelects(); ensureAppearanceRow(); addMeasureRow();
  const role = localStorage.getItem('qci_role')||''; if (role) showByRole(role);
})();
</script>

<script>
// Ensure payload includes auth in body in addition to headers
window._qc_save_with_auth_body = async function(url, data, user, pass, passcode){
  const payload = Object.assign({}, data, { __auth:{ user, pass, passcode } });
  const r = await fetch(url, {
    method: "POST",
    mode: "cors",
    headers: {
      "Content-Type":"application/json",
      "x-user": user || "",
      "x-pass": pass || "",
      "x-passcode": passcode || ""
    },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  let j; try{ j = JSON.parse(t); }catch(e){ j = { raw: t }; }
  return { ok: r.ok, status: r.status, data: j };
};
</script>
</body>
</html>
