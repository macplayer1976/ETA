<!DOCTYPE html>
<!-- Updated index.html with local template storage, export/import, migrate & purge actions -->

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>現場輸入（安可）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; }
    .card { max-width: 1120px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    input[type="text"] { flex:1 }
    .btn { padding: 10px 14px; border: none; border-radius: 10px; background: #2563eb; color: #fff; cursor: pointer; }
    .btn-outline { background: #f3f4f6; color:#111827; }
    .btn-ghost { background:#fff; color:#111; border:1px solid #e5e7eb; }
    .muted { color: #666; font-size: 13px; }
    a.btn { text-decoration: none; display: inline-block; }
    @media (max-width:720px){ table{ font-size:13px} }
  </style>
</head>
<body>
  <div class="card">
    <h2>現場輸入（安可）</h2>
    <div class="row">
      <input id="account" placeholder="帳號（如 boss / work1 / QC1）"/>
      <input id="password" placeholder="密碼（如 admin*** / in*** / view***）" type="password"/>
      <button class="btn" id="btnLogin">登入</button>
      <button class="btn btn-outline" id="btnHealth">健康檢查</button>
      <span class="muted" id="tipLogin"></span>
    </div>

    <hr/>

    <div class="row">
      <input id="supplier" placeholder="供應商"/>
      <input id="partNo" placeholder="料號 Part No."/>
      <input id="drawingNo" placeholder="圖號 Drawing No."/>
      <input id="revision" placeholder="版次 Revision"/>
    </div>
    <div class="row">
      <input id="orderNo" placeholder="訂單號碼"/>
      <input id="lotNo" placeholder="生產批號"/>
      <input id="material" placeholder="材質"/>
      <input id="spec" placeholder="規格"/>
      <select id="category">
        <option value="">產品類別</option>
        <option value="PLUG">塞子</option>
        <option value="SLEEVE_A">管子_A type</option>
        <option value="SLEEVE_B">管子_B type</option>
        <option value="SLEEVE_H">管子_H type</option>
        <option value="FINISHED_A">成品_A type</option>
        <option value="FINISHED_B">成品_B type</option>
        <option value="FINISHED_H">成品_H type</option>
        <option value="TOOL">內迫工具</option>
      </select>
      <select id="process">
        <option value="">製程 Process</option>
        <option value="WIRE">WIRE</option><option value="FORMING">FORMING</option>
        <option value="TAPING">TAPING</option><option value="CUTTING">CUTTING</option>
        <option value="PLATING">PLATING</option><option value="FINISHED">FINISHED</option>
        <option value="ASSEMBLY">ASSEMBLY</option><option value="FINAL">FINAL FINISHED</option>
      </select>
      <input id="notes" placeholder="備註"/>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:8%">代號</th>
          <th style="width:18%">項目 / 尺寸名稱</th>
          <th style="width:10%">標準值</th>
          <th style="width:10%">下限公差</th>
          <th style="width:10%">上限公差</th>
          <th style="width:8%">實測1</th>
          <th style="width:8%">實測2</th>
          <th style="width:8%">實測3</th>
          <th style="width:8%">實測4</th>
          <th style="width:8%">實測5</th>
          <th style="width:8%">結果</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="row">
      <button class="btn btn-ghost" id="btnAdd">＋新增尺寸</button>
      <button class="btn btn-ghost" id="btnRemove">－刪除最後一列</button>
      <button class="btn btn-ghost" id="btnClearRows">清空尺寸列（保留外觀）</button>
      <a class="btn btn-outline" href="report.html">查看/列印報告</a>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnSave">儲存到雲端</button>
      <button class="btn btn-outline" id="btnSaveTplLocal">預設版型（本機）儲存</button>
      <button class="btn btn-outline" id="btnTplExport">模板匯出</button>
      <button class="btn btn-outline" id="btnTplImport">模板匯入</button>
      <button class="btn btn-outline" id="btnTplMigrate">雲端模板→本機</button>
      <button class="btn btn-outline" id="btnTplPurge" style="display:none">清空雲端模板（管理員）</button>
    </div>

    <p id="msg" class="muted"></p>
  </div>

<script>
  // ===== 基本工具 =====
  const tbody = document.getElementById('tbody');
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function q(id){ return document.getElementById(id); }
  function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }

  // ===== 登入 =====
  async function ensureAuth(){
    const user = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
    const pass = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
    if (!user || !pass) return { ok:false };
    try{
      const r = await fetch('/api/inspections?auth=1', { headers:{ 'x-user':user, 'x-pass':pass, 'x-passcode':pass } });
      const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{}
      if (!r.ok || !j.ok) return { ok:false };
      return { ok:true, role:(j.role||'').toLowerCase(), user:j.user||'' };
    }catch{ return { ok:false }; }
  }
  function saveCred(u,p,r){ localStorage.setItem('qci_user',u); localStorage.setItem('qci_pass',p); localStorage.setItem('qci_role',r||'input'); }
  q('btnLogin').addEventListener('click', async ()=>{
    const u = q('account').value.trim(); const p = q('password').value.trim();
    if (!u || !p){ q('tipLogin').textContent='請輸入帳號密碼'; return; }
    saveCred(u,p,'input');
    const ok = await ensureAuth();
    q('tipLogin').textContent = ok.ok ? '✅ 登入成功' : '❌ 驗證失敗，請確認帳密/環境變數';
    if (ok.ok){ q('btnTplPurge').style.display = (ok.role==='admin' && String(u).toLowerCase()==='boss') ? '' : 'none'; }
  });
  q('btnHealth').addEventListener('click', async ()=>{
    const r = await fetch('/api/inspections?health=1'); const t = await r.text();
    q('tipLogin').textContent = t;
  });

  // ===== 尺寸列 =====
  function ensureAppearanceRow(){
    const has = tbody.querySelector('tr[data-type="appearance"]');
    if (has) return has;
    const tr = document.createElement('tr');
    tr.setAttribute('data-type','appearance');
    tr.innerHTML = `<td colspan="11">外觀：樣品 1~5 = 
      <label><input type="checkbox" class="ap ap1">1</label>
      <label><input type="checkbox" class="ap ap2">2</label>
      <label><input type="checkbox" class="ap ap3">3</label>
      <label><input type="checkbox" class="ap ap4">4</label>
      <label><input type="checkbox" class="ap ap5">5</label>
      （勾選=OK；未勾選=NG）
    </td>`;
    tbody.appendChild(tr);
    return tr;
  }
  function addMeasureRow(){
    const tr = document.createElement('tr');
    tr.setAttribute('data-type','measure');
    tr.innerHTML = `
      <td><input class="code" /></td>
      <td><input class="name" /></td>
      <td><input class="nom" /></td>
      <td><input class="lo" /></td>
      <td><input class="hi" /></td>
      <td><input class="m1" /></td>
      <td><input class="m2" /></td>
      <td><input class="m3" /></td>
      <td><input class="m4" /></td>
      <td><input class="m5" /></td>
      <td class="dec">—</td>`;
    tbody.appendChild(tr);
    updateDecisionForRow(tr);
    return tr;
  }
  function clearMeasureRows(){
    Array.from(tbody.querySelectorAll('tr[data-type="measure"]')).forEach(tr=>tr.remove());
  }
  function hasAnyUserInputs(){
    const rows = Array.from(tbody.querySelectorAll('tr[data-type="measure"]'));
    return rows.some(tr=>{
      const get = sel => (tr.querySelector(sel)?.value || '').trim();
      return get('.code')||get('.name')||get('.nom')||get('.lo')||get('.hi')||get('.m1')||get('.m2')||get('.m3')||get('.m4')||get('.m5');
    });
  }
  function updateDecisionForRow(tr){
    const nom = parseFloat(tr.querySelector('.nom')?.value || '');
    const lo  = parseFloat(tr.querySelector('.lo')?.value || '');
    const hi  = parseFloat(tr.querySelector('.hi')?.value || '');
    const m1  = parseFloat(tr.querySelector('.m1')?.value || '');
    const ok = (v)=> isFinite(nom) && ( (isFinite(lo)? v>=nom+lo : true) && (isFinite(hi)? v<=nom+hi : true) );
    let pass = true; [m1,].forEach(v=>{ if (isFinite(v) && !ok(v)) pass=false; });
    tr.querySelector('.dec').textContent = pass ? 'PASS' : 'FAIL';
  }

  // ===== 本機模板（LocalStorage） =====
  const LS_KEY = 'qci_templates_v1';
  function readLocalTemplates(){
    try { const j = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); return Array.isArray(j)? j : []; } catch { return []; }
  }
  function writeLocalTemplates(arr){
    const seen = new Set(); const out=[];
    for(const t of arr){
      const k = strictKeyString(t.key||{});
      const sig = k + '|' + JSON.stringify(t.rows||[]);
      if (!seen.has(sig)){ seen.add(sig); out.push(t); }
    }
    localStorage.setItem(LS_KEY, JSON.stringify(out));
    return out;
  }
  function getKeyFromForm(){
    return {
      supplier: q('supplier').value.trim(),
      partNo: q('partNo').value.trim(),
      drawingNo: q('drawingNo').value.trim(),
      material: q('material').value.trim(),
      spec: q('spec').value.trim(),
      category: q('category').value.trim(),
      process: q('process').value.trim()
    };
  }
  function strictKeyReady(k){
    return ['drawingNo','material','spec','category','process'].every(f => String(k[f]||'').trim()!=='');
  }
  function strictKeyString(k){
    return ['drawingNo','material','spec','category','process'].map(f => (k[f]||'').toString().trim().toUpperCase()).join('|');
  }
  function buildTemplateForSave(){
    const key = getKeyFromForm();
    const tpl = { key, part:{ material:key.material, spec:key.spec, category:key.category, process:key.process }, rows: [] };
    const ap = tbody.querySelector('tr[data-type="appearance"]');
    if (ap){
      for (let i=1;i<=5;i++){
        const chk = ap.querySelector('.ap'+i);
        if (chk && chk.checked) tpl.rows.push({ appearance:true, code:'', item:'', nominal:'', tolMinus:'', tolPlus:'' });
      }
    }
    Array.from(tbody.querySelectorAll('tr[data-type="measure"]')).forEach(tr => {
      const get = sel => (tr.querySelector(sel)?.value || '').trim();
      const row = { code:get('.code'), item:get('.name'), nominal:get('.nom'), tolMinus:get('.lo'), tolPlus:get('.hi') };
      if (row.code || row.item || row.nominal || row.tolMinus || row.tolPlus) tpl.rows.push(row);
    });
    return tpl;
  }
  function scoreTemplate(tpl, key){
    const fields = ['supplier','partNo','drawingNo','material','spec','category','process'];
    let need=0, hit=0;
    for(const f of fields){
      const tv = String(tpl?.key?.[f]||'').trim().toUpperCase();
      if (!tv) continue;
      need++;
      const kv = String(key[f]||'').trim().toUpperCase();
      if (!kv) continue;
      if (kv===tv || kv.includes(tv) || tv.includes(kv)) hit++;
    }
    return { need, hit, score:hit };
  }
  function applyTemplate(tpl, opts){
    const force = !!(opts && opts.force);
    const rows = Array.from(tbody.querySelectorAll('tr[data-type="measure"]'));
    const hasAny = rows.some(tr=>{
      const get = sel => (tr.querySelector(sel)?.value || '').trim();
      return get('.code')||get('.name')||get('.nom')||get('.lo')||get('.hi');
    });
    if (force || rows.length===0 || !hasAny){
      clearMeasureRows(); ensureAppearanceRow();
      (tpl.rows||[]).forEach(r => {
        if (r.appearance){ ensureAppearanceRow(); }
        else{
          const tr = addMeasureRow();
          if (r.code) tr.querySelector('.code').value = r.code;
          if (r.item) tr.querySelector('.name').value = r.item;
          if (r.nominal) tr.querySelector('.nom').value = r.nominal;
          if (r.tolMinus) tr.querySelector('.lo').value = r.tolMinus;
          if (r.tolPlus) tr.querySelector('.hi').value = r.tolPlus;
          updateDecisionForRow(tr);
        }
      });
    }
  }

  let _tplCache = [];
  async function loadTemplates(){
    // 合併：雲端（若可） + 本機
    const local = readLocalTemplates();
    _tplCache = local.slice();
    try{
      const auth = await ensureAuth();
      if (auth.ok){
        const u = localStorage.getItem('qci_user')||'';
        const p = localStorage.getItem('qci_pass')||'';
        const r = await fetch('/api/inspections?templates=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const txt = await r.text(); let j={}; try{ j=JSON.parse(txt);}catch{}
        const arr = Array.isArray(j) ? j : (j.templates || j.records || j.record || []);
        _tplCache = writeLocalTemplates([...(Array.isArray(arr)?arr:[]), ...local]); // 也同步到本機
      }
    }catch{}
  }

  function tryAutoApply(){
    if (!_tplCache || !_tplCache.length) return;
    const key = getKeyFromForm();
    // 嚴格五鍵完全符合者優先
    if (strictKeyReady(key)){
      const aim = strictKeyString(key);
      const hit = _tplCache.find(t => strictKeyString(t.key||{}) === aim);
      if (hit){ applyTemplate(hit, {force:true}); q('msg').textContent = '✅ 套用嚴格相符模板'; return; }
    }
    // 其次最佳分數
    let best=null, bestScore=-1, bestNeed=0;
    for(const t of _tplCache){
      const s = scoreTemplate(t, key);
      if (s.score>bestScore){ best=t; bestScore=s.score; bestNeed=s.need; }
    }
    if (best && (bestScore>=2 || (bestNeed<=1 && bestScore>=1))){
      applyTemplate(best);
      q('msg').textContent = '✅ 自動套用相近模板';
    }else{
      q('msg').textContent = '(尚未找到對應模板)';
    }
  }

  // ===== 模板操作：本機儲存 / 匯出 / 匯入 / 遷移 / 雲端清空 =====
  q('btnSaveTplLocal').addEventListener('click', ()=>{
    const tpl = buildTemplateForSave();
    const now = new Date().toISOString();
    const rec = { id: 'TPL-'+Math.random().toString(36).slice(2,10).toUpperCase(), type:'template', createdAt:now, updatedAt:now, key:tpl.key, part:tpl.part, rows:tpl.rows };
    const arr = readLocalTemplates(); arr.push(rec); writeLocalTemplates(arr);
    loadTemplates(); // refresh cache
    q('msg').textContent = '✅ 模板已儲存於本機（LocalStorage）。';
  });
  q('btnTplExport').addEventListener('click', ()=>{
    const data = JSON.stringify(readLocalTemplates(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'akf-templates.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });
  q('btnTplImport').addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type='file'; input.accept='.json,application/json';
    input.onchange = async () => {
      const file = input.files[0]; if (!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text); if (!Array.isArray(arr)) throw new Error('格式錯誤');
        writeLocalTemplates([ ...readLocalTemplates(), ...arr ]);
        await loadTemplates(); q('msg').textContent = '✅ 已匯入模板到本機。';
      }catch(e){ alert('匯入失敗：'+(e.message||e)); }
    };
    input.click();
  });
  q('btnTplMigrate').addEventListener('click', async ()=>{
    try{
      await loadTemplates(); // 會把雲端模板也寫入本機
      q('msg').textContent = '✅ 已同步雲端模板到本機（未清空雲端）。如需釋放空間，請執行「清空雲端模板」。';
    }catch(e){ alert(e); }
  });
  q('btnTplPurge').addEventListener('click', async ()=>{
    const ok = confirm('此動作將「清空雲端的所有模板」僅保留檢驗紀錄。您已先使用「模板匯出」備份了嗎？');
    if (!ok) return;
    try{
      const u = localStorage.getItem('qci_user')||'';
      const p = localStorage.getItem('qci_pass')||'';
      const r = await fetch('/api/inspections?purgeTemplates=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
      const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{}
      if (!r.ok || j.error) throw new Error(j.error||t);
      q('msg').textContent = `✅ 已清空雲端模板，釋放空間（刪除 ${j.removed||0} 筆，保留 ${j.kept||0} 筆檢驗紀錄）。`;
    }catch(e){ alert('清空失敗：'+(e.message||e)); }
  });

  // ===== 儲存檢驗紀錄 =====
  q('btnSave').addEventListener('click', async ()=>{
    const u = localStorage.getItem('qci_user')||'';
    const p = localStorage.getItem('qci_pass')||'';
    if (!u || !p){ alert('請先登入'); return; }
    const record = {
      inspector:u,
      supplier:q('supplier').value.trim(),
      partNo:q('partNo').value.trim(),
      drawingNo:q('drawingNo').value.trim(),
      revision:q('revision').value.trim(),
      orderNo:q('orderNo').value.trim(),
      lotNo:q('lotNo').value.trim(),
      material:q('material').value.trim(),
      spec:q('spec').value.trim(),
      category:q('category').value.trim(),
      process:q('process').value.trim(),
      notes:q('notes').value.trim(),
      appearance:(()=>{
        const ap = []; const row = tbody.querySelector('tr[data-type="appearance"]'); if (!row) return ap;
        for (let i=1;i<=5;i++){ const chk=row.querySelector('.ap'+i); if (chk) ap.push({ sample:String(i), result: chk.checked?'OK':'NG' }); }
        return ap;
      })(),
      measurements:Array.from(tbody.querySelectorAll('tr[data-type="measure"]')).map(tr=>({
        code: tr.querySelector('.code')?.value||'',
        item: tr.querySelector('.name')?.value||'',
        nominal: tr.querySelector('.nom')?.value||'',
        tolMinus: tr.querySelector('.lo')?.value||'',
        tolPlus: tr.querySelector('.hi')?.value||'',
        m1: tr.querySelector('.m1')?.value||'',
        m2: tr.querySelector('.m2')?.value||'',
        m3: tr.querySelector('.m3')?.value||'',
        m4: tr.querySelector('.m4')?.value||'',
        m5: tr.querySelector('.m5')?.value||'',
      })),
      overallResult: (function(){ // 簡單判定
        const anyFail = Array.from(tbody.querySelectorAll('tr[data-type="measure"] .dec')).some(td => (td.textContent||'')==='FAIL');
        return anyFail ? 'FAIL' : 'PASS';
      })()
    };
    try{
      const r = await fetch('/api/inspections', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'x-user':u, 'x-pass':p, 'x-passcode':p },
        body: JSON.stringify({ record })
      });
      const t = await r.text(); if (!r.ok) throw new Error(t || ('HTTP '+r.status));
      q('msg').textContent = '✅ 已儲存到雲端。';
    }catch(e){
      q('msg').textContent = '❌ 儲存失敗：' + (e.message||e);
    }
  });

  // ===== 初始 =====
  function bind(){
    q('btnAdd').addEventListener('click', addMeasureRow);
    q('btnRemove').addEventListener('click', ()=>{
      const rows = tbody.querySelectorAll('tr[data-type="measure"]'); if (rows.length) rows[rows.length-1].remove();
    });
    q('btnClearRows').addEventListener('click', ()=>{ clearMeasureRows(); ensureAppearanceRow(); });
    tbody.addEventListener('input', (e)=>{ const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });
    tbody.addEventListener('change', (e)=>{ const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });
    ;['supplier','partNo','drawingNo','material','spec','category','process','orderNo','lotNo','revision','notes'].forEach(id=>{
      const el = q(id); if (el){ el.addEventListener('input', ()=> setTimeout(tryAutoApply, 120)); el.addEventListener('change', tryAutoApply); }
    });
  }
  function init(){
    bind(); ensureAppearanceRow(); addMeasureRow();
    ensureAuth().then(info=>{
      if (info.ok){ q('btnTplPurge').style.display = (info.role==='admin' && String(localStorage.getItem('qci_user')||'').toLowerCase()==='boss') ? '' : 'none'; }
    });
    loadTemplates().then(tryAutoApply);
  }
  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
