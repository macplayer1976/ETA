<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="title">ç¾å ´å“æª¢ï¼ˆAKFï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 16px; background:#fafafa; }
    .card { max-width: 1120px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    h2 { margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pass { background: #e7f7ec; color: #116329; }
    .fail { background: #fde8e8; color: #c02020; }
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #111827; color: white; }
    .btn-ghost { background: #f3f4f6; color:#111827; }
    .muted { color: #6b7280; font-size: 13px; }
    .error { color: #b91c1c; }
    .hidden { display:none !important; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    a.btn { text-decoration: none; display:inline-block; }
    .hint { margin: 6px 0 0; color:#6b7280; font-size:13px; }
    td.disabled input { background:#fafafa; color:#9ca3af; }
    /* èªè¨€é¸æ“‡å½ˆçª— */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:12px; padding:16px; width: min(92vw, 420px); box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal h3 { margin:0 0 8px 0; }
    .modal .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px; }
  
    /* åƒè€ƒç°¡åœ–å€ */
    .sketch-box { margin: 12px 0 6px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background:#f9fafb; }
    .sketch-box h3 { margin: 0 0 6px 0; font-size: 16px; }
    .sketch-wrap { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .sketch-wrap img { max-width: 100%; height: auto; border-radius: 8px; border:1px solid #e5e7eb; }
    .sketch-note { color:#6b7280; font-size:13px; }
    </style>
</head>
<body>
  <div class="card">
    <h2 data-i18n="title">ç¾å ´å“æª¢ï¼ˆAKFï¼‰</h2>

    <!-- ç™»å…¥å€ -->
    <div id="loginView">
      <p class="muted" data-i18n="loginPrompt">è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚</p>
      <div class="row">
        <div>
          <label data-i18n="labelAccount">å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰</label>
          <input id="inspector" />
        </div>
        <div>
          <label data-i18n="labelPassword">å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰</label>
          <input id="passcode" type="password" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" id="btnLogin" data-i18n="btnLogin">ç™»å…¥</button>
        <button class="btn btn-ghost" id="btnResetPass" data-i18n="btnReset">æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„</button>
        <a class="btn btn-ghost" href="/api/inspections?health=1" target="_blank" id="btnHealth" data-i18n="btnHealth">å¥åº·æª¢æŸ¥</a>
        <button class="btn btn-ghost" id="btnLang">ğŸŒ èªè¨€</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- è¡¨å–®å€ï¼ˆinput/admin å¯è¦‹ï¼‰ -->
    <div id="formView" class="hidden">
      
<div class="row">
  <div>
    <label data-i18n="labelSupplier">ä¾›æ‡‰å•†</label>
    <select id="supplier"></select>
    <div class="muted" id="supplierEn"></div>
  </div>
  <div>
    <label data-i18n="labelOrderNo">è¨‚å–®è™Ÿç¢¼</label>
    <input id="orderNo" />
  </div>
</div>
<div class="row">
  <div>
    <label data-i18n="labelLotNo">ç”Ÿç”¢æ‰¹è™Ÿ</label>
    <input id="lotNo" />
  </div>
  <div>
    <label data-i18n="labelPartNo">æ–™è™Ÿ (Part No.)</label>
    <input id="partNo" />
  </div>
</div>
<div class="row">
  <div>
    <label data-i18n="labelDrawingNo">åœ–è™Ÿ (Drawing No.)</label>
    <select id="drawingNo">
  <option value="">è«‹é¸æ“‡åœ–è™Ÿ / Select Drawing</option>
  <option value="AKF-TOF-GRH2021A-3">AKF-TOF-GRH2021A-3</option>
  <option value="AKF-TOF-GRH2021B-3">AKF-TOF-GRH2021B-3</option>
  <option value="AKF-TOF-GRH2021H-4">AKF-TOF-GRH2021H-4</option>
  <option value="AKF-TOF-WXH2059A-2">AKF-TOF-WXH2059A-2</option>
  <option value="AKF-TOF-WXH2059B-2">AKF-TOF-WXH2059B-2</option>
  <option value="AKF-TOF-WXH2059H-2">AKF-TOF-WXH2059H-2</option>
</select>
  </div>
  
<div>
  <label data-i18n="labelMaterial">æè³ª</label>
  <select id="material">
    <option value="">è«‹é¸æ“‡æè³ª / Select Material</option>
    <option value="STEEL">ç¢³é‹¼ (STEEL)</option>
    <option value="STAINLESS STEEL">ä¸é½é‹¼ (STAINLESS STEEL)</option>
  </select>
</div>

</div>
<div class="row">
  <div>
  <label data-i18n="labelSpec">è¦æ ¼</label>
  <select id="spec">
    <option value="">è«‹é¸æ“‡è¦æ ¼ / Select Spec</option>
    <option value="M6X8X25">M6X8X25</option>
    <option value="M8X10X25">M8X10X25</option>
    <option value="M8X10X30">M8X10X30</option>
    <option value="M8X10X40">M8X10X40</option>
    <option value="M10X12X25">M10X12X25</option>
    <option value="M10X12X30">M10X12X30</option>
    <option value="M10X12X40">M10X12X40</option>
    <option value="M12X15X25">M12X15X25</option>
    <option value="M12X15X50">M12X15X50</option>
    <option value="M16X20X65">M16X20X65</option>
  </select>
</div>
  <div>
    <label data-i18n="labelCategory">ç”¢å“é¡åˆ¥</label>
    <select id="category"></select>
  </div>
</div>
<div class="row">
  <div>
    <label data-i18n="labelProcess">è£½ç¨‹ (Process)</label>
    <select id="process"></select>
  </div>
  <div>
    <label data-i18n="labelNotes">å‚™è¨»</label>
    <textarea id="notes" rows="2"></textarea>
  </div>
</div>
<!-- åƒè€ƒç°¡åœ–ï¼ˆæ”¾åœ¨åŸºæœ¬è³‡æ–™èˆ‡å°ºå¯¸è¡¨ä¹‹é–“ï¼‰ -->
      <div class="sketch-box">
        <h3 data-i18n="sketchTitle">åƒè€ƒç°¡åœ–</h3>
        <div class="sketch-wrap">
          <img id="sketchImg" src="final_finished.jpg" alt="åƒè€ƒç°¡åœ– / Reference sketch" style="max-width:100%;">
          <div class="sketch-note" data-i18n="sketchHint">ä¾›æª¢é©—æ™‚å¿«é€Ÿåƒè€ƒä¸»è¦å°ºå¯¸èˆ‡å½¢ç‹€ï¼ˆåœ–æª”ï¼š{file}ï¼‰ã€‚</div>
        </div>
      </div>

      <!-- æ•´åˆè¡¨ï¼šç¬¬1åˆ—ï¼å¤–è§€ï¼ˆå¯ç•¥éï¼‰ï¼›ç¬¬2åˆ—èµ·ï¼å°ºå¯¸ -->
      <h3 style="margin-top:20px" data-i18n="sectionTitle">å°ºå¯¸èˆ‡å¤–è§€æª¢é©—</h3>
      <p class="hint" data-i18n="hintAppearance">ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚</p>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:8%" data-i18n="thCode">ä»£è™Ÿ</th>
            <th style="width:14%" data-i18n="thItem">é …ç›® / å°ºå¯¸åç¨±</th>
            <th style="width:10%" data-i18n="thNominal">æ¨™æº–å€¼</th>
            <th style="width:10%" data-i18n="thTolMinus">ä¸‹é™å…¬å·®</th>
            <th style="width:10%" data-i18n="thTolPlus">ä¸Šé™å…¬å·®</th>
            <th style="width:8%" data-i18n="thM1">å¯¦æ¸¬1</th>
            <th style="width:8%" data-i18n="thM2">å¯¦æ¸¬2</th>
            <th style="width:8%" data-i18n="thM3">å¯¦æ¸¬3</th>
            <th style="width:8%" data-i18n="thM4">å¯¦æ¸¬4</th>
            <th style="width:8%" data-i18n="thM5">å¯¦æ¸¬5</th>
            <th style="width:8%" data-i18n="thDecision">çµæœ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="toolbar">
        <button class="btn btn-ghost" id="btnAdd" data-i18n="btnAdd">ï¼‹æ–°å¢å°ºå¯¸</button>
        <button class="btn btn-ghost" id="btnRemove" data-i18n="btnRemove">ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—</button>
        <button class="btn btn-ghost" id="btnClearRows" data-i18n="btnClearRows">æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰</button>
        <button class="btn btn-ghost" id="btnLang2">ğŸŒ èªè¨€</button>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="btnSave" data-i18n="btnSave">å„²å­˜åˆ°é›²ç«¯</button>
        <a class="btn btn-secondary" href="report.html" id="btnGoReport" data-i18n="btnGoReport">æŸ¥çœ‹/åˆ—å°å ±å‘Š</a>
      </div>

      <p id="msg" class="muted" style="margin-top:8px"></p>
    </div>

    <!-- viewer æç¤º -->
    <p id="viewOnlyTip" class="muted hidden" data-i18n="viewOnlyTip">
      æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚
    </p>
  </div>

  <!-- èªè¨€é¸æ“‡å½ˆçª— -->
  <div class="modal-backdrop" id="langModal">
    <div class="modal">
      <h3 data-i18n="langTitle">é¸æ“‡èªè¨€ / Language</h3>
      <p class="muted" data-i18n="langHint">è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š</p>
      <div class="grid">
        <button class="btn btn-ghost" onclick="selectLang('zh-TW')">ç¹é«”ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('zh-CN')">ç®€ä½“ä¸­æ–‡</button>
        <button class="btn btn-ghost" onclick="selectLang('en')">English</button>
      </div>
    </div>
  </div>

  <script>
    
// Explicit element lookups to avoid relying on legacy global IDs
const loginView = document.getElementById('loginView');
const formView = document.getElementById('formView');
const viewOnlyTip = document.getElementById('viewOnlyTip');
let _afterPick = null;
/* ============ I18N å­—å…¸ï¼ˆè£œä¸Š labelProcessï¼Œé¿å…é¡¯ç¤º key æœ¬èº«ï¼‰ ============ */
    const I18N = {
      'zh-TW': {

        title:'ç¾å ´å“æª¢ï¼ˆAKFï¼‰',
        loginPrompt:'è«‹è¼¸å…¥ã€Œå¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰ã€èˆ‡ã€Œå¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰ã€ã€‚',
        labelAccount:'å¸³è™Ÿï¼ˆæª¢é©—äººå“¡ï¼‰', labelPassword:'å¯†ç¢¼ï¼ˆé€šé—œç¢¼/å¯†ç¢¼ï¼‰',
        btnLogin:'ç™»å…¥', btnReset:'æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„', btnHealth:'å¥åº·æª¢æŸ¥',
        labelSupplier:'ä¾›æ‡‰å•†', labelPartNo:'æ–™è™Ÿ (Part No.)', labelDrawingNo:'åœ–è™Ÿ (Drawing No.)',
        labelRevision:'ç‰ˆæ¬¡ (Revision)', labelProcess:'è£½ç¨‹ (Process)', labelNotes:'å‚™è¨»',
        labelOrderNo:'è¨‚å–®è™Ÿç¢¼',
        labelLotNo:'ç”Ÿç”¢æ‰¹è™Ÿ',
        labelMaterial:'æè³ª',
        labelSpec:'è¦æ ¼',
        labelCategory:'ç”¢å“é¡åˆ¥',
        phOrderNo:'ä¾‹å¦‚ï¼šPO12345',
        phLotNo:'ä¾‹å¦‚ï¼š2025-09-A',
        phMaterial:'ä¾‹å¦‚ï¼šSCM435',
        phSpec:'ä¾‹å¦‚ï¼šM8 x 30',
        phCategory:'ä¾‹å¦‚ï¼šèºæ “',
        sectionTitle:'å°ºå¯¸èˆ‡å¤–è§€æª¢é©—',
        hintAppearance:'ç¬¬ <strong>1</strong> åˆ—ç‚º <strong>å¤–è§€æª¢æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›å¾ç¬¬ <strong>2</strong> åˆ—é–‹å§‹ç‚ºå°ºå¯¸é‡æ¸¬ã€‚',
        thItem:'é …ç›® / å°ºå¯¸åç¨±', thCode:'ä»£è™Ÿ', thNominal:'æ¨™æº–å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
        thM1:'å¯¦æ¸¬1', thM2:'å¯¦æ¸¬2', thM3:'å¯¦æ¸¬3', thM4:'å¯¦æ¸¬4', thM5:'å¯¦æ¸¬5', thDecision:'çµæœ',
        btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆªé™¤æœ€å¾Œä¸€åˆ—', btnClearRows:'æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰',
        btnSave:'å„²å­˜åˆ°é›²ç«¯', btnGoReport:'æŸ¥çœ‹/åˆ—å°å ±å‘Š',
        viewOnlyTip:'æ‚¨çš„è§’è‰²æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/å°å ±å‘Šï¼‰ã€‚è«‹æ”¹åˆ° <a href="report.html">å ±å‘Šé </a>ã€‚',
        langTitle:'é¸æ“‡èªè¨€ / Language', langHint:'è«‹é¸æ“‡ä»‹é¢èªè¨€ï¼š',
        phAccount:'ä¾‹å¦‚ï¼šboss / work1 / QC1', phPassword:'ä¾‹å¦‚ï¼šadmin*** / in*** / view***',
        phSupplier:'ä¾‹å¦‚ï¼šå®‰æ‹“ / å®‰å¯', phPartNo:'ä¾‹å¦‚ï¼šRT138', phDrawingNo:'ä¾‹å¦‚ï¼šWKNO137-6', phRevision:'ä¾‹å¦‚ï¼šRev.B', phNotes:'ä¾‹å¦‚ï¼šå°ºå¯¸ç©©å®š/å¤–è§€ç„¡ç‘•ç–µ',
        'é …ç›®/å°ºå¯¸åç¨±':'ä¾‹ï¼šé ­éƒ¨åšåº¦', phCode:'ä¾‹å¦‚ A1 / H1', phCode:'ä¾‹å¦‚ A1 / H1', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100',
        phM1:'å¯¦æ¸¬1', phM2:'å¯¦æ¸¬2', phM3:'å¯¦æ¸¬3', phM4:'å¯¦æ¸¬4', phM5:'å¯¦æ¸¬5',
        login_msg_need:'è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼', login_msg_auto:'è‡ªå‹•é©—è­‰ä¸­...', login_msg_wrong:'âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤', login_verifying:'é©—è­‰ä¸­...',
        save_saving:'å„²å­˜ä¸­...', save_ok:'âœ… å·²å„²å­˜åˆ°é›²ç«¯ï¼ˆå¯åˆ°å ±å‘Šé æŸ¥çœ‹/åˆ—å°ï¼‰', save_fail:'âŒ å„²å­˜å¤±æ•—ï¼š',
        need_supplier_part:'è«‹è¼¸å…¥ä¾›æ‡‰å•†èˆ‡æ–™è™Ÿ',
        appearanceTitle:'å¤–è§€æª¢æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG',
        sketchTitle:"\u53c3\u8003\u7c21\u5716", sketchHint:"\u4f9b\u6aa2\u9a57\u6642\u5feb\u901f\u53c3\u8003\u4e3b\u8981\u5c3a\u5bf8\u8207\u5f62\u72c0\uff08\u5716\u6a94\uff1afinal_finished.jpg\uff09\u3002"
      },
      'zh-CN': { thCode:'ä»£å·', phCode:'ä¾‹å¦‚ A1 / H1', thCode:'ä»£å·', phCode:'ä¾‹å¦‚ A1 / H1',

        title:'ç°åœºå“æ£€ï¼ˆAKFï¼‰',
        loginPrompt:'è¯·è¾“å…¥ã€Œè´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰ã€ä¸ã€Œå¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰ã€ã€‚',
        labelAccount:'è´¦å·ï¼ˆæ£€éªŒäººå‘˜ï¼‰', labelPassword:'å¯†ç ï¼ˆé€šå…³ç /å¯†ç ï¼‰',
        btnLogin:'ç™»å½•', btnReset:'æ¸…é™¤æœ¬æœºè®°å½•', btnHealth:'å¥åº·æ£€æŸ¥',
        labelSupplier:'ä¾›åº”å•†', labelPartNo:'æ–™å· (Part No.)', labelDrawingNo:'å›¾å· (Drawing No.)',
        labelRevision:'ç‰ˆæ¬¡ (Revision)', labelProcess:'åˆ¶ç¨‹ (Process)', labelNotes:'å¤‡æ³¨', labelOrderNo:'è®¢å•å·ç ', labelLotNo:'ç”Ÿäº§æ‰¹å·', labelMaterial:'æè´¨', labelSpec:'è§„æ ¼', labelCategory:'äº§å“ç±»åˆ«',
        labelOrderNo:'è¨‚å–®è™Ÿç¢¼',
        labelLotNo:'ç”Ÿç”¢æ‰¹è™Ÿ',
        labelMaterial:'æè³ª',
        labelSpec:'è¦æ ¼',
        labelCategory:'ç”¢å“é¡åˆ¥',
        phOrderNo:'ä¾‹å¦‚ï¼šPO12345',
        phLotNo:'ä¾‹å¦‚ï¼š2025-09-A',
        phMaterial:'ä¾‹å¦‚ï¼šSCM435',
        phSpec:'ä¾‹å¦‚ï¼šM8 x 30',
        phCategory:'ä¾‹å¦‚ï¼šèºæ “',
        sectionTitle:'å°ºå¯¸ä¸å¤–è§‚æ£€éªŒ',
        hintAppearance:'ç¬¬ <strong>1</strong> è¡Œä¸º <strong>å¤–è§‚æ£€æŸ¥</strong>ï¼ˆå¯ç•™ç©ºï¼‰ï¼›ç¬¬ <strong>2</strong> è¡Œå¼€å§‹ä¸ºå°ºå¯¸é‡æµ‹ã€‚',
        thItem:'é¡¹ç›® / å°ºå¯¸åç§°', thCode:'ä»£è™Ÿ', thNominal:'æ ‡å‡†å€¼', thTolMinus:'ä¸‹é™å…¬å·®', thTolPlus:'ä¸Šé™å…¬å·®',
        thM1:'å®æµ‹1', thM2:'å®æµ‹2', thM3:'å®æµ‹3', thM4:'å®æµ‹4', thM5:'å®æµ‹5', thDecision:'åˆ¤å®š',
        btnAdd:'ï¼‹æ–°å¢å°ºå¯¸', btnRemove:'ï¼åˆ é™¤æœ€åä¸€è¡Œ', btnClearRows:'æ¸…ç©ºå°ºå¯¸è¡Œï¼ˆä¿ç•™å¤–è§‚ï¼‰',
        btnSave:'ä¿å­˜åˆ°äº‘ç«¯', btnGoReport:'æŸ¥çœ‹/æ‰“å°æŠ¥å‘Š',
        viewOnlyTip:'æ‚¨çš„è´¦å·æ˜¯ <strong>viewer</strong>ï¼ˆåªèƒ½çœ‹/æ‰“å°ï¼‰ã€‚è¯·å‰å¾€ <a href="report.html">æŠ¥å‘Šé¡µ</a>ã€‚',
        langTitle:'é€‰æ‹©è¯­è¨€ / Language', langHint:'è¯·é€‰æ‹©ç•Œé¢è¯­è¨€ï¼š',
        phAccount:'ä¾‹å¦‚ï¼šboss / work1 / QC1', phPassword:'ä¾‹å¦‚ï¼šadmin*** / in*** / view***',
        phSupplier:'ä¾‹å¦‚ï¼šå®‰æ‹“ / å®‰å¯', phPartNo:'ä¾‹å¦‚ï¼šRT138', phDrawingNo:'ä¾‹å¦‚ï¼šWKNO137-6', phRevision:'ä¾‹å¦‚ï¼šRev.B', phNotes:'ä¾‹å¦‚ï¼šå°ºå¯¸ç¨³å®š/å¤–è§‚æ— ç‘•ç–µ', phOrderNo:'ä¾‹å¦‚ï¼šPO12345', phLotNo:'ä¾‹å¦‚ï¼š2025-09-A', phMaterial:'ä¾‹å¦‚ï¼šSCM435', phSpec:'ä¾‹å¦‚ï¼šM8 x 30', phCategory:'ä¾‹å¦‚ï¼šèºæ “',
        'é …ç›®/å°ºå¯¸åç¨±':'ä¾‹ï¼šå¤´éƒ¨åšåº¦', phCode:'ä¾‹å¦‚ A1 / H1', phNominal:'ä¾‹ï¼š3.000', phTolMinus:'ä¾‹ï¼š-0.100', phTolPlus:'ä¾‹ï¼š0.100',
        phM1:'å®æµ‹1', phM2:'å®æµ‹2', phM3:'å®æµ‹3', phM4:'å®æµ‹4', phM5:'å®æµ‹5',
        login_msg_need:'è¯·è¾“å…¥è´¦å·ä¸å¯†ç ', login_msg_auto:'è‡ªåŠ¨éªŒè¯ä¸­...', login_msg_wrong:'âŒ è´¦å·æˆ–å¯†ç é”™è¯¯', login_verifying:'éªŒè¯ä¸­...',
        save_saving:'ä¿å­˜ä¸­...', save_ok:'âœ… å·²ä¿å­˜åˆ°äº‘ç«¯ï¼ˆå¯å»æŠ¥å‘Šé¡µæŸ¥çœ‹/æ‰“å°ï¼‰', save_fail:'âŒ ä¿å­˜å¤±è´¥ï¼š',
        need_supplier_part:'è¯·è¾“å…¥ä¾›åº”å•†ä¸æ–™å·',
        appearanceTitle:'å¤–è§‚æ£€æŸ¥', optionDash:'â€”', optionOK:'O.K', optionNG:'NG',
        sketchTitle:"\u53c2\u8003\u7b80\u56fe", sketchHint:"\u4fbf\u4e8e\u68c0\u9a8c\u65f6\u5feb\u901f\u53c2\u8003\u4e3b\u8981\u5c3a\u5bf8\u4e0e\u5f62\u72b6\uff08\u56fe\u6863\uff1afinal_finished.jpg\uff09\u3002"
      },
      'en': { thCode:'Code', phCode:'e.g. A1 / H1', thCode:'Code', phCode:'e.g. A1 / H1',
        title:'On-site QC (Anchor)',
        loginPrompt:'Please enter â€œAccount (Inspector)â€ and â€œPasswordâ€.',
        labelAccount:'Account (Inspector)', labelPassword:'Password',
        btnLogin:'Sign in', btnReset:'Clear local data', btnHealth:'Health Check',
        labelSupplier:'Supplier', labelPartNo:'Part No.', labelDrawingNo:'Drawing No.',
        labelRevision:'Revision', labelProcess:'Process', labelNotes:'Notes', labelOrderNo:'Order No.', labelLotNo:'Lot No.', labelMaterial:'Material', labelSpec:'Spec', labelCategory:'Product Category',
        labelOrderNo:'è¨‚å–®è™Ÿç¢¼',
        labelLotNo:'ç”Ÿç”¢æ‰¹è™Ÿ',
        labelMaterial:'æè³ª',
        labelSpec:'è¦æ ¼',
        labelCategory:'ç”¢å“é¡åˆ¥',
        phOrderNo:'ä¾‹å¦‚ï¼šPO12345',
        phLotNo:'ä¾‹å¦‚ï¼š2025-09-A',
        phMaterial:'ä¾‹å¦‚ï¼šSCM435',
        phSpec:'ä¾‹å¦‚ï¼šM8 x 30',
        phCategory:'ä¾‹å¦‚ï¼šèºæ “',
        sectionTitle:'Appearance & Dimensional Inspection',
        hintAppearance:'Row <strong>1</strong> is <strong>Appearance</strong> (optional). From row <strong>2</strong> onwards are dimensions.',
        thItem:'Item / Dimension', thCode:'Code', thNominal:'Nominal', thTolMinus:'Lower Tol.', thTolPlus:'Upper Tol.',
        thM1:'Sample1', thM2:'Sample2', thM3:'Sample3', thM4:'Sample4', thM5:'Sample5', thDecision:'Decision',
        btnAdd:'ï¼‹Add dimension', btnRemove:'ï¼Remove last row', btnClearRows:'Clear dimension rows (keep appearance)',
        btnSave:'Save to cloud', btnGoReport:'View/Print Reports',
        viewOnlyTip:'Your role is <strong>viewer</strong> (view/print only). Go to <a href="report.html">Reports</a>.',
        langTitle:'Choose language', langHint:'Select UI language:',
        sketchTitle:'Reference Sketch', sketchHint:'For quick reference to key dimensions and shapes (file: {file}).',

        phAccount:'e.g. boss / work1 / QC1', phPassword:'e.g. admin*** / in*** / view***',
        phSupplier:'e.g. Anchor / AKF', phPartNo:'e.g. RT138', phDrawingNo:'e.g. WKNO137-6', phRevision:'e.g. Rev.B', phNotes:'e.g. Dimensions stable / No defects', phOrderNo:'e.g. PO12345', phLotNo:'e.g. 2025-09-A', phMaterial:'e.g. SCM435', phSpec:'e.g. M8 x 30', phCategory:'e.g. Bolt',
        'é …ç›®/å°ºå¯¸åç¨±':'e.g. Head thickness', phCode:'ä¾‹å¦‚ A1 / H1', phNominal:'e.g. 3.000', phTolMinus:'e.g. -0.100', phTolPlus:'e.g. 0.100',
        phM1:'Sample1', phM2:'Sample2', phM3:'Sample3', phM4:'Sample4', phM5:'Sample5',
        login_msg_need:'Please enter account & password', login_msg_auto:'Auto checking...', login_msg_wrong:'âŒ Wrong account or password', login_verifying:'Verifying...',
        save_saving:'Saving...', save_ok:'âœ… Saved (check the report page to view/print)', save_fail:'âŒ Save failed: ',
        need_supplier_part:'Enter supplier & part no.',
        appearanceTitle:'Appearance', optionDash:'â€”', optionOK:'O.K', optionNG:'NG'
      }
    };

    // èªè¨€å·¥å…·
    function getLang(){ return localStorage.getItem('qci_lang') || ''; }
    function setLang(lang){ localStorage.setItem('qci_lang', lang); applyI18n(); }
    function selectLang(lang){ setLang(lang); closeLangModal(); if (typeof _afterPick === 'function') _afterPick(); }
    function openLangModal(){ document.getElementById('langModal').style.display='flex'; }
    function closeLangModal(){ document.getElementById('langModal').style.display='none'; }
    function t(key){ const lang = getLang() || 'zh-TW'; const dict = I18N[lang] || I18N['zh-TW']; return dict[key] ?? (I18N['zh-TW'][key] ?? key); }
    function applyI18n(){
      // å¡«é¸å–®ï¼ˆæœƒç”¨åˆ°èªè¨€ï¼‰
      fillSupplierSelect(); 
      fillProcessSelect();
      fillCategorySelect();

      // æ–‡æ¡ˆ
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (k) el.innerHTML = t(k);
      });
      // placeholder
      const m = {
        '#inspector':'phAccount', '#passcode':'phPassword',
        '#supplier':'phSupplier', '#orderNo':'phOrderNo', '#lotNo':'phLotNo', '#partNo':'phPartNo', '#drawingNo':'phDrawingNo', '#material':'phMaterial', '#spec':'phSpec', '#category':'phCategory', '#notes':'phNotes'
      };
      Object.entries(m).forEach(([sel,key])=>{ const el=document.querySelector(sel); if (el) el.placeholder = t(key); });
      updateSketchByCategory();
    }

    // ä¾›æ‡‰å•†ä¸‹æ‹‰
    const SUPPLIERS = [
      { code:'å®‰å¯', zh:'å®‰å¯', en:'AKF' },
      { code:'å®‰æ‹“', zh:'å®‰æ‹“', en:'ANCHOR' }
    ];
    function fillSupplierSelect(){
      const sel = document.getElementById('supplier');
      if (!sel) return;
      sel.innerHTML = SUPPLIERS.map(s=>`<option value="${s.code}" data-zh="${s.zh}" data-en="${s.en}">${s.zh} (${s.en})</option>`).join('');
      const hint = document.getElementById('supplierEn');
      sel.onchange = ()=>{
        const opt = sel.options[sel.selectedIndex];
        hint.textContent = opt ? `English: ${opt.dataset.en}` : '';
      };
      sel.dispatchEvent(new Event('change'));
    }

    // è£½ç¨‹ä¸‹æ‹‰
    const PROCESSES = [
      { code:'WIRE', zh:'ç·šæ', en:'WIRE' },
      { code:'FORMING', zh:'æˆå½¢', en:'FORMING' },
      { code:'TAPING', zh:'æ”»ç‰™', en:'TAPING' },
      { code:'CUTTING', zh:'å‰²æº', en:'CUTTING' },
      { code:'PLATING', zh:'é›»é', en:'PLATING' },
      { code:'FINISHED', zh:'æˆå“', en:'FINISHED' },
      { code:'ASSEMBLY', zh:'çµ„ç«‹', en:'ASSEMBLY' },
      { code:'FINAL', zh:'æœ€çµ‚æˆå“', en:'FINAL FINISHED' }
    ];
    function fillProcessSelect(){
      const sel = document.getElementById('process');
      if (!sel) return;
      sel.innerHTML = '<option value=""></option>' + PROCESSES.map(p=>`<option value="${p.code}" data-zh="${p.zh}" data-en="${p.en}">${p.zh} (${p.en})</option>`).join('');
    }



// === Reference sketch switcher ===
function getSketchFileForCategory(code){
  switch(String(code||'').toUpperCase()){
    case 'PLUG': return 'plug.jpg';
    case 'TOOL': return 'special_tool.jpg';
    case 'SLEEVE_A': return 'sleeve_A.jpg';
    case 'SLEEVE_B': return 'sleeve_B.jpg';
    case 'SLEEVE_H': return 'sleeve_H.jpg';
    case 'FINISHED_A': return 'finish_A.jpg';
    case 'FINISHED_B': return 'finish_A.jpg';
    case 'FINISHED_H': return 'finish_H.jpg';
    default:     return 'final_finished.jpg';
  }
}
function updateSketchByCategory(){
  const sel = document.getElementById('category');
  const img = document.getElementById('sketchImg');
  const note = document.querySelector('.sketch-note');
  if (!img) return;
  const file = getSketchFileForCategory(sel ? sel.value : '');
  img.src = file;
  if (note){
    // Use i18n text and fill in {file}
    const base = t('sketchHint');
    note.innerHTML = String(base || '').replace('{file}', file);
  }
}
// ç”¢å“é¡åˆ¥ä¸‹æ‹‰ï¼ˆé›™èªé¸å–®ï¼‰
const CATEGORIES = [
  { code:'PLUG',        zh:'å¡å­',         cn:'å¡å­',       en:'plug' },
  { code:'SLEEVE_A',    zh:'ç®¡å­_A type',  cn:'ç®¡å­_A type', en:'sleeve_A type' },
  { code:'SLEEVE_B',    zh:'ç®¡å­_B type',  cn:'ç®¡å­_B type', en:'sleeve_B type' },
  { code:'SLEEVE_H',    zh:'ç®¡å­_H type',  cn:'ç®¡å­_H type', en:'sleeve_H type' },
  { code:'FINISHED_A',  zh:'æˆå“_A type',  cn:'æˆå“_A type', en:'Finished_A type' },
  { code:'FINISHED_B',  zh:'æˆå“_B type',  cn:'æˆå“_B type', en:'Finished_B type' },
  { code:'FINISHED_H',  zh:'æˆå“_H type',  cn:'æˆå“_H type', en:'Finished_H type' },
  { code:'TOOL',        zh:'å…§è¿«å·¥å…·',     cn:'å†…è¿«å·¥å…·',    en:'special tool' }
];
function _categoryLabel(code){
  const lang = getLang() || 'zh-TW';
  const c = CATEGORIES.find(x => x.code === String(code||'').toUpperCase());
  if (!c) return String(code||'');
  if (lang==='en') return c.en;
  if (lang==='zh-CN') return `${c.cn} (${c.en})`;
  return `${c.zh} (${c.en})`;
}
function fillCategorySelect(){
  const sel = document.getElementById('category');
  if (!sel) return;
  const prev = sel.value;
  // å…ˆæ”¾ä¸€å€‹ç©ºç™½é¸é …ï¼ˆå¯ä¿æŒèˆŠé‚è¼¯å…è¨±ç©ºç™½ï¼‰
  sel.innerHTML = '<option value=""></option>' + CATEGORIES.map(c => 
    `<option value="${c.code}">${c.zh} (${c.en})</option>`
  ).join('');
  if (prev) sel.value = prev;
  // ç¶å®šäº‹ä»¶ä¸¦ç«‹å³å¥—ç”¨ä¸€æ¬¡
  sel.removeEventListener('change', updateSketchByCategory);
  sel.addEventListener('change', updateSketchByCategory);
  updateSketchByCategory();
}



    // è¡¨æ ¼å»ºç½®
    const tbody = document.getElementById('tbody');
    function ensureAppearanceRow(){
      if (!tbody.querySelector('tr[data-type="appearance"]')){
        const tr = document.createElement('tr');
        tr.setAttribute('data-type','appearance');
        tr.innerHTML = `
          <td></td>
<td><strong data-i18n="appearanceTitle">å¤–è§€æª¢æŸ¥</strong></td>
<td colspan="3" class="muted">ï¼ˆå¯ç•™ç©ºï¼‰</td>
<td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td>
<td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td>
<td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td>
<td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td>
<td><select class="ap"><option value=""></option><option value="OK">O.K</option><option value="NG">NG</option></select></td>
<td></td>`;
        tbody.appendChild(tr);
      updateDecisionForRow(tr);
      }
    }
    function addMeasureRow(){
      const tr = document.createElement('tr');
      tr.setAttribute('data-type','measure');
      tr.innerHTML = `
        <td><input class="code" placeholder="${t('phCode')}" /></td>
        <td><input class="name" placeholder="é …ç›®/å°ºå¯¸åç¨±" /></td>
        <td><input class="nom" type="number" step="0.001" placeholder="${t('phNominal')}" /></td>
        <td><input class="lo"  type="number" step="0.001" placeholder="${t('phTolMinus')}" /></td>
        <td><input class="hi"  type="number" step="0.001" placeholder="${t('phTolPlus')}" /></td>
        <td><input class="m m1" type="number" step="0.001" placeholder="${t('phM1')}" /></td>
        <td><input class="m m2" type="number" step="0.001" placeholder="${t('phM2')}" /></td>
        <td><input class="m m3" type="number" step="0.001" placeholder="${t('phM3')}" /></td>
        <td><input class="m m4" type="number" step="0.001" placeholder="${t('phM4')}" /></td>
        <td><input class="m m5" type="number" step="0.001" placeholder="${t('phM5')}" /></td>
        <td></td>`;
      updateDecisionForRow(tr);;
      tbody.appendChild(tr);
    }
    function countMeasureRows(){ return tbody.querySelectorAll('tr[data-type="measure"]').length; }
    function ensureMeasureRows(n){
      while (countMeasureRows() < n) addMeasureRow();
    }
    function removeLastMeasureRow(){
      const rows = tbody.querySelectorAll('tr[data-type="measure"]');
      if (rows.length) rows[rows.length - 1].remove();
    }
    function clearMeasureRows(){
      tbody.querySelectorAll('tr[data-type="measure"]').forEach(tr=>tr.remove());
    }
    

    // === Auto template for Process ===
    function _i18nText(keyZhTW, keyZhCN, keyEN){
      const lang = getLang() || 'zh-TW';
      if (lang === 'en') return keyEN;
      if (lang === 'zh-CN') return keyZhCN;
      return keyZhTW;
    }
    function setAppearanceCode(codeText){
      const row = tbody.querySelector('tr[data-type="appearance"]');
      if (!row) return;
      const codeCell = row.querySelector('td:first-child');
      if (codeCell) codeCell.textContent = codeText || '';
    }
    function addMeasureRowWith(code, nameText){
      addMeasureRow();
      const rows = tbody.querySelectorAll('tr[data-type="measure"]');
      const tr = rows[rows.length - 1];
      tr.querySelector('.code').value = code || '';
      tr.querySelector('.name').value = nameText || '';
      updateDecisionForRow(tr);
    }
    function applyWireTemplate(){
      // 1) å¤–è§€åˆ— + è¨­å®šä»£è™Ÿ A
      ensureAppearanceRow();
      setAppearanceCode('A');
      // 2) æ¸…ç©ºæ—¢æœ‰å°ºå¯¸åˆ—å¾Œæ”¾å…¥ B/C
      clearMeasureRows();
      addMeasureRowWith('B', _i18nText('å¤–å¾‘', 'å¤–å¾„', 'Outer diameter'));
      addMeasureRowWith('C', _i18nText('ç¡¬åº¦(HRB)', 'ç¡¬åº¦(HRB)', 'Hardness (HRB)'));
      updateAllDecisions();
    }
    function onProcessChanged(){
      const sel = document.getElementById('process');
      const val = String(sel && sel.value || '').toUpperCase();
      if (val === 'WIRE'){
        applyWireTemplate();
      }
    }

// åˆ¤å®šå–®åˆ— PASS/FAILï¼ˆæœ‰åç›® & å…¬å·® & è‡³å°‘ä¸€ç­†å¯¦æ¸¬æ‰åˆ¤ï¼‰
    function decidePass(nom, lo, hi, measured){
      const hasNom = (nom===0 || nom) && !isNaN(Number(nom));
      const hasLo  = (lo===0  || lo)  && !isNaN(Number(lo));
      const hasHi  = (hi===0  || hi)  && !isNaN(Number(hi));
      const vals = Array.isArray(measured) ? measured.filter(v => v===0 || v).map(Number) : [];
      if (!(hasNom && hasLo && hasHi) || vals.length===0) return undefined; // ä¸é¡¯ç¤º
      const min = Number(nom) + Number(lo), max = Number(nom) + Number(hi);
      return vals.every(v => v>=min && v<=max);
    }
    function updateDecisionForRow(tr){
      if (!tr) return;
      const cell = tr.querySelector('td:last-child');
      if (!cell) return;
      if (tr.getAttribute('data-type')==='appearance'){
        const oks = Array.from(tr.querySelectorAll('select.ap')).map(s => (s.value||'').toUpperCase());
        const filled = oks.filter(v => v==='OK' || v==='O.K' || v==='NG');
        if (!filled.length){ cell.textContent=''; cell.className=''; return; }
        const allOk = oks.every(v => v==='OK' || v==='O.K');
        cell.textContent = allOk ? 'PASS' : 'FAIL';
        cell.className = allOk ? 'pass' : 'fail';
        return;
      }
      // measure
      const nom = tr.querySelector('.nom').value;
      const lo  = tr.querySelector('.lo').value;
      const hi  = tr.querySelector('.hi').value;
      const ms  = [1,2,3,4,5].map(i => tr.querySelector('.m'+i).value===''?null:Number(tr.querySelector('.m'+i).value));
      const dec = decidePass(nom, lo, hi, ms);
      if (typeof dec==='boolean'){
        cell.textContent = dec ? 'PASS' : 'FAIL';
        cell.className = dec ? 'pass' : 'fail';
      }else{
        cell.textContent = ''; cell.className='';
      }
    }
    function updateAllDecisions(){
      tbody.querySelectorAll('tr').forEach(updateDecisionForRow);
    }
    

    // ç™»å…¥èˆ‡æ¬Šé™ï¼ˆèˆ‡å¾Œç«¯ inspections.js ç›¸å®¹ï¼‰
    async function authCheck(u,p){
      try{
        const r = await fetch('/api/inspections?auth=1', { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p }});
        const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        return (r.ok && j && j.ok!==false) ? { ok:true, role:j.role||'input' } : { ok:false };
      }catch{ return { ok:false }; }
    }
    function showByRole(role){
  // æˆåŠŸå¾Œä¸€å¾‹æŠŠç™»å…¥å€ç§»é™¤ç•«é¢ï¼ˆä¿ç•™æ–¼ DOM ä»¥ä¾¿ 401 æ™‚å¯å†é¡¯ç¤ºï¼‰
  loginView.classList.add('hidden');
  loginView.style.display = 'none';
  if (role === 'viewer'){
    formView.classList.add('hidden');
    viewOnlyTip.classList.remove('hidden');
  } else {
    formView.classList.remove('hidden');
    viewOnlyTip.classList.add('hidden');
  }
}
    // å»ºç«‹è¦å„²å­˜çš„ç´€éŒ„
    function buildRecord(){
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      if (!user || !pass){ alert(t('login_msg_need')); return null; }

      const orderNo = document.getElementById('orderNo').value.trim();
      const lotNo = document.getElementById('lotNo').value.trim();
      const partNo = document.getElementById('partNo').value.trim();
      const drawingNo = document.getElementById('drawingNo').value.trim();
      const material = document.getElementById('material').value.trim();
      const spec = document.getElementById('spec').value.trim();
      const category = document.getElementById('category').value.trim();
      const notes = document.getElementById('notes').value.trim();

      const selS = document.getElementById('supplier');
      const sOpt = selS.options[selS.selectedIndex];
      const selP = document.getElementById('process');
      const pOpt = selP.options[selP.selectedIndex];

      // å…è¨±å„²å­˜ç©ºç™½å ±å‘Šï¼ˆç„¡ä¾›æ‡‰å•†æˆ–æ–™è™Ÿï¼‰ï¼Œè©¢å•ç¢ºèª
if (!sOpt || !partNo) {
  const go = confirm(t('confirm_save_empty') || 'åµæ¸¬åˆ°æœªå¡«ä¾›æ‡‰å•†/æ–™è™Ÿï¼Œæ˜¯å¦ä»è¦å„²å­˜ç‚ºã€Œç©ºç™½å ±å‘Šã€ï¼Ÿ');
  if (!go) return null;
}


      // å¤–è§€
      const apSel = Array.from(tbody.querySelectorAll('tr[data-type="appearance"] select.ap'));
      const apHas = apSel.some(x => x.value);
      const appearance = apHas ? apSel.map((s,i)=>({ sample:`æ¨£å“${i+1}`, result: s.value||'' })) : [];

      // å°ºå¯¸
      const rows = Array.from(tbody.querySelectorAll('tr[data-type="measure"]'));
  const measurements = rows.map(tr => {
    const codes = tr.querySelectorAll('.code');
    const code1 = (codes[0]?.value || '').trim();
    const code2 = (codes[1]?.value || '').trim();
    const name = tr.querySelector('.name').value.trim();
    const nom = tr.querySelector('.nom').value;
    const lo  = tr.querySelector('.lo').value;
    const hi  = tr.querySelector('.hi').value;
    const ms = [1,2,3,4,5].map(i => {
      const v = tr.querySelector('.m'+i).value;
      return v==='' ? null : Number(v);
    });
    
    return {
      code: code1 + (code2 ? '/' + code2 : ''), // åˆä½µå…©å€‹ä»£è™Ÿ
      name,
      nominal: nom===''?null:Number(nom),
      tolMinus: lo===''?null:Number(lo),
      tolPlus: hi===''?null:Number(hi),
      measured: ms,
      pass: decidePass(nom, lo, hi, ms)
    };
  });

      // æ•´é«”çµæœ
      function calcOverall(){
        const apOK = !appearance.length || appearance.every(a => String(a.result||'').toUpperCase()==='OK');
        const msOK = !measurements.length || measurements.every(m => {
          const nom = Number(m.nominal); const lo=Number(m.tolMinus); const hi=Number(m.tolPlus);
          if (isNaN(nom) || isNaN(lo) || isNaN(hi)) return true;
          const min = nom + lo, max = nom + hi;
          const arr = Array.isArray(m.measured)?m.measured:[];
          const vals = arr.filter(v=>v===0 || v).map(Number);
          return vals.length===0 || vals.every(v => v>=min && v<=max);
        });
        return (apOK && msOK) ? 'PASS' : 'FAIL';
      }

      const now = new Date();
      const id = `INS-${now.toISOString().replace(/[-:T]/g,'').slice(0,14)}-${Math.floor(100+Math.random()*900)}`;

      return {
        id, timestamp: now.toISOString(),
        inspector: user,
        supplier: (sOpt ? sOpt.dataset.zh : ''), supplierEn: (sOpt ? sOpt.dataset.en : ''), supplierCode: (sOpt ? sOpt.value : ''),
        orderNo, lotNo, partNo, drawingNo, material, spec, category, revision: '', // ç›¸å®¹èˆŠæ¬„ä½å­˜åœ¨ï¼Œä½†ä¸ä½¿ç”¨
        process: pOpt ? pOpt.value : '', processLabel: pOpt ? (pOpt.dataset.zh + ' (' + pOpt.dataset.en + ')') : '',
        notes, appearance, measurements,
        overallResult: calcOverall()
      };
    }

    // å„²å­˜
    async function save(){
      const btn = document.getElementById('btnSave');
      const msg = document.getElementById('msg');
      btn.disabled = true; msg.textContent = t('save_saving');
      const rec = buildRecord();
      if (!rec){ btn.disabled = false; return; }
      const u = localStorage.getItem('qci_user') || '';
      const p = localStorage.getItem('qci_pass') || '';
      try{
        const r = await fetch('/api/inspections', {
          method:'POST',
          headers: { 'Content-Type':'application/json', 'x-user':u, 'x-pass':p, 'x-passcode':p },
          body: JSON.stringify({ record: rec })
        });
        const ttxt = await r.text(); let j={}; try{ j=JSON.parse(ttxt);}catch{}
        if (!r.ok || (j && j.error)) throw new Error(j.error || ttxt);
        msg.textContent = t('save_ok');
        // æ¸…ç©ºå°ºå¯¸åˆ—ï¼ˆä¿ç•™å¤–è§€ï¼‰
        clearMeasureRows(); ensureMeasurementTemplate();
        onProcessChanged();
      }catch(e){
        msg.textContent = t('save_fail') + (e.message||e);
      }finally{
        btn.disabled = false;
      }
    }

    // ç™»å…¥
    async function onLogin(){
      const u = document.getElementById('inspector').value.trim();
      const p = document.getElementById('passcode').value.trim();
      if (!u || !p){ document.getElementById('loginMsg').textContent = t('login_msg_need'); return; }
      const info = await authCheck(u,p);
      if (!info.ok){ document.getElementById('loginMsg').textContent = t('login_msg_wrong'); return; }
      localStorage.setItem('qci_user', u);
      localStorage.setItem('qci_pass', p);
      localStorage.setItem('qci_role', info.role || '');
      document.getElementById('loginMsg').textContent = '';
      showByRole(info.role);
      ensureMeasurementTemplate();
        onProcessChanged();
    }

    // åˆå§‹å¤–è§€ + è‡³å°‘ 1 åˆ—å°ºå¯¸
    function ensureMeasurementTemplate(){
      ensureAppearanceRow();
      if (countMeasureRows() === 0) ensureMeasureRows(1);
      updateAllDecisions();
    }

    // ç¶å®šäº‹ä»¶
    document.getElementById('btnLogin').addEventListener('click', onLogin);
    document.getElementById('btnResetPass').addEventListener('click', () => {
      ['qci_user','qci_pass','qci_role','qci_passcode','qci_inspector','qci_lang'].forEach(k => localStorage.removeItem(k));
      alert('Cleared. / å·²æ¸…é™¤ã€‚');
      location.reload();
    });
    document.getElementById('btnLang').addEventListener('click', ()=>{ _afterPick = applyI18n; openLangModal(); });
    document.getElementById('btnLang2').addEventListener('click', ()=>{ _afterPick = applyI18n; openLangModal(); });
    document.getElementById('btnAdd').addEventListener('click', addMeasureRow);
    document.getElementById('btnRemove').addEventListener('click', removeLastMeasureRow);
    document.getElementById('btnClearRows').addEventListener('click', ()=>{ clearMeasureRows(); });

    
    // åŠæ™‚åˆ¤å®šï¼šè¼¸å…¥/è®Šæ›´æ™‚é‡æ–°è¨ˆç®— PASS/FAIL
    tbody.addEventListener('input', (e)=>{ const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });
    tbody.addEventListener('change', (e)=>{ const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });

    // ç¶å®šå„²å­˜
    document.getElementById('btnSave').addEventListener('click', save);


      // è£½ç¨‹é¸æ“‡æ”¹è®Š â†’ è‹¥ç‚º WIREï¼Œå¥—ç”¨é è¨­æ¨¡æ¿
      const _procSel = document.getElementById('process');
      if (_procSel){
        _procSel.removeEventListener('change', onProcessChanged);
        _procSel.addEventListener('change', onProcessChanged);
      }

window.addEventListener('DOMContentLoaded', ()=>{
      // é¦–æ¬¡æ¸²æŸ“ i18n èˆ‡é¸å–®
      applyI18n();
      // è‹¥æ›¾ç¶“ç™»å…¥éï¼Œè‡ªå‹•é¡¯ç¤ºè¡¨å–®
      const u = localStorage.getItem('qci_user') || '';
      const p = localStorage.getItem('qci_pass') || '';
      if (u && p){
        showByRole(localStorage.getItem('qci_role') || 'input');
        ensureMeasurementTemplate();
        onProcessChanged();
      }
    });
  </script>
</body>
</html>
