<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>供應商品檢（輸入）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif;line-height:1.5;margin:0;background:#f7f7f7;}
    header{background:#1f2937;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    header .left{display:flex;gap:12px;align-items:center}
    header h1{font-size:18px;margin:0}
    main{max-width:1100px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.04);padding:14px 16px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    label{font-weight:600;font-size:13px;display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;padding:8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    textarea{min-height:76px}
    .row{display:flex;gap:8px;align-items:center}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111827}
    .muted{color:#6b7280;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}
    thead th{background:#f3f4f6}
    .right{float:right}
    .tag{display:inline-block;padding:0 8px;border-radius:10px;font-size:12px}
    .tag.pass{background:#e1fbea;color:#065f46}
    .tag.fail{background:#fee2e2;color:#991b1b}
    .hint{color:#6b7280;margin:6px 0 0 0;font-size:12px}
    .hide{display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>供應商品檢（輸入）</h1>
      <button id="btnLang" class="secondary">語言</button>
    </div>
    <div>
      <button id="btnReport" class="secondary" onclick="location.href='report.html'">查看/列印報告</button>
      <button id="btnPrint" class="secondary" onclick="location.href='print.html'">單筆列印</button>
      <button id="btnSaveTpl" class="secondary">預設版型儲存</button>
    </div>
  </header>

  <main>
    <div id="loginCard" class="card">
      <div class="grid-3">
        <div>
          <label>使用者</label>
          <input id="login_user" autocomplete="username">
        </div>
        <div>
          <label>密碼 / 通關碼</label>
          <input id="login_pass" type="password" autocomplete="current-password">
        </div>
        <div class="actions" style="align-items:end">
          <button id="btnLogin">登入</button>
          <button id="btnResetPass" class="secondary">清除快取</button>
        </div>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <div id="formCard" class="card hide">
      <h3>現場品檢基本資料</h3>
      <div class="grid">
        <div><label>供應商</label><input id="supplier"></div>
        <div><label>料號</label><input id="partNo"></div>
        <div><label>圖號</label><input id="drawingNo"></div>
        <div><label>材質</label><input id="material"></div>
        <div><label>規格</label><input id="spec"></div>
        <div><label>分類</label><input id="category"></div>
        <div><label>製程</label><input id="process"></div>
        <div><label>訂單</label><input id="orderNo"></div>
        <div><label>批號</label><input id="lotNo"></div>
        <div><label>備註</label><input id="notes"></div>
      </div>
    </div>

    <div id="measureCard" class="card hide">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">尺寸與外觀檢驗項目</h3>
        <div class="actions">
          <button id="btnAdd" class="secondary">+ 新增尺寸列</button>
          <button id="btnRemove" class="secondary">- 刪除最後一列</button>
          <button id="btnClearRows" class="secondary">清空尺寸列（保留外觀）</button>
        </div>
      </div>
      <p class="hint">* 第一列為「外觀檢查」，可留空。</p>

      <div class="tableWrap" style="overflow-x:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>編號</th>
              <th>檢驗項目</th>
              <th>名目</th>
              <th>下差</th>
              <th>上差</th>
              <th>M1</th><th>M2</th><th>M3</th><th>M4</th><th>M5</th>
              <th>判定</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:10px">
        <button id="btnSubmit">送出</button>
        <span id="msg" class="muted"></span>
      </div>
    </div>
  </main>

<script>
(function(){
  // ------------- i18n (暫留，保證鍵存在) -------------
  const I18N = {
    'zh-TW': {
      appearanceTitle:'外觀檢查', tplSaving:'正在儲存預設版型…', tplSaved:'已儲存預設版型。', tplFail:'儲存失敗：', tplApplied:'已自動套用預設版型', login_msg_need:'請先登入'
    },
    'zh-CN': { appearanceTitle:'外观检查', tplSaving:'正在保存预设版型…', tplSaved:'已保存预设版型。', tplFail:'保存失败：', tplApplied:'已自动套用预设版型', login_msg_need:'请先登录' },
    'en':    { appearanceTitle:'Appearance Check', tplSaving:'Saving template…', tplSaved:'Template saved.', tplFail:'Save failed: ', tplApplied:'Template applied', login_msg_need:'Please login first' }
  };
  function t(k){ const lang = (localStorage.getItem('qci_lang')||'zh-TW'); return (I18N[lang]&&I18N[lang][k]) || (I18N['zh-TW'][k]||k); }

  // ------------- 登入/權限 -------------
  let AUTH = null;
  function setAuth(ok, info){ AUTH = ok ? info : null; }

  function headers(){
    const h = { 'Content-Type':'application/json' };
    if (!AUTH) return h;
    if (AUTH.mode === 'accounts'){ h['x-user']=AUTH.user||''; h['x-pass']=AUTH.pass||''; }
    if (AUTH.mode === 'passcode'){ h['x-user']=AUTH.user||''; h['x-passcode']=AUTH.passcode||''; }
    return h;
  }

  async function login(){
    const user = document.getElementById('login_user').value.trim();
    const pass = document.getElementById('login_pass').value.trim();
    const r = await fetch('/api/inspections?auth=1', { headers: { 'x-user':user, 'x-pass':pass, 'x-passcode':pass }});
    const j = await r.json().catch(()=>({}));
    if (j && j.ok){
      setAuth({ ok:true, user, pass, passcode:pass, mode:(j.mode||'accounts'), role:j.role||'input' });
      localStorage.setItem('qci_user', user);
      localStorage.setItem('qci_pass', pass);
      localStorage.setItem('qci_role', j.role||'input');
      showByRole(j.role||'input');
      await loadTemplates();
      ensureMeasurementTemplate();    // 保證外觀列一定存在
    }else{
      document.getElementById('loginMsg').textContent = '登入失敗';
    }
  }

  function showByRole(role){
    document.getElementById('loginCard').classList.add('hide');
    document.getElementById('formCard').classList.remove('hide');
    document.getElementById('measureCard').classList.remove('hide');
    // 任何進入表單畫面的時候都先確保外觀列存在（避免更新後沒顯示的情況）
    ensureMeasurementTemplate();
  }

  // ------------- 表格操作 -------------
  const tbody = document.getElementById('tbody');

  function ensureAppearanceRow(){
    let tr = tbody.querySelector('tr[data-type="appearance"]');
    if (!tr){
      tr = document.createElement('tr');
      tr.setAttribute('data-type','appearance');
      tr.innerHTML = `
        <td></td>
        <td><strong>${t('appearanceTitle')}</strong></td>
        <td colspan="3" class="muted">（可留空）</td>
        <td><select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select></td>
        <td><select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select></td>
        <td><select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select></td>
        <td><select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select></td>
        <td><select class="ap"><option value=""></option><option value="OK">OK</option><option value="NG">NG</option></select></td>
        <td class="dec"></td>`;
      tbody.appendChild(tr);
    }
  }

  function addMeasureRow(){
    const tr = document.createElement('tr');
    tr.setAttribute('data-type','measure');
    tr.innerHTML = `
      <td><input class="code"></td>
      <td><input class="name"></td>
      <td><input type="number" step="0.001" class="nom"></td>
      <td><input type="number" step="0.001" class="lo"></td>
      <td><input type="number" step="0.001" class="hi"></td>
      <td><input type="number" step="0.001" class="m"></td>
      <td><input type="number" step="0.001" class="m"></td>
      <td><input type="number" step="0.001" class="m"></td>
      <td><input type="number" step="0.001" class="m"></td>
      <td><input type="number" step="0.001" class="m"></td>
      <td class="dec"></td>`;
    tbody.appendChild(tr);
  }
  function countMeasureRows(){ return tbody.querySelectorAll('tr[data-type="measure"]').length; }
  function ensureMeasureRows(n){ while(countMeasureRows()<n) addMeasureRow(); }

  function clearMeasureRows(){ tbody.querySelectorAll('tr[data-type="measure"]').forEach(tr=>tr.remove()); }

  function updateDecisionForRow(tr){
    if (tr.getAttribute('data-type')!=='measure'){ return; } // 外觀列不計算
    const nom = Number(tr.querySelector('.nom')?.value || '');
    const lo  = Number(tr.querySelector('.lo')?.value || '');
    const hi  = Number(tr.querySelector('.hi')?.value || '');
    const ms  = [...tr.querySelectorAll('input.m')].map(i=>i.value).filter(v=>v!=='');
    if (!ms.length){ tr.querySelector('.dec').innerHTML=''; return; }
    const ok = ms.every(v => {
      const num = Number(v);
      if (Number.isNaN(num)) return false;
      let min = (nom||0) + (lo||0);
      let max = (nom||0) + (hi||0);
      return (num >= min && num <= max);
    });
    tr.querySelector('.dec').innerHTML = `<span class="tag ${ok?'pass':'fail'}">${ok?'PASS':'FAIL'}</span>`;
  }

  tbody.addEventListener('input', e => { const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });
  tbody.addEventListener('change', e => { const tr = e.target.closest('tr'); if (tr) updateDecisionForRow(tr); });

  // 初始外觀 + 至少 1 列尺寸
  function ensureMeasurementTemplate(){
    ensureAppearanceRow();
    if (countMeasureRows() === 0) ensureMeasureRows(1);
  }

  // ------------- 預設版型：儲存 / 載入 / 自動套用 -------------
  let TEMPLATES = [];

  async function loadTemplates(){
    try{
      const r = await fetch('/api/inspections?templates=1', { headers: headers() });
      const j = await r.json().catch(()=>({}));
      TEMPLATES = (j && j.ok && Array.isArray(j.templates)) ? j.templates : [];
    }catch{ TEMPLATES = []; }
  }

  function keyOf(obj){
    const fields = ['supplier','partNo','drawingNo','material','spec','category','process'];
    const out={}; fields.forEach(k=>{ const v=String(obj[k]||'').trim(); if (v) out[k]=v; });
    return out;
  }

  function scoreMatch(tplKey, currentKey){
    let s=0; const K = Object.keys(currentKey);
    for(const k of K){ if (tplKey[k] && String(tplKey[k]).toUpperCase() === String(currentKey[k]).toUpperCase()) s++; }
    return s;
  }

  function applyTemplate(tpl){
    if (!tpl) return;
    // 永遠先確保外觀列存在
    ensureAppearanceRow();

    // 後相容：舊模板（appearance[] + measurements[]）
    if (Array.isArray(tpl.appearance) || Array.isArray(tpl.measurements)){
      if (Array.isArray(tpl.appearance)){
        const sels = tbody.querySelectorAll('tr[data-type="appearance"] select.ap');
        tpl.appearance.forEach((a, i)=>{ const v = String(a&&a.result||'').toUpperCase(); if (sels[i]) sels[i].value = (v==='OK'||v==='O.K')?'OK':(v==='NG'?'NG':''); });
      }
      if (!tbody.querySelector('tr[data-type="measure"]')){
        clearMeasureRows();
        const defs = Array.isArray(tpl.measurements) ? tpl.measurements : [];
        ensureMeasureRows(defs.length || 1);
        const rows = tbody.querySelectorAll('tr[data-type="measure"]');
        defs.forEach((d, idx)=>{
          const tr = rows[idx] || rows[rows.length-1]; if (!tr) return;
          tr.querySelector('.code').value = d.code || '';
          tr.querySelector('.name').value = d.name || d.item || '';
          tr.querySelector('.nom').value  = (d.nominal ?? d.nom ?? '');
          tr.querySelector('.lo').value   = (d.tolMinus ?? d.lo ?? '');
          tr.querySelector('.hi').value   = (d.tolPlus  ?? d.hi ?? '');
          updateDecisionForRow(tr);
        });
      }
      return;
    }

    // 新模板（rows[]：含 appearance: true 或尺寸欄位）
    if (Array.isArray(tpl.rows)){
      clearMeasureRows();
      let measures = 0;
      for(const r of tpl.rows){
        if (r && r.appearance){ ensureAppearanceRow(); }
        else{
          addMeasureRow(); measures++;
          const tr = tbody.querySelector('tr[data-type="measure"]:last-child');
          if (tr){
            tr.querySelector('.code').value = r.code || '';
            tr.querySelector('.name').value = r.item || '';
            tr.querySelector('.nom').value  = r.nominal || '';
            tr.querySelector('.lo').value   = r.tolMinus || '';
            tr.querySelector('.hi').value   = r.tolPlus || '';
            updateDecisionForRow(tr);
          }
        }
      }
      if (measures===0) ensureMeasureRows(1);
    }
  }

  function tryAutoApply(){
    const current = {
      supplier: document.getElementById('supplier').value,
      partNo: document.getElementById('partNo').value,
      drawingNo: document.getElementById('drawingNo').value,
      material: document.getElementById('material').value,
      spec: document.getElementById('spec').value,
      category: document.getElementById('category').value,
      process: document.getElementById('process').value
    };
    const currentKey = keyOf(current);
    if (!Object.keys(currentKey).length) return;

    let best=null, bestScore=0;
    for (const t of TEMPLATES){
      const tk = t.key || keyOf(t);
      const s = scoreMatch(tk, currentKey);
      if (s > bestScore){ best=t; bestScore=s; }
    }
    if (best && bestScore >= 2){
      applyTemplate(best);
      showMsg(t('tplApplied'));
    }
  }

  function buildTemplateForSave(){
    const key = {
      supplier: document.getElementById('supplier').value,
      partNo: document.getElementById('partNo').value,
      drawingNo: document.getElementById('drawingNo').value,
      material: document.getElementById('material').value,
      spec: document.getElementById('spec').value,
      category: document.getElementById('category').value,
      process: document.getElementById('process').value
    };
    const tpl = { type:'template', key, rows: [] };
    // appearance row just marked
    if (tbody.querySelector('tr[data-type="appearance"]')) tpl.rows.push({ appearance:true });
    // dimension definitions
    tbody.querySelectorAll('tr[data-type="measure"]').forEach(tr => {
      const row = {
        code: tr.querySelector('.code')?.value || '',
        item: tr.querySelector('.name')?.value || '',
        nominal: tr.querySelector('.nom')?.value || '',
        tolMinus: tr.querySelector('.lo')?.value || '',
        tolPlus: tr.querySelector('.hi')?.value || ''
      };
      if (row.code || row.item || row.nominal || row.tolMinus || row.tolPlus){
        tpl.rows.push(row);
      }
    });
    return tpl;
  }

  async function saveTemplate(){
    if (!AUTH){ alert(t('login_msg_need')); return; }
    const btn = document.getElementById('btnSaveTpl');
    const msg = document.getElementById('msg');
    btn.disabled = true; if (msg) msg.textContent = t('tplSaving');
    try{
      const r = await fetch('/api/inspections?template=1', {
        method:'POST',
        headers: headers(),
        body: JSON.stringify({ template: buildTemplateForSave() })
      });
      const j = await r.json().catch(()=>({}));
      if (j && j.ok){
        if (msg) msg.textContent = t('tplSaved');
        await loadTemplates();
      }else{
        if (msg) msg.textContent = t('tplFail') + (j && j.error ? j.error : r.status);
      }
    }catch(e){
      if (msg) msg.textContent = t('tplFail') + (e.message || e);
    }finally{
      btn.disabled = false;
    }
  }

  // ------------- 收集與送出檢驗紀錄 -------------
  function collectRecord(){
    ensureAppearanceRow();
    const aps = [...tbody.querySelectorAll('tr[data-type="appearance"] select.ap')].map((sel,i)=>({ sample:'Sample '+(i+1), result: sel.value }));
    const ms  = [...tbody.querySelectorAll('tr[data-type="measure"]')].map(tr => ({
      code: tr.querySelector('.code')?.value || '',
      name: tr.querySelector('.name')?.value || '',
      nominal: tr.querySelector('.nom')?.value || '',
      tolMinus: tr.querySelector('.lo')?.value || '',
      tolPlus: tr.querySelector('.hi')?.value || '',
      measured: [...tr.querySelectorAll('input.m')].map(i => i.value===''? '' : Number(i.value)),
      pass: (tr.querySelector('.dec')?.textContent || '').trim() === 'PASS'
    }));
    return {
      supplier: document.getElementById('supplier').value,
      partNo: document.getElementById('partNo').value,
      drawingNo: document.getElementById('drawingNo').value,
      orderNo: document.getElementById('orderNo').value,
      lotNo: document.getElementById('lotNo').value,
      material: document.getElementById('material').value,
      spec: document.getElementById('spec').value,
      category: document.getElementById('category').value,
      process: document.getElementById('process').value,
      notes: document.getElementById('notes').value,
      appearance: aps,
      measurements: ms
    };
  }

  async function submitRecord(){
    if (!AUTH){ alert('請先登入'); return; }
    const msg = document.getElementById('msg');
    try{
      const r = await fetch('/api/inspections', { method:'POST', headers: headers(), body: JSON.stringify({ record: collectRecord() }) });
      const j = await r.json().catch(()=>({}));
      if (j && j.ok){ msg.textContent = '已送出'; }
      else{ msg.textContent = '送出失敗：' + (j && j.error ? j.error : r.status); }
    }catch(e){ msg.textContent = '送出失敗：' + (e.message||e); }
  }

  // ------------- 綁定 -------------
  document.getElementById('btnLogin').addEventListener('click', login);
  document.getElementById('btnSaveTpl').addEventListener('click', saveTemplate);
  document.getElementById('btnAdd').addEventListener('click', addMeasureRow);
  document.getElementById('btnRemove').addEventListener('click', ()=>{
    const rows = tbody.querySelectorAll('tr[data-type="measure"]'); if (rows.length) rows[rows.length-1].remove();
  });
  document.getElementById('btnClearRows').addEventListener('click', ()=>{ clearMeasureRows(); ensureMeasureRows(1); });
  document.getElementById('btnSubmit').addEventListener('click', submitRecord);

  // ------------- 自動載入（本地已登入） -------------
  (async function init(){
    try{
      const u = localStorage.getItem('qci_user') || '';
      const p = localStorage.getItem('qci_pass') || '';
      if (u && p){
        const r = await fetch('/api/inspections?auth=1', { headers: { 'x-user':u, 'x-pass':p, 'x-passcode':p } });
        const j = await r.json().catch(()=>({}));
        if (j && j.ok){
          setAuth({ ok:true, user:u, pass:p, passcode:p, mode:(j.mode||'accounts'), role:j.role||'input' });
          showByRole(j.role||'input');
          await loadTemplates();
          ensureMeasurementTemplate();
        }
      }
    }catch{}
  })();

  // 動態嘗試自動套用（在基本資料輸入時）
  ['supplier','partNo','drawingNo','material','spec','category','process'].forEach(id=>{
    const el = document.getElementById(id); if (!el) return;
    el.addEventListener('change', tryAutoApply);
    el.addEventListener('blur', tryAutoApply);
    el.addEventListener('input', ()=>{}); // 保持輕量，行動裝置上用 change/blur 較穩定
  });

  function showMsg(s){ const msg=document.getElementById('msg'); if(msg) msg.textContent=s; }
})();
</script>
</body>
</html>
