<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="title_print">å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸ï½œå“æª¢å ±å‘Šï¼ˆå–®ç­†ï¼‰</title>
  <style>
    :root { --gray:#6b7280; --line:#e5e7eb; --title:#111827; --muted:#374151; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#fff; color:#111; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px 16px 48px; }
    header { display:flex; align-items:flex-end; justify-content:space-between; border-bottom:2px solid #111; padding-bottom:12px; margin-bottom:16px; }
    .brand { font-size:22px; font-weight:700; letter-spacing:.05em; }
    .title { font-size:20px; font-weight:600; color:var(--title); }
    .muted { color: var(--gray); font-size: 13px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px; }
    .block { border:1px solid var(--line); border-radius:10px; padding:12px; }
    .block h3 { margin:0 0 8px 0; font-size:16px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid var(--line); padding:8px; text-align:left; vertical-align:top; }
    th { background:#f7f7f7; }
    .result { font-weight:700; }
    .pass { color:#116329; }
    .fail { color:#c02020; }
    .sign { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px; }
    .sign .cell { border:1px solid var(--line); border-radius:10px; padding:10px; height:80px; }
    .cell small { color:var(--gray); display:block; margin-bottom:6px; }
    @media print { .noprint { display:none; } .wrap { padding: 12px 0 0; } }

    /* èªè¨€é¸æ“‡è¦–çª— */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal .panel { background: #fff; border-radius: 14px; padding: 16px; width: 360px; box-shadow: 0 10px 25px rgba(0,0,0,.15); }
    .modal h3 { margin: 0 0 8px 0; }
    .lang-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
    .lang-btn { padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; background:#f9fafb; }
    .lang-btn:hover { background:#eef2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸<small style="display:block;color:#374151">ANCHOR FASTENERS INDUSTRIAL CO.,LTD.</small></div>
      <div class="title" data-i18n="title_print_inner">å“æª¢å ±å‘Š Inspection Report</div>
    </header>

    <div class="noprint" style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
      <button class="lang-btn" id="btnLang" title="Language / èªè¨€ / è¯­è¨€">ğŸŒ</button>
      <button class="lang-btn" id="btnPrint" data-i18n="btn_print">åˆ—å° / ä¸‹è¼‰ PDF</button>
      <a class="lang-btn" href="report.html" data-i18n="btn_back">è¿”å›å ±å‘Šåˆ—è¡¨</a>
      <span class="muted" id="tip"></span>
    </div>

    <!-- åŸºæœ¬è³‡è¨Š -->
    <div class="block">
      <h3 data-i18n="section_basic">åŸºæœ¬è³‡è¨Š</h3>
      <div class="row">
        <div><strong data-i18n="f_id">å ±å‘Šç·¨è™Ÿï¼š</strong><span id="f-id"></span></div>
        <div><strong data-i18n="f_time">æª¢é©—æ™‚é–“ï¼š</strong><span id="f-time"></span></div>
        <div><strong data-i18n="f_inspector">æª¢é©—äººå“¡ï¼š</strong><span id="f-inspector"></span></div>
        <div><strong data-i18n="f_overall">æª¢é©—çµæœï¼š</strong><span id="f-overall" class="result"></span></div>
      </div>
    </div>

    <!-- æ–™ä»¶è³‡è¨Šï¼ˆæ–°ç‰ˆæ¬„ä½é½Šå…¨ï¼‰ -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_part">æ–™ä»¶è³‡è¨Š</h3>
      <div class="row">
        <div><strong data-i18n="f_supplier">ä¾›æ‡‰å•†ï¼š</strong><span id="f-supplier"></span></div>
        <div><strong data-i18n="f_order">è¨‚å–®è™Ÿç¢¼ï¼š</strong><span id="f-order"></span></div>
        <div><strong data-i18n="f_lot">ç”Ÿç”¢æ‰¹è™Ÿï¼š</strong><span id="f-lot"></span></div>
        <div><strong data-i18n="f_partno">ç”¢å“æ–™è™Ÿï¼š</strong><span id="f-part"></span></div>
        <div><strong data-i18n="f_drawing">åœ–è™Ÿï¼š</strong><span id="f-draw"></span></div>
        <div><strong data-i18n="f_material">æè³ªï¼š</strong><span id="f-material"></span></div>
        <div><strong data-i18n="f_spec">è¦æ ¼ï¼š</strong><span id="f-spec"></span></div>
        <div><strong data-i18n="f_pt">ç”¢å“é¡åˆ¥ï¼š</strong><span id="f-pt"></span></div>
        <div><strong data-i18n="f_process">è£½ç¨‹ï¼š</strong><span id="f-process"></span></div>
      </div>
      <div style="margin-top:8px"><strong data-i18n="f_notes">å‚™è¨»ï¼š</strong><span id="f-notes"></span></div>
    </div>

    <!-- å¤–è§€èˆ‡é‡æ¸¬æ˜ç´° -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_unified">å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°</h3>
      <div id="unified"></div>
    </div>

    <!-- ç°½æ ¸å€ -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_sign">ç°½æ ¸</h3>
      <div class="sign">
        <div class="cell"><small data-i18n="sign_inspector">æª¢é©—äººå“¡</small><div id="sig-inspector"></div></div>
        <div class="cell"><small data-i18n="sign_qc">å“ä¿ä¸»ç®¡</small></div>
        <div class="cell"><small data-i18n="sign_approve">æ ¸å‡†</small></div>
      </div>
    </div>
  </div>

  <!-- èªè¨€é¸æ“‡è¦–çª— -->
  <div id="langModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3 data-i18n="lang_title">é¸æ“‡èªè¨€</h3>
      <p class="muted" data-i18n="lang_tip">è«‹é¸æ“‡é¡¯ç¤ºèªè¨€ï¼ˆä¹‹å¾Œå¯å†æ›´æ”¹ï¼‰ï¼š</p>
      <div class="lang-grid">
        <button class="lang-btn" data-lang="en">English</button>
        <button class="lang-btn" data-lang="zh-TW">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="zh-CN">ç®€ä½“ä¸­æ–‡</button>
      </div>
    </div>
  </div>

<script>
const I18N = {
  'zh-TW': {
    title_print: "å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸ï½œå“æª¢å ±å‘Šï¼ˆå–®ç­†ï¼‰",
    title_print_inner: "å“æª¢å ±å‘Š Inspection Report",
    btn_print: "åˆ—å° / ä¸‹è¼‰ PDF",
    btn_back: "è¿”å›å ±å‘Šåˆ—è¡¨",
    section_basic: "åŸºæœ¬è³‡è¨Š",
    section_part: "æ–™ä»¶è³‡è¨Š",
    section_unified: "å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°",
    section_sign: "ç°½æ ¸",
    sign_inspector: "æª¢é©—äººå“¡",
    sign_qc: "å“ä¿ä¸»ç®¡",
    sign_approve: "æ ¸å‡†",
    f_id: "å ±å‘Šç·¨è™Ÿï¼š", f_time: "æª¢é©—æ™‚é–“ï¼š", f_inspector: "æª¢é©—äººå“¡ï¼š", f_overall: "æª¢é©—çµæœï¼š",
    f_supplier: "ä¾›æ‡‰å•†ï¼š", f_order:"è¨‚å–®è™Ÿç¢¼ï¼š", f_lot:"ç”Ÿç”¢æ‰¹è™Ÿï¼š", f_partno: "ç”¢å“æ–™è™Ÿï¼š", f_drawing: "åœ–è™Ÿï¼š",
    f_material:"æè³ªï¼š", f_spec:"è¦æ ¼ï¼š", f_pt:"ç”¢å“é¡åˆ¥ï¼š", f_process: "è£½ç¨‹ï¼š", f_notes: "å‚™è¨»ï¼š",
    col_item: "é …ç›® / å°ºå¯¸", col_nominal: "åç›®", col_tol_minus: "ä¸‹é™å…¬å·®", col_tol_plus: "ä¸Šé™å…¬å·®",
    col_m1: "æ¨£å“/å¯¦æ¸¬1", col_m2: "æ¨£å“/å¯¦æ¸¬2", col_m3: "æ¨£å“/å¯¦æ¸¬3", col_m4: "æ¨£å“/å¯¦æ¸¬4", col_m5: "æ¨£å“/å¯¦æ¸¬5", col_judgement: "åˆ¤å®š",
    appearance: "å¤–è§€",
    lang_title: "é¸æ“‡èªè¨€", lang_tip: "è«‹é¸æ“‡é¡¯ç¤ºèªè¨€ï¼ˆä¹‹å¾Œå¯å†æ›´æ”¹ï¼‰ï¼š"
  },
  'zh-CN': {
    title_print: "å®‰æ‹“å®ä¸šæœ‰é™å…¬å¸ï½œå“æ£€æŠ¥å‘Šï¼ˆå•ç¬”ï¼‰",
    title_print_inner: "å“æ£€æŠ¥å‘Š Inspection Report",
    btn_print: "æ‰“å° / ä¸‹è½½ PDF",
    btn_back: "è¿”å›æŠ¥å‘Šåˆ—è¡¨",
    section_basic: "åŸºæœ¬ä¿¡æ¯",
    section_part: "æ–™ä»¶ä¿¡æ¯",
    section_unified: "å¤–è§‚ä¸é‡æµ‹æ˜ç»†",
    section_sign: "ç­¾æ ¸",
    sign_inspector: "æ£€éªŒäººå‘˜",
    sign_qc: "å“ä¿ä¸»ç®¡",
    sign_approve: "æ ¸å‡†",
    f_id: "æŠ¥å‘Šç¼–å·ï¼š", f_time: "æ£€éªŒæ—¶é—´ï¼š", f_inspector: "æ£€éªŒäººå‘˜ï¼š", f_overall: "æ£€éªŒç»“æœï¼š",
    f_supplier: "ä¾›åº”å•†ï¼š", f_order:"è®¢å•å·ç ï¼š", f_lot:"ç”Ÿäº§æ‰¹å·ï¼š", f_partno: "äº§å“æ–™å·ï¼š", f_drawing: "å›¾å·ï¼š",
    f_material:"æè´¨ï¼š", f_spec:"è§„æ ¼ï¼š", f_pt:"äº§å“ç±»åˆ«ï¼š", f_process: "åˆ¶ç¨‹ï¼š", f_notes: "å¤‡æ³¨ï¼š",
    col_item: "é¡¹ç›® / å°ºå¯¸", col_nominal: "åä¹‰", col_tol_minus: "ä¸‹é™å…¬å·®", col_tol_plus: "ä¸Šé™å…¬å·®",
    col_m1: "æ ·å“/å®æµ‹1", col_m2: "æ ·å“/å®æµ‹2", col_m3: "æ ·å“/å®æµ‹3", col_m4: "æ ·å“/å®æµ‹4", col_m5: "æ ·å“/å®æµ‹5", col_judgement: "åˆ¤å®š",
    appearance: "å¤–è§‚",
    lang_title: "é€‰æ‹©è¯­è¨€", lang_tip: "è¯·é€‰æ‹©æ˜¾ç¤ºè¯­è¨€ï¼ˆä¹‹åå¯å†æ›´æ”¹ï¼‰ï¼š"
  },
  'en': {
    title_print: "Anchor Co., Ltd. | Inspection Report (Single)",
    title_print_inner: "Inspection Report",
    btn_print: "Print / Download PDF",
    btn_back: "Back to list",
    section_basic: "Basic Info",
    section_part: "Part Info",
    section_unified: "Appearance & Measurements",
    section_sign: "Sign-off",
    sign_inspector: "Inspector",
    sign_qc: "QA Manager",
    sign_approve: "Approved",
    f_id: "Report ID: ", f_time: "Time: ", f_inspector: "Inspector: ", f_overall: "Overall: ",
    f_supplier: "Supplier: ", f_order:"Order No.: ", f_lot:"Lot No.: ", f_partno: "Part No.: ",
    f_drawing: "Drawing No.: ", f_material:"Material: ", f_spec:"Spec: ", f_pt:"Product Category: ", f_process: "Process: ", f_notes: "Notes: ",
    col_item: "Item / Dim.", col_nominal: "Nominal", col_tol_minus: "Lower Tol.", col_tol_plus: "Upper Tol.",
    col_m1: "Sample/Meas.1", col_m2: "Sample/Meas.2", col_m3: "Sample/Meas.3", col_m4: "Sample/Meas.4", col_m5: "Sample/Meas.5", col_judgement: "Judgement",
    appearance: "Appearance",
    lang_title: "Choose language", lang_tip: "Pick a display language (you can change it later):"
  }
};
function getLang(){ return localStorage.getItem('qci_lang') || 'zh-TW'; }
function setLang(x){ localStorage.setItem('qci_lang', x); applyI18n(); if (curr) document.getElementById('unified').innerHTML = buildUnifiedTable(curr.appearance||[], curr.measurements||[]); }
function t(key){ const d = I18N[getLang()] || I18N['zh-TW']; return d[key] || I18N['zh-TW'][key] || key; }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.getAttribute('data-i18n')));
  const titleEl = document.querySelector('title[data-i18n="title_print"]'); if (titleEl) titleEl.textContent = t('title_print');
}
document.getElementById('btnLang').addEventListener('click', ()=> document.getElementById('langModal').style.display='flex');
document.getElementById('langModal').addEventListener('click', (e)=>{ if (e.target.id==='langModal') document.getElementById('langModal').style.display='none'; });
document.querySelectorAll('#langModal .lang-btn').forEach(b=> b.addEventListener('click', ()=>{ setLang(b.getAttribute('data-lang')); document.getElementById('langModal').style.display='none'; }));

document.getElementById('btnPrint').addEventListener('click', ()=> window.print());

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
function num(v){ return (v===0||v) ? Number(v).toFixed(3) : ''; }

let curr = null;

function buildUnifiedTable(appearance, measurements){
  const th = `<thead><tr>
    <th>${t('col_item')}</th>
    <th>${t('col_nominal')}</th>
    <th>${t('col_tol_minus')}</th>
    <th>${t('col_tol_plus')}</th>
    <th>${t('col_m1')}</th>
    <th>${t('col_m2')}</th>
    <th>${t('col_m3')}</th>
    <th>${t('col_m4')}</th>
    <th>${t('col_m5')}</th>
    <th>${t('col_judgement')}</th>
  </tr></thead>`;

  const apMap = {};
  if (Array.isArray(appearance)){
    for (const a of appearance){
      const m = String(a.sample||'').match(/(\d+)/);
      const idx = m ? Number(m[1]) : null;
      if (idx && idx>=1 && idx<=5){
        apMap[idx] = String(a.result||'').toUpperCase().startsWith('OK') ? (getLang()==='en'?'OK':'O.K') : 'NG';
      }
    }
  }
  const apRow = Object.keys(apMap).length ? `
    <tr>
      <td><strong>${t('appearance')}</strong></td>
      <td></td><td></td><td></td>
      <td>${escapeHtml(apMap[1]||'')}</td>
      <td>${escapeHtml(apMap[2]||'')}</td>
      <td>${escapeHtml(apMap[3]||'')}</td>
      <td>${escapeHtml(apMap[4]||'')}</td>
      <td>${escapeHtml(apMap[5]||'')}</td>
      <td>${Object.values(apMap).every(v=>v==='OK'||v==='O.K')?'PASS':'FAIL'}</td>
    </tr>` : '';

  const rows = (Array.isArray(measurements)?measurements:[]).map(m=>{
    const arr = Array.isArray(m.measured) ? m.measured : ((m.measured===0||m.measured)?[m.measured]:[]);
    const vs = [0,1,2,3,4].map(i=> num(arr[i]));
    let dec='';
    if ((m.nominal===0||m.nominal) && (m.tolMinus===0||m.tolMinus) && (m.tolPlus===0||m.tolPlus) && arr.length){
      const min = Number(m.nominal)+Number(m.tolMinus), max = Number(m.nominal)+Number(m.tolPlus);
      const ok = arr.filter(v=>v===0||v).map(Number).every(v => v>=min && v<=max);
      dec = ok?'PASS':'FAIL';
    }
    return `<tr>
      <td>${escapeHtml(m.name||'')}</td>
      <td>${num(m.nominal)}</td><td>${num(m.tolMinus)}</td><td>${num(m.tolPlus)}</td>
      <td>${vs[0]}</td><td>${vs[1]}</td><td>${vs[2]}</td><td>${vs[3]}</td><td>${vs[4]}</td><td>${dec}</td>
    </tr>`;
  }).join('');

  return `<table>${th}<tbody>${apRow}${rows}</tbody></table>`;
}

async function load(){
  applyI18n();
  const params = new URLSearchParams(location.search);
  const id = params.get('id')||'';
  if (!id){ document.getElementById('tip').textContent = 'No id'; return; }
  try{
    const u = localStorage.getItem('qci_user')||'';
    const p = localStorage.getItem('qci_pass')||'';
    const res = await fetch('/api/inspections?id='+encodeURIComponent(id), { headers:{ 'x-user':u, 'x-pass':p, 'x-passcode':p } });
    const text = await res.text(); let r={}; try{ r=JSON.parse(text);}catch{}
    curr = r;
    // Basic
    document.getElementById('f-id').textContent = r.id||'';
    document.getElementById('f-time').textContent = r.timestamp||'';
    document.getElementById('f-inspector').textContent = r.inspector||'';
    document.getElementById('f-overall').textContent = (r.overall||'') ? r.overall : '';
    // Part info
    document.getElementById('f-supplier').textContent = r.supplier||'';
    document.getElementById('f-order').textContent = r.orderNo||'';
    document.getElementById('f-lot').textContent = r.lotNo||'';
    document.getElementById('f-part').textContent = r.partNo||'';
    document.getElementById('f-draw').textContent = r.drawingNo||'';
    document.getElementById('f-material').textContent = r.material||'';
    document.getElementById('f-spec').textContent = r.spec||'';
    document.getElementById('f-pt').textContent = r.productType||'';
    document.getElementById('f-process').textContent = r.process||'';
    document.getElementById('f-notes').textContent = r.notes||'';

    document.getElementById('unified').innerHTML = buildUnifiedTable(r.appearance||[], r.measurements||[]);
    document.getElementById('sig-inspector').textContent = r.inspector||'';
  }catch(e){
    document.getElementById('tip').textContent = 'Load failed: '+(e.message||e);
  }
}
load();
</script>
</body>
</html>
