<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title_print">å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸ï½œå“æª¢å ±å‘Šï¼ˆå–®ç­†ï¼‰</title>
  <style>
    :root { --gray:#6b7280; --line:#e5e7eb; --title:#111827; --muted:#374151; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#fff; color:#111; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px 16px 48px; }
    header { display:flex; align-items:flex-end; justify-content:space-between; border-bottom:2px solid #111; padding-bottom:12px; margin-bottom:16px; }
    .brand { font-size:22px; font-weight:700; letter-spacing:.05em; }
    .title { font-size:20px; font-weight:600; color:var(--title); }
    .muted { color: var(--gray); font-size: 13px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px; }
    .block { border:1px solid var(--line); border-radius:10px; padding:12px; }
    .block h3 { margin:0 0 8px 0; font-size:16px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid var(--line); padding:8px; text-align:left; vertical-align:top; }
    th { background:#f7f7f7; }
    .result { font-weight:700; }
    .pass { color:#116329; }
    .fail { color:#c02020; }
    .toolbar { display:flex; gap:8px; align-items:center; margin: 8px 0 12px; }
    .btn { padding:10px 14px; border:none; border-radius:10px; background:#2563eb; color:#fff; cursor:pointer; }
    .btn.outline { background:#f3f4f6; color:#111; }
    .sign { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px; }
    .sign .cell { border:1px solid var(--line); border-radius:10px; padding:10px; height:80px; }
    .cell small { color:var(--gray); display:block; margin-bottom:6px; }
    @media print { .noprint { display:none; } .wrap { padding: 12px 0 0; } }

    /* âœ… èªè¨€é¸æ“‡è¦–çª—ï¼ˆä¿®æ­£ï¼šè£œä¸Š .hiddenã€ä¿®æ­£é®ç½©é€æ˜åº¦å°æ•¸é»ï¼‰ */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal .panel { background: #fff; border-radius: 14px; padding: 16px; width: 360px; box-shadow: 0 10px 25px rgba(0,0,0,.15); }
    .modal h3 { margin: 0 0 8px 0; }
    .lang-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
    .lang-btn { padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; background:#f9fafb; }
    .lang-btn:hover { background:#eef2ff; }
    .hidden { display: none !important; } /* â† é€™è¡Œæ˜¯é—œéµï¼Œè®“ hideLangModal() ç”Ÿæ•ˆ */
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸</div>
      <div class="title" data-i18n="title_print_inner">å“æª¢å ±å‘Š Inspection Report</div>
    </header>

    <div class="toolbar noprint">
      <button class="btn" id="btnPrint" data-i18n="btn_print">åˆ—å° / ä¸‹è¼‰ PDF</button>
      <a class="btn outline" href="report.html" data-i18n="btn_back">è¿”å›å ±å‘Šåˆ—è¡¨</a>
      <button class="btn outline" id="btnLang" title="Language / èªè¨€ / è¯­è¨€">ğŸŒ</button>
      <span class="muted" id="tip"></span>
    </div>

    <!-- åŸºæœ¬è³‡è¨Š -->
    <div class="block">
      <h3 data-i18n="section_basic">åŸºæœ¬è³‡è¨Š</h3>
      <div class="row">
        <div><strong data-i18n="f_id">å ±å‘Šç·¨è™Ÿï¼š</strong><span id="f-id"></span></div>
        <div><strong data-i18n="f_time">æª¢é©—æ™‚é–“ï¼š</strong><span id="f-time"></span></div>
        <div><strong data-i18n="f_inspector">æª¢é©—äººå“¡ï¼š</strong><span id="f-inspector"></span></div>
        <div><strong data-i18n="f_overall">æª¢é©—çµæœï¼š</strong><span id="f-overall" class="result"></span></div>
      </div>
    </div>

    <!-- æ–™ä»¶è³‡è¨Š -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_part">æ–™ä»¶è³‡è¨Š</h3>
      <div class="row">
        <div><strong data-i18n="f_supplier">ä¾›æ‡‰å•†ï¼š</strong><span id="f-supplier"></span></div>
        <div><strong data-i18n="f_partno">æ–™è™Ÿ Part No.ï¼š</strong><span id="f-part"></span></div>
        <div><strong data-i18n="f_drawing">åœ–è™Ÿ Drawing No.ï¼š</strong><span id="f-draw"></span></div>
        <div><strong data-i18n="f_revision">ç‰ˆæ¬¡ Revisionï¼š</strong><span id="f-rev"></span></div>
      </div>
      <div style="margin-top:8px"><strong data-i18n="f_notes">å‚™è¨»ï¼š</strong><span id="f-notes"></span></div>
    </div>

    <!-- å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°ï¼ˆåˆä½µï¼›å¤–è§€æœ‰è³‡æ–™æ‰é¡¯ç¤ºï¼‰ -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_unified">å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°</h3>
      <div id="unified"></div>
    </div>

    <!-- ç°½æ ¸å€ -->
    <div class="block" style="margin-top:10px">
      <h3 data-i18n="section_sign">ç°½æ ¸</h3>
      <div class="sign">
        <div class="cell"><small data-i18n="sign_inspector">æª¢é©—äººå“¡</small></div>
        <div class="cell"><small data-i18n="sign_qc">å“ä¿ä¸»ç®¡</small></div>
        <div class="cell"><small data-i18n="sign_approve">æ ¸å‡†</small></div>
      </div>
    </div>
  </div>

  <!-- èªè¨€é¸æ“‡è¦–çª—ï¼ˆé è¨­éš±è—ï¼›æœªé¸éæ‰é¡¯ç¤ºï¼‰ -->
  <div id="langModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="panel">
      <h3 data-i18n="lang_title">é¸æ“‡èªè¨€</h3>
      <p class="muted" data-i18n="lang_tip">è«‹é¸æ“‡é¡¯ç¤ºèªè¨€ï¼ˆä¹‹å¾Œå¯å†æ›´æ”¹ï¼‰ï¼š</p>
      <div class="lang-grid">
        <button class="lang-btn" data-lang="en">English</button>
        <button class="lang-btn" data-lang="zh-Hant">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="zh-Hans">ç®€ä½“ä¸­æ–‡</button>
      </div>
    </div>
  </div>

  <script>
    /* ---- I18N ---- */
    const I18N = {
      "zh-Hant": {
        title_print: "å®‰æ‹“å¯¦æ¥­æœ‰é™å…¬å¸ï½œå“æª¢å ±å‘Šï¼ˆå–®ç­†ï¼‰",
        title_print_inner: "å“æª¢å ±å‘Š Inspection Report",
        btn_print: "åˆ—å° / ä¸‹è¼‰ PDF",
        btn_back: "è¿”å›å ±å‘Šåˆ—è¡¨",
        section_basic: "åŸºæœ¬è³‡è¨Š",
        section_part: "æ–™ä»¶è³‡è¨Š",
        section_unified: "å¤–è§€èˆ‡é‡æ¸¬æ˜ç´°",
        section_sign: "ç°½æ ¸",
        sign_inspector: "æª¢é©—äººå“¡",
        sign_qc: "å“ä¿ä¸»ç®¡",
        sign_approve: "æ ¸å‡†",

        f_id: "å ±å‘Šç·¨è™Ÿï¼š",
        f_time: "æª¢é©—æ™‚é–“ï¼š",
        f_inspector: "æª¢é©—äººå“¡ï¼š",
        f_overall: "æª¢é©—çµæœï¼š",
        f_supplier: "ä¾›æ‡‰å•†ï¼š",
        f_partno: "æ–™è™Ÿ Part No.ï¼š",
        f_drawing: "åœ–è™Ÿ Drawing No.ï¼š",
        f_revision: "ç‰ˆæ¬¡ Revisionï¼š",
        f_notes: "å‚™è¨»ï¼š",

        col_item: "é …ç›® / å°ºå¯¸",
        col_nominal: "åç›®",
        col_tol_minus: "ä¸‹é™å…¬å·®",
        col_tol_plus: "ä¸Šé™å…¬å·®",
        col_m1: "æ¨£å“/å¯¦æ¸¬1",
        col_m2: "æ¨£å“/å¯¦æ¸¬2",
        col_m3: "æ¨£å“/å¯¦æ¸¬3",
        col_m4: "æ¨£å“/å¯¦æ¸¬4",
        col_m5: "æ¨£å“/å¯¦æ¸¬5",
        col_judgement: "åˆ¤å®š",

        lang_title: "é¸æ“‡èªè¨€",
        lang_tip: "è«‹é¸æ“‡é¡¯ç¤ºèªè¨€ï¼ˆä¹‹å¾Œå¯å†æ›´æ”¹ï¼‰ï¼š"
      },
      "zh-Hans": {
        title_print: "å®‰æ‹“å®ä¸šæœ‰é™å…¬å¸ï½œå“æ£€æŠ¥å‘Šï¼ˆå•ç¬”ï¼‰",
        title_print_inner: "å“æ£€æŠ¥å‘Š Inspection Report",
        btn_print: "æ‰“å° / ä¸‹è½½ PDF",
        btn_back: "è¿”å›æŠ¥å‘Šåˆ—è¡¨",
        section_basic: "åŸºæœ¬ä¿¡æ¯",
        section_part: "æ–™ä»¶ä¿¡æ¯",
        section_unified: "å¤–è§‚ä¸é‡æµ‹æ˜ç»†",
        section_sign: "ç­¾æ ¸",
        sign_inspector: "æ£€éªŒäººå‘˜",
        sign_qc: "å“ä¿ä¸»ç®¡",
        sign_approve: "æ ¸å‡†",

        f_id: "æŠ¥å‘Šç¼–å·ï¼š",
        f_time: "æ£€éªŒæ—¶é—´ï¼š",
        f_inspector: "æ£€éªŒäººå‘˜ï¼š",
        f_overall: "æ£€éªŒç»“æœï¼š",
        f_supplier: "ä¾›åº”å•†ï¼š",
        f_partno: "æ–™å· Part No.ï¼š",
        f_drawing: "å›¾å· Drawing No.ï¼š",
        f_revision: "ç‰ˆæ¬¡ Revisionï¼š",
        f_notes: "å¤‡æ³¨ï¼š",

        col_item: "é¡¹ç›® / å°ºå¯¸",
        col_nominal: "åä¹‰",
        col_tol_minus: "ä¸‹é™å…¬å·®",
        col_tol_plus: "ä¸Šé™å…¬å·®",
        col_m1: "æ ·å“/å®æµ‹1",
        col_m2: "æ ·å“/å®æµ‹2",
        col_m3: "æ ·å“/å®æµ‹3",
        col_m4: "æ ·å“/å®æµ‹4",
        col_m5: "æ ·å“/å®æµ‹5",
        col_judgement: "åˆ¤å®š",

        lang_title: "é€‰æ‹©è¯­è¨€",
        lang_tip: "è¯·é€‰æ‹©æ˜¾ç¤ºè¯­è¨€ï¼ˆä¹‹åå¯å†æ›´æ”¹ï¼‰ï¼š"
      },
      "en": {
        title_print: "Antor Co., Ltd. | Inspection Report (Single)",
        title_print_inner: "Inspection Report",
        btn_print: "Print / Download PDF",
        btn_back: "Back to list",
        section_basic: "Basic Info",
        section_part: "Part Info",
        section_unified: "Appearance & Measurements",
        section_sign: "Sign-off",
        sign_inspector: "Inspector",
        sign_qc: "QA Manager",
        sign_approve: "Approved",

        f_id: "Report ID: ",
        f_time: "Time: ",
        f_inspector: "Inspector: ",
        f_overall: "Overall: ",
        f_supplier: "Supplier: ",
        f_partno: "Part No.: ",
        f_drawing: "Drawing No.: ",
        f_revision: "Revision: ",
        f_notes: "Notes: ",

        col_item: "Item / Dim.",
        col_nominal: "Nominal",
        col_tol_minus: "Lower Tol.",
        col_tol_plus: "Upper Tol.",
        col_m1: "Sample/Meas.1",
        col_m2: "Sample/Meas.2",
        col_m3: "Sample/Meas.3",
        col_m4: "Sample/Meas.4",
        col_m5: "Sample/Meas.5",
        col_judgement: "Judgement",

        lang_title: "Choose language",
        lang_tip: "Pick a display language (you can change it later):"
      }
    };

    function getLang(){ const s = localStorage.getItem('qci_lang'); return ['zh-Hant','zh-Hans','en'].includes(s) ? s : null; }
    function setLang(x){ localStorage.setItem('qci_lang', x); applyI18n(); }
    function t(key){ const lang = getLang() || 'zh-Hant'; const d = I18N[lang] || I18N['zh-Hant']; return d[key] || I18N['zh-Hant'][key] || key; }
    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.getAttribute('data-i18n')));
      const titleEl = document.querySelector('title[data-i18n="title_print"]'); if (titleEl) titleEl.textContent = t('title_print');
      // ä¾æœ€æ–°èªè¨€é‡å»ºæ˜ç´°è¡¨ï¼ˆcurr åœ¨è¼‰å…¥å¾Œæœƒæœ‰å€¼ï¼‰
      if (curr) document.getElementById('unified').innerHTML = buildUnifiedTable(curr.appearance || [], curr.measurements || []);
    }

    // èªè¨€è¦–çª—æ§åˆ¶
    const langModal = document.getElementById('langModal');
    function showLangModal(){ langModal.classList.remove('hidden'); }
    function hideLangModal(){ langModal.classList.add('hidden'); }
    document.getElementById('btnLang')?.addEventListener('click', showLangModal);
    langModal.querySelectorAll('.lang-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const lang = b.getAttribute('data-lang');
        setLang(lang);
        hideLangModal();           // âœ… é¸æ“‡å¾Œç«‹åˆ»é—œé–‰
      });
    });
    // é»èƒŒæ™¯é—œé–‰ï¼ˆé»å…§å±¤ panel ä¸é—œé–‰ï¼‰
    langModal.addEventListener('click', (e)=>{ if (e.target === langModal) hideLangModal(); });
    // Esc é—œé–‰
    window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') hideLangModal(); });

    function chooseLanguageIfNeeded(){
      if (getLang()) { applyI18n(); return Promise.resolve(); }
      applyI18n(); showLangModal(); // ç¬¬ä¸€æ¬¡æ²’é¸é â†’ é–‹çª—
      return new Promise(resolve=>{
        const onChange = () => { if (getLang()) { langModal.removeEventListener('click', onChange); resolve(); } };
        langModal.addEventListener('click', onChange);
      });
    }

    /* ---- å–®ç­†é åŸæœ¬é‚è¼¯ï¼ˆä¿ç•™ï¼‰ ---- */
    const tip = document.getElementById('tip');
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    const params = new URLSearchParams(location.search);
    const ID = params.get('id') || '';
    let curr = null;

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    async function ensureAuth() {
      let user = localStorage.getItem('qci_user') || localStorage.getItem('qci_inspector') || '';
      let pass = localStorage.getItem('qci_pass') || localStorage.getItem('qci_passcode') || '';
      if (!user || !pass) {
        user = prompt('Account / å¸³è™Ÿ / è´¦å·') || '';
        pass = prompt('Password / å¯†ç¢¼ / å¯†ç ') || '';
        if (!user || !pass) return { ok:false };
        localStorage.setItem('qci_user', user);
        localStorage.setItem('qci_pass', pass);
        localStorage.setItem('qci_inspector', user);
        localStorage.setItem('qci_passcode', pass);
      }
      try {
        const res = await fetch('/api/inspections?auth=1', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }});
        const t = await res.text(); let j={}; try{ j=JSON.parse(t);}catch{}
        if (!res.ok || !j.ok) return { ok:false };
        const role = (j.role||'').toLowerCase();
        if (!['admin','viewer'].includes(role)) return { ok:false };
        return { ok:true };
      } catch { return { ok:false }; }
    }

    async function loadRecord(){
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      const res = await fetch('/api/inspections', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }});
      const text = await res.text(); if (!res.ok) throw new Error(text||('HTTP '+res.status));
      let data={}; try{ data=JSON.parse(text);}catch{ data=text; }
      const list = listFromJson(data).filter(isValidRecord);
      const r = list.find(x => String(x.id||'') === String(ID));
      if (!r) throw new Error('Record not found');
      curr = r;

      // åŸºæœ¬è³‡è¨Š
      setText('f-id', r.id);
      setText('f-time', (r.timestamp||'').replace('T',' ').replace('Z',''));
      setText('f-inspector', r.inspector);
      const ov = String(r.overallResult||'').toUpperCase();
      const ovEl = document.getElementById('f-overall');
      ovEl.textContent = ov || '';
      ovEl.className = 'result ' + (ov === 'PASS' ? 'pass' : (ov === 'FAIL' ? 'fail' : ''));

      // æ–™ä»¶
      setText('f-supplier', r.supplier);
      setText('f-part', r.partNo);
      setText('f-draw', r.drawingNo);
      setText('f-rev', r.revision);
      setText('f-notes', r.notes);

      // æ˜ç´°è¡¨
      document.getElementById('unified').innerHTML = buildUnifiedTable(r.appearance||[], r.measurements||[]);
    }

    function setText(id, v){ const el=document.getElementById(id); if (el) el.textContent = v || ''; }

    // èˆ‡ report.html ç›¸åŒçš„ JSONBin çµæ§‹è™•ç†ï¼ˆç²¾ç°¡ç‰ˆï¼‰
    function listFromJson(data){
      // å¯èƒ½æ˜¯ {record:[...]} æˆ– [{record:{record:[...]}, metadata:{...}}] ç­‰åŒ…è£
      if (Array.isArray(data)) {
        // æ‰¾åˆ°æœ€æ·±ä¸€å±¤çš„ list
        if (data.length && data[0] && data[0].record && data[0].record.record) return data[0].record.record;
        return data;
      }
      if (data && data.record && Array.isArray(data.record)) return data.record;
      return [];
    }
    function isValidRecord(r){ return r && (r.id || r.timestamp || r.inspector || r.supplier || r.partNo); }

    function buildUnifiedTable(appearance, measurements){
      // appearance æ˜¯é™£åˆ—ï¼ˆé•·åº¦ 5 ä»¥å…§ï¼‰ï¼Œå…ƒç´ å¯èƒ½ç‚º '', 'O.K', 'NG'
      const hasAp = Array.isArray(appearance) && appearance.some(x => String(x||'').trim() !== '');
      const apRow = hasAp ? `
        <tr>
          <th>${t('appearance') || 'å¤–è§€'}</th>
          <td colspan="3"></td>
          ${[0,1,2,3,4].map(i => `<td>${escapeHtml(appearance[i]||'')}</td>`).join('')}
          <td></td>
        </tr>` : '';

      const rows = (Array.isArray(measurements)?measurements:[]).map(m=>{
        const name = m.name || '';
        const nom  = (m.nominal!=null? m.nominal : '');
        const lo   = (m.tolMinus!=null? m.tolMinus : '');
        const hi   = (m.tolPlus!=null? m.tolPlus : '');
        const m1=m.m1??m.measured1??m.measured?.[0]??'', m2=m.m2??m.measured2??m.measured?.[1]??'';
        const m3=m.m3??m.measured3??m.measured?.[2]??'', m4=m.m4??m.measured4??m.measured?.[3]??'';
        const m5=m.m5??m.measured5??m.measured?.[4]??'';
        const dec = m.decision || m.pass;
        const decTxt = typeof dec==='boolean' ? (dec?'PASS':'FAIL') : (dec||'');
        return `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td>${nom}</td>
            <td>${lo}</td>
            <td>${hi}</td>
            <td>${m1}</td>
            <td>${m2}</td>
            <td>${m3}</td>
            <td>${m4}</td>
            <td>${m5}</td>
            <td>${escapeHtml(decTxt)}</td>
          </tr>`;
      }).join('');

      if (!hasAp && !rows) return '<div class="muted">ï¼ˆç„¡æ˜ç´°ï¼‰</div>';

      return `
        <table class="mini">
          <thead>
            <tr>
              <th>${t('col_item')}</th>
              <th>${t('col_nominal')}</th>
              <th>${t('col_tol_minus')}</th>
              <th>${t('col_tol_plus')}</th>
              <th>${t('col_m1')}</th>
              <th>${t('col_m2')}</th>
              <th>${t('col_m3')}</th>
              <th>${t('col_m4')}</th>
              <th>${t('col_m5')}</th>
              <th>${t('col_judgement')}</th>
            </tr>
          </thead>
          <tbody>
            ${apRow}
            ${rows}
          </tbody>
        </table>`;
    }

    // å•Ÿå‹•æµç¨‹
    (async () => {
      applyI18n();
      await ensureAuth();
      await chooseLanguageIfNeeded(); // è‹¥æœªé¸éèªè¨€ï¼Œå…ˆé¸èªè¨€å†è¼‰è³‡æ–™
      try {
        await loadRecord();
      } catch(e) {
        document.getElementById('tip').textContent = 'âŒ ' + (e.message||e);
      }
    })();
  </script>
</body>
</html>
