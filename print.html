<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>單筆列印</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:18px; }
    .card { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; }
    th { background:#f7f7f7; }
    .noprint { display:block; }
    @media print { .noprint { display:none; } body { padding:0; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="noprint" style="text-align:right">
      <button onclick="window.print()">列印</button>
      <a href="report.html">返回列表</a>
    </div>
    <h1>安拓實業有限公司（ANCHOR FASTENERS INDUSTRIAL CO., LTD.）</h1>
    <h2 style="margin:4px 0 8px">品檢報告</h2>

    <table>
      <tbody id="basic"></tbody>
    </table>

    <div id="appearance"></div>
    <div id="measures"></div>

    <table>
      <thead><tr><th>簽核</th><th>姓名</th><th>備註</th></tr></thead>
      <tbody>
        <tr><td>檢驗人員</td><td id="sign-inspector"></td><td></td></tr>
        <tr><td>組長</td><td></td><td></td></tr>
        <tr><td>主管</td><td></td><td></td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const id = new URLSearchParams(location.search).get('id') || '';
    if (!id){ document.body.innerHTML = '<p>缺少 id</p>'; }

    function esc(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
    function num(v){ return (v===0 || v) ? Number(v).toFixed(3) : ''; }

    async function load(){
      const user = localStorage.getItem('qci_user') || '';
      const pass = localStorage.getItem('qci_pass') || '';
      const r = await fetch('/api/inspections', { headers: { 'x-user': user, 'x-pass': pass, 'x-passcode': pass }});
      const t = await r.text(); let data={}; try{ data=JSON.parse(t);}catch{ data=t; }
      const list = listFromJson(data);
      const rec = list.find(x => x.id===id);
      if (!rec){ document.body.innerHTML = '<p>找不到資料</p>'; return; }

      document.getElementById('sign-inspector').textContent = rec.inspector || '';

      // 基本
      document.getElementById('basic').innerHTML = `
        <tr><th style="width:22%">ID</th><td>${esc(rec.id||'')}</td></tr>
        <tr><th>時間</th><td>${esc(formatTime(rec.timestamp))}</td></tr>
        <tr><th>檢驗人員</th><td>${esc(rec.inspector||'')}</td></tr>
        <tr><th>供應商</th><td>${esc(rec.supplier||'')}</td></tr>
        <tr><th>製程</th><td>${esc(rec.processLabel || rec.process || '')}</td></tr>
        <tr><th>料號</th><td>${esc(rec.partNo||'')}</td></tr>
        <tr><th>圖號</th><td>${esc(rec.drawingNo||'')}</td></tr>
        <tr><th>備註</th><td>${esc(rec.notes||'')}</td></tr>
        <tr><th>總判定</th><td><strong>${rec.overallResult==='PASS'?'✅ PASS':'❌ FAIL'}</strong></td></tr>
      `;

      // 外觀（如果有）
      const ap = Array.isArray(rec.appearance) ? rec.appearance : [];
      if (ap.length){
        const rows = ap.map(a => \`<tr><td>\${esc(a.sample||'')}</td><td>\${esc(a.result||'')}</td></tr>\`).join('');
        document.getElementById('appearance').innerHTML = \`
          <table><thead><tr><th>外觀樣品</th><th>結果</th></tr></thead>
          <tbody>\${rows}</tbody></table>\`;
      }

      // 尺寸
      const rows = (rec.measurements||[]).map(m => {
        const arr = Array.isArray(m.measured) ? m.measured
                 : ((typeof m.measured === 'number') || (typeof m.measured === 'string' && m.measured!=='')) ? [m.measured] : [];
        const cells = [0,1,2,3,4].map(i => num(arr[i]));
        const judge = (m.pass===''? '' : (m.pass ? 'PASS' : 'FAIL'));
        return \`
          <tr>
            <td>\${esc(m.name||'')}</td><td>\${num(m.nominal)}</td><td>\${num(m.tolMinus)}</td><td>\${num(m.tolPlus)}</td>
            <td>\${cells[0]}</td><td>\${cells[1]}</td><td>\${cells[2]}</td><td>\${cells[3]}</td><td>\${cells[4]}</td>
            <td>\${judge}</td>
          </tr>\`;
      }).join('');
      document.getElementById('measures').innerHTML = \`
        <table>
          <thead>
            <tr>
              <th>尺寸</th><th>名目</th><th>下限公差</th><th>上限公差</th>
              <th>實測1</th><th>實測2</th><th>實測3</th><th>實測4</th><th>實測5</th><th>判定</th>
            </tr>
          </thead>
          <tbody>\${rows}</tbody>
        </table>\`;
    }

    function listFromJson(x){
      if (!x) return [];
      if (Array.isArray(x)) return x.flatMap(listFromJson).filter(Boolean);
      if (looksLikeRecord(x)) return [x];
      if (typeof x === 'object'){
        if (x.data) return listFromJson(x.data);
        if (x.record !== undefined) return listFromJson(x.record);
        if (x.records !== undefined) return listFromJson(x.records);
      }
      return [];
    }
    function looksLikeRecord(o){
      return o && typeof o==='object'
        && typeof o.id==='string'
        && typeof o.timestamp==='string'
        && Array.isArray(o.measurements);
    }
    function formatTime(iso){ if(!iso) return ''; try{ const d=new Date(iso); return d.toLocaleString(); }catch{ return iso; } }

    load();
  </script>
</body>
</html>
