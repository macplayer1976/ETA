// netlify/functions/inspections.js
exports.handler=async(e)=>{const n=process.env||{},t=n.JSONBIN_API_KEY,a=n.JSONBIN_BIN_ID,s=n.PASSCODE,i=c(n.ACCOUNTS_JSON),o=u(i,{INPUT_USERS_CSV:n.INPUT_USERS_CSV||"",INPUT_FIXED_PWD:n.INPUT_FIXED_PWD||"",VIEWER_USERS_CSV:n.VIEWER_USERS_CSV||"",VIEWER_FIXED_PWD:n.VIEWER_FIXED_PWD||""});if("OPTIONS"===e.httpMethod)return g(200,"OK");const r=e.queryStringParameters||{};if("GET"===e.httpMethod&&("1"===r.health||"true"===r.health))return d(200,{ok:!0,runtime:process.version,hasFetch:"function"==typeof fetch});if(!t||!a)return d(500,{error:"Missing env: JSONBIN_API_KEY / JSONBIN_BIN_ID"});const l=p(o,s,e.headers);if(!l.ok)return d(l.status||401,{ok:!1,error:l.error||"Unauthorized"});if("GET"===e.httpMethod&&("1"===r.auth||"true"===r.auth))return d(200,{ok:!0,mode:l.mode,role:l.role,user:l.user||""});if("GET"===e.httpMethod&&("1"===r.diag||"true"===r.diag)){if(!m(l.role,["admin","viewer"]))return d(403,{ok:!1,error:"Forbidden"});const e=await y(a,t);if(!e.ok)return d(e.status||500,{ok:!1,error:"JSONBIN GET failed",detail:e.text});const n=h(e.json),s=n.length?n[n.length-1]:null;return d(200,{ok:!0,count:n.length,last:s?{id:s.id,timestamp:s.timestamp,supplier:s.supplier,partNo:s.partNo,inspector:s.inspector,hasMeasurements:Array.isArray(s.measurements)}:null})}if("GET"===e.httpMethod&&("1"===r.repair||"true"===r.repair)){if(!m(l.role,["admin"]))return d(403,{ok:!1,error:"Forbidden"});const e=await y(a,t);if(!e.ok)return d(e.status||500,{ok:!1,error:"JSONBIN GET failed",detail:e.text});let n=h(e.json);n=f(n);const s=await b(a,t,n);return s.ok?d(200,{ok:!0,repaired:n.length}):d(s.status||500,{ok:!1,error:"JSONBIN PUT failed",detail:s.text})}if("GET"===e.httpMethod){if(!m(l.role,["admin","viewer"]))return d(403,{ok:!1,error:"Forbidden"});const e=await y(a,t);if(!e.ok)return d(e.status||500,{ok:!1,error:"JSONBIN GET failed",detail:e.text});const n=f(h(e.json));return d(200,n)}if("POST"===e.httpMethod){if(!m(l.role,["admin","input"]))return d(403,{ok:!1,error:"Forbidden"});let n={};try{n=JSON.parse(e.body||"{}")}catch{}const s=v(n,l.user);if(!s)return d(400,{ok:!1,error:"Bad payload"});const i=await y(a,t);if(!i.ok)return d(i.status||500,{ok:!1,error:"JSONBIN GET failed",detail:i.text});let o=f(h(i.json));o.push(s),o=f(o);const r=await b(a,t,o);return r.ok?d(200,{ok:!0,stored:1,id:s.id}):d(r.status||500,{ok:!1,error:"JSONBIN PUT failed",detail:r.text})}if("DELETE"===e.httpMethod){if(!("admin"===l.role&&"boss"===String(l.user).toLowerCase()))return d(403,{ok:!1,error:"Only boss (admin) can delete"});const e=(r.id||"").trim();if(!e)return d(400,{ok:!1,error:"Missing id"});const n=await y(a,t);if(!n.ok)return d(n.status||500,{ok:!1,error:"JSONBIN GET failed",detail:n.text});const s=f(h(n.json)),i=s.filter((n=>String(n.id||"")!==e)),o=await b(a,t,i);return o.ok?d(200,{ok:!0,deleted:i.length!==s.length?1:0,id:e}):d(o.status||500,{ok:!1,error:"JSONBIN PUT failed",detail:o.text})}return d(405,{ok:!1,error:"Method Not Allowed"});function w(){return{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type, x-passcode, x-user, x-pass","Access-Control-Allow-Methods":"GET, POST, DELETE, OPTIONS"}}function d(e,n){return{statusCode:e,headers:w(),body:JSON.stringify(n)}}function g(e,n){return{statusCode:e,headers:w(),body:n}}};function c(e){try{if(!e)return[];let n=String(e);/^base64:/i.test(n)&&(n=Buffer.from(n.slice(7),"base64").toString("utf8"));const t=JSON.parse(n);return Array.isArray(t)?t:[]}catch{return[]}}function u(e,n){const t=Array.isArray(e)?e:[],a=t.filter((e=>"admin"===(e.role||"").toLowerCase()));const s=e=>String(e||"").split(/[,ï¼Œ\n]/).map((e=>e.trim())).filter(Boolean),i=s(n.INPUT_USERS_CSV),o=s(n.VIEWER_USERS_CSV),r=String(n.INPUT_FIXED_PWD||""),l=String(n.VIEWER_FIXED_PWD||"");if(i.length&&r||o.length&&l){const e=[...a];for(const n of i)e.push({user:n,pwd:r,role:"input"});for(const n of o)e.push({user:n,pwd:l,role:"viewer"});const n=e=>`${(e.role||"").toLowerCase()}::${String(e.user||"")}`,t=new Set,a=[];for(const s of e){const e=n(s);t.has(e)||(t.add(e),a.push(s))}return a}return t}function p(e,n,t){const a=t||{},s=(a["x-user"]||a["X-User"]||"").trim(),i=(a["x-pass"]||a["X-Pass"]||"").trim(),o=(a["x-passcode"]||a["X-Passcode"]||"").trim();if(e&&e.length){const n=e.find((e=>String(e.user)===s&&String(e.pwd)===i));if(!n)return{ok:!1,status:401,error:"Unauthorized"};return{ok:!0,mode:"accounts",role:(n.role||"input").toLowerCase(),user:s}}return n&&o===n?{ok:!0,mode:"passcode",role:"admin",user:s||""}:{ok:!1,status:401,error:"Unauthorized"}}function m(e,n){return n.includes((e||"").toLowerCase())}async function y(e,n){try{const t=await fetch(`https://api.jsonbin.io/v3/b/${e}/latest`,{headers:{"X-Master-Key":n}}),a=await t.text();let s=null;try{s=JSON.parse(a)}catch{s=null}return{ok:t.ok,status:t.status,text:a,json:s}}catch(e){return{ok:!1,status:0,text:String(e)}}}async function b(e,n,t){try{const a=await fetch(`https://api.jsonbin.io/v3/b/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":n},body:JSON.stringify({record:t})}),s=await a.text();return{ok:a.ok,status:a.status,text:s}}catch(e){return{ok:!1,status:0,text:String(e)}}}function h(e){return Array.isArray(e)?e.length&&e[0]&&e[0].record&&e[0].record.record?e[0].record.record:e:e&&Array.isArray(e.record)?e.record:[]}function f(e){const n=[],t=new Set;for(const a of e){const e=String(a&&a.id||""),s=e||`${a.inspector||""}|${a.timestamp||""}|${a.partNo||""}`;t.has(s)||(t.add(s),n.push(a))}return n}function v(e,n){try{const t=(new Date).toISOString(),a=e.id&&String(e.id)||`INS-${t.replace(/\D/g,"").slice(0,14)}-${Math.floor(900*Math.random()+100)}`;return{id:a,timestamp:e.timestamp||t,inspector:e.inspector||n||"",supplier:e.supplier||"",partNo:e.partNo||"",drawingNo:e.drawingNo||"",revision:e.revision||"",process:e.process||"",notes:e.notes||"",appearance:Array.isArray(e.appearance)?e.appearance:[],measurements:Array.isArray(e.measurements)?e.measurements:[],overallResult:e.overallResult||""}}catch{return null}}
